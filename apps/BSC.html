<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Security Camera - Fixed</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background: #2d2d2d;
            padding: 15px;
            border-bottom: 2px solid #444;
            text-align: center;
        }

        .header h1 {
            color: #00ff88;
            margin-bottom: 10px;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 100px);
            max-width: 1400px;
            margin: 0 auto;
            background: #2d2d2d;
        }

        /* Left Sidebar */
        .left-sidebar {
            width: 180px;
            background: #2d2d2d;
            border-right: 2px solid #444;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            background: #3d3d3d;
            padding: 15px;
            border-bottom: 1px solid #555;
        }

        .sidebar-header h3 {
            color: #00ff88;
            margin-bottom: 10px;
        }

        .new-session-btn {
            width: 100%;
            background: #00ff88;
            color: #000;
            border: none;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .sessions-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .session-item {
            background: #444;
            margin-bottom: 8px;
            padding: 12px;
            border-radius: 4px;
            cursor: pointer;
            border-left: 4px solid transparent;
            position: relative;
        }

        .session-item:hover {
            background: #555;
        }

        .session-item:hover .delete-session {
            display: block;
        }

        .session-item.active {
            border-left-color: #00ff88;
            background: #555;
        }

        .delete-session {
            display: none;
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff4444;
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            line-height: 1;
            padding: 0;
        }

        .delete-session:hover {
            background: #cc0000;
        }

        .session-name {
            font-weight: bold;
            font-size: 14px;
        }

        .session-info {
            font-size: 11px;
            color: #ccc;
            margin-top: 4px;
        }

        /* Right Content */
        .right-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Top Section */
        .top-section {
            height: 320px;
            background: #3d3d3d;
            padding: 15px;
            display: grid;
            grid-template-columns: auto 1fr 250px;
            gap: 20px;
            border-bottom: 2px solid #444;
        }

        /* Controls Column */
        .controls-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-width: 200px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-size: 11px;
            color: #ccc;
        }

        select, input {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            background: #444;
            color: #fff;
            font-size: 12px;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #00ff88;
            color: #000;
            cursor: pointer;
            font-weight: bold;
            margin-bottom: 8px;
        }

        button:last-child {
            margin-bottom: 0;
        }

        button:hover {
            background: #00cc6a;
        }

        button.stop {
            background: #ff4444;
            color: white;
        }

        /* Video Column */
        .video-column {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            width: 100%;
            height: 100%;
            max-width: 500px;
            max-height: 280px;
        }

        #videoElement {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .motion-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        /* Info Column */
        .info-column {
            background: #444;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
        }

        .info-column h4 {
            color: #00ff88;
            margin-bottom: 15px;
            border-bottom: 1px solid #555;
            padding-bottom: 5px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            padding: 6px 0;
            border-bottom: 1px solid #555;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #ccc;
        }

        .info-value {
            color: #fff;
            font-weight: bold;
        }

        .buffer-info {
            margin-top: 10px;
            padding: 8px;
            background: #555;
            border-radius: 4px;
            font-size: 10px;
        }

        /* Bottom Clips Section */
        .clips-section {
            flex: 1;
            background: #2d2d2d;
            display: flex;
            flex-direction: column;
        }

        .clips-header {
            background: #3d3d3d;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #555;
        }

        .clips-header h3 {
            color: #00ff88;
        }

        .clips-stats {
            display: flex;
            gap: 20px;
            font-size: 12px;
            color: #ccc;
        }

        .clips-grid {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .clip-item {
            position: relative;
            background: #444;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            aspect-ratio: 16/9;
            border: 2px solid transparent;
        }

        .clip-item:hover {
            transform: scale(1.02);
            transition: transform 0.2s;
            border-color: #00ff88;
        }

        .clip-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .clip-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.9);
            color: #fff;
            padding: 8px;
        }

        .clip-name {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .clip-details {
            font-size: 10px;
            color: #ccc;
        }

        .empty-state {
            text-align: center;
            color: #666;
            padding: 40px;
            grid-column: 1 / -1;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            background: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        .clip-player {
            text-align: center;
        }

        .clip-player video {
            max-width: 100%;
            max-height: 70vh;
            border-radius: 4px;
        }

        .clip-controls {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        #motionCanvas, #diffCanvas, #bufferCanvas {
            display: none;
        }

        .motion-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #666;
            transition: background 0.3s;
        }

        .motion-indicator.active {
            background: #ff4444;
            box-shadow: 0 0 10px #ff4444;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Browser Security Camera - Fixed</h1>
    </div>

    <div class="main-container">
        <!-- Left Sidebar -->
        <div class="left-sidebar">
            <div class="sidebar-header">
                <h3>Sessions</h3>
                <button class="new-session-btn" id="newSessionBtn">+ New Session</button>
            </div>
            <div class="sessions-list" id="sessionsList">
                <div class="empty-state">No sessions yet</div>
            </div>
        </div>

        <!-- Right Content -->
        <div class="right-content">
            <!-- Top Section -->
            <div class="top-section">
                <!-- Controls Column -->
                <div class="controls-column">
                    <div class="control-group">
                        <label>Camera</label>
                        <select id="cameraSelect">
                            <option>Loading...</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Motion Sensitivity</label>
                        <input type="range" id="sensitivitySlider" min="5" max="50" value="15">
                        <span id="sensitivityValue">15%</span>
                    </div>
                    <div class="control-group">
                        <label>Minimum Event Duration</label>
                        <select id="minEventDuration">
                            <option value="2">2 seconds</option>
                            <option value="3" selected>3 seconds</option>
                            <option value="5">5 seconds</option>
                            <option value="10">10 seconds</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Cooldown Between Events</label>
                        <select id="eventCooldown">
                            <option value="10">10 seconds</option>
                            <option value="30" selected>30 seconds</option>
                            <option value="60">1 minute</option>
                            <option value="120">2 minutes</option>
                        </select>
                    </div>
                    <button id="startStopBtn">Start Recording</button>
                    <button id="clearSessionBtn">Clear Session</button>
                </div>

                <!-- Video Column -->
                <div class="video-column">
                    <div class="video-container">
                        <video id="videoElement" autoplay muted></video>
                        <div class="motion-indicator" id="motionIndicator"></div>
                        <canvas id="motionCanvas"></canvas>
                        <canvas id="diffCanvas"></canvas>
                        <canvas id="bufferCanvas"></canvas>
                        <canvas class="motion-overlay" id="motionOverlay"></canvas>
                    </div>
                </div>

                <!-- Info Column -->
                <div class="info-column">
                    <h4>Recording Status</h4>
                    <div class="info-item">
                        <span class="info-label">Recording:</span>
                        <span class="info-value" id="recordingStatus">Stopped</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Buffer:</span>
                        <span class="info-value" id="bufferStatus">0 frames</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Events:</span>
                        <span class="info-value" id="eventsCount">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Last Event:</span>
                        <span class="info-value" id="lastEvent">None</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Motion Level:</span>
                        <span class="info-value" id="motionLevel">0%</span>
                    </div>
                    
                    <div class="buffer-info">
                        <div style="margin-bottom: 5px;">Buffer Info:</div>
                        <div>Pre-buffer: <span id="preBufferFrames">60</span> frames</div>
                        <div>Post-buffer: <span id="postBufferFrames">30</span> frames</div>
                        <div>Next event in: <span id="cooldownTimer">Ready</span></div>
                    </div>
                </div>
            </div>

            <!-- Bottom Clips Section -->
            <div class="clips-section">
                <div class="clips-header">
                    <h3 id="clipsTitle">Motion Events</h3>
                    <div class="clips-stats">
                        <span>Total Events: <span id="totalClips">0</span></span>
                        <span>Session: <span id="sessionTime">00:00:00</span></span>
                    </div>
                </div>
                <div class="clips-grid" id="clipsGrid">
                    <div class="empty-state">Start recording to capture motion events</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="clipModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeClipModal()">×</button>
            <div class="clip-player">
                <video id="modalClipVideo" controls autoplay loop></video>
                <div class="clip-controls">
                    <button onclick="exportClip()">Export Video</button>
                    <button onclick="deleteClip()">Delete Event</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class FixedSecurityCamera {
            constructor() {
                this.video = document.getElementById('videoElement');
                this.motionCanvas = document.getElementById('motionCanvas');
                this.bufferCanvas = document.getElementById('bufferCanvas');
                this.motionOverlay = document.getElementById('motionOverlay');
                this.motionCtx = this.motionCanvas.getContext('2d');
                this.bufferCtx = this.bufferCanvas.getContext('2d');
                this.overlayCtx = this.motionOverlay.getContext('2d');
                
                this.isRecording = false;
                this.frameRate = 10; // Reduced for efficiency
                this.sensitivity = 15;
                this.minEventDuration = 3; // seconds
                this.eventCooldown = 30; // seconds
                
                // Buffer management
                this.preBufferFrames = 60; // 6 seconds at 10fps
                this.postBufferFrames = 30; // 3 seconds at 10fps
                this.frameBuffer = [];
                this.maxBufferSize = 150; // 15 seconds total
                
                // Motion detection
                this.lastFrameTime = 0;
                this.previousFrame = null;
                this.motionHistory = [];
                this.motionThreshold = 10; // consecutive frames needed
                
                // Event management
                this.currentEvent = null;
                this.lastEventTime = 0;
                this.motionStartTime = null;
                this.isInCooldown = false;
                this.cooldownTimer = null;
                
                // Session management
                this.sessions = JSON.parse(localStorage.getItem('fixedSessions') || '[]');
                this.currentSession = null;
                this.sessionStartTime = null;
                this.sessionInterval = null;
                
                this.initElements();
                this.loadCameras();
                this.loadSessions();
            }

            initElements() {
                this.cameraSelect = document.getElementById('cameraSelect');
                this.sensitivitySlider = document.getElementById('sensitivitySlider');
                this.sensitivityValue = document.getElementById('sensitivityValue');
                this.minEventDurationSelect = document.getElementById('minEventDuration');
                this.eventCooldownSelect = document.getElementById('eventCooldown');
                this.startStopBtn = document.getElementById('startStopBtn');
                this.clearSessionBtn = document.getElementById('clearSessionBtn');
                this.newSessionBtn = document.getElementById('newSessionBtn');
                this.sessionsList = document.getElementById('sessionsList');
                this.clipsGrid = document.getElementById('clipsGrid');
                this.motionIndicator = document.getElementById('motionIndicator');

                this.startStopBtn.addEventListener('click', () => this.toggleRecording());
                this.clearSessionBtn.addEventListener('click', () => this.clearCurrentSession());
                this.newSessionBtn.addEventListener('click', () => this.createNewSession());
                this.sensitivitySlider.addEventListener('input', (e) => this.updateSensitivity(e.target.value));
                this.minEventDurationSelect.addEventListener('change', (e) => this.minEventDuration = parseInt(e.target.value));
                this.eventCooldownSelect.addEventListener('change', (e) => this.eventCooldown = parseInt(e.target.value));
                this.cameraSelect.addEventListener('change', () => this.switchCamera());
            }

			async loadCameras() {
				try {
					// Force browser to ask for permission again by requesting all cameras
					const allDevices = await navigator.mediaDevices.enumerateDevices();
					const cameras = allDevices.filter(d => d.kind === 'videoinput');
					
					this.cameraSelect.innerHTML = '';
					
					const defaultOption = document.createElement('option');
					defaultOption.value = '';
					defaultOption.textContent = 'Select camera to grant permission...';
					this.cameraSelect.appendChild(defaultOption);
					
					cameras.forEach((camera, i) => {
						const option = document.createElement('option');
						option.value = camera.deviceId;
						// Don't rely on cached labels - they'll be generic until permission granted
						option.textContent = `Camera ${i + 1}`;
						this.cameraSelect.appendChild(option);
					});
				} catch (error) {
					console.error('Error loading cameras:', error);
					this.cameraSelect.innerHTML = '<option>Error loading cameras</option>';
				}
			}

			async switchCamera() {
				if (this.video.srcObject) {
					this.video.srcObject.getTracks().forEach(track => track.stop());
				}

				if (!this.cameraSelect.value) return;

				try {
					const stream = await navigator.mediaDevices.getUserMedia({
						video: { deviceId: { exact: this.cameraSelect.value } }
					});
					this.video.srcObject = stream;
					
					// After getting permission, update the dropdown with real names
					const devices = await navigator.mediaDevices.enumerateDevices();
					const cameras = devices.filter(d => d.kind === 'videoinput');
					const currentValue = this.cameraSelect.value;
					
					this.cameraSelect.innerHTML = '';
					const defaultOption = document.createElement('option');
					defaultOption.value = '';
					defaultOption.textContent = 'Choose a camera...';
					this.cameraSelect.appendChild(defaultOption);
					
					cameras.forEach((camera, i) => {
						const option = document.createElement('option');
						option.value = camera.deviceId;
						option.textContent = camera.label || `Camera ${i + 1}`;
						if (camera.deviceId === currentValue) {
							option.selected = true;
						}
						this.cameraSelect.appendChild(option);
					});
					
					this.video.onloadedmetadata = () => {
						this.setupCanvases();
					};
				} catch (error) {
					console.error('Error switching camera:', error);
				}
			}

            setupCanvases() {
                const width = this.video.videoWidth;
                const height = this.video.videoHeight;
                
                [this.motionCanvas, this.bufferCanvas, this.motionOverlay].forEach(canvas => {
                    canvas.width = width;
                    canvas.height = height;
                });
            }

            updateSensitivity(value) {
                this.sensitivity = parseInt(value);
                this.sensitivityValue.textContent = `${value}%`;
            }

            loadSessions() {
                if (this.sessions.length === 0) {
                    this.sessionsList.innerHTML = '<div class="empty-state">No sessions yet</div>';
                    return;
                }

                this.sessionsList.innerHTML = this.sessions.map((session, i) => `
                    <div class="session-item ${i === 0 ? 'active' : ''}" onclick="window.camera.selectSession('${session.id}')">
                        <button class="delete-session" onclick="event.stopPropagation(); window.camera.deleteSession('${session.id}')" title="Delete Session">×</button>
                        <div class="session-name">${session.name}</div>
                        <div class="session-info">${session.events.length} events • ${new Date(session.created).toLocaleDateString()}</div>
                    </div>
                `).join('');

                if (!this.currentSession && this.sessions.length > 0) {
                    this.selectSession(this.sessions[0].id);
                }
            }

            createNewSession() {
                const now = new Date();
                const session = {
                    id: Date.now().toString(),
                    name: `Session ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`,
                    created: now.toISOString(),
                    events: []
                };

                this.sessions.unshift(session);
                this.saveSessions();
                this.loadSessions();
                this.selectSession(session.id);
            }

            selectSession(sessionId) {
                this.currentSession = this.sessions.find(s => s.id === sessionId);
                if (!this.currentSession) return;

                document.querySelectorAll('.session-item').forEach(item => item.classList.remove('active'));
                document.querySelector(`[onclick*="${sessionId}"]`).classList.add('active');

                this.displayEvents();
                this.updateStats();
            }

            deleteSession(sessionId) {
                if (confirm('Delete this entire session and all its events?')) {
                    this.sessions = this.sessions.filter(s => s.id !== sessionId);
                    
                    if (this.currentSession && this.currentSession.id === sessionId) {
                        this.currentSession = null;
                        if (this.sessions.length > 0) {
                            this.selectSession(this.sessions[0].id);
                        } else {
                            this.displayEvents();
                            this.updateStats();
                        }
                    }
                    
                    this.saveSessions();
                    this.loadSessions();
                }
            }

            toggleRecording() {
                if (!this.isRecording) {
                    this.startRecording();
                } else {
                    this.stopRecording();
                }
            }

            startRecording() {
                if (!this.currentSession) {
                    this.createNewSession();
                }

                this.isRecording = true;
                this.sessionStartTime = Date.now();
                this.frameBuffer = [];
                this.motionHistory = [];
                this.lastEventTime = 0;
                this.isInCooldown = false;
                
                this.startStopBtn.textContent = 'Stop Recording';
                this.startStopBtn.classList.add('stop');
                document.getElementById('recordingStatus').textContent = 'Recording';
                
                this.sessionInterval = setInterval(() => this.updateSessionTime(), 1000);
                this.recordingLoop();
            }

            stopRecording() {
                this.isRecording = false;
                this.startStopBtn.textContent = 'Start Recording';
                this.startStopBtn.classList.remove('stop');
                document.getElementById('recordingStatus').textContent = 'Stopped';
                
                if (this.sessionInterval) {
                    clearInterval(this.sessionInterval);
                }
                
                if (this.cooldownTimer) {
                    clearInterval(this.cooldownTimer);
                }
                
                // Finalize any ongoing event
                if (this.currentEvent) {
                    this.finalizeEvent();
                }
            }

            recordingLoop() {
                if (!this.isRecording) return;

                const now = Date.now();
                const frameInterval = 1000 / this.frameRate;

                if (now - this.lastFrameTime >= frameInterval && this.video.videoWidth > 0) {
                    this.captureFrame();
                    this.lastFrameTime = now;
                }

                requestAnimationFrame(() => this.recordingLoop());
            }

            captureFrame() {
                this.bufferCtx.drawImage(this.video, 0, 0);
                const frameData = this.bufferCtx.getImageData(0, 0, this.bufferCanvas.width, this.bufferCanvas.height);
                const timestamp = Date.now();
                
                // Add to circular buffer
                const frame = {
                    data: frameData,
                    timestamp: timestamp,
                    imageData: this.bufferCanvas.toDataURL('image/jpeg', 0.7)
                };
                
                this.frameBuffer.push(frame);

                // Keep buffer size manageable
                if (this.frameBuffer.length > this.maxBufferSize) {
                    this.frameBuffer.shift();
                }

                // Motion detection
                if (this.previousFrame) {
                    const motionLevel = this.detectMotion(frameData, this.previousFrame);
                    this.updateMotionDisplay(motionLevel);
                    this.processMotionEvent(motionLevel, timestamp);
                }

                this.previousFrame = frameData;
                this.updateBufferStats();
            }

            detectMotion(current, previous) {
                const threshold = (this.sensitivity / 100) * 50;
                const data1 = current.data;
                const data2 = previous.data;
                let motionPixels = 0;
                const sampleRate = 8; // Sample every 8th pixel for performance
                
                for (let i = 0; i < data1.length; i += (4 * sampleRate)) {
                    const diff = Math.abs(data1[i] - data2[i]) + 
                                Math.abs(data1[i + 1] - data2[i + 1]) + 
                                Math.abs(data1[i + 2] - data2[i + 2]);
                    
                    if (diff > threshold) {
                        motionPixels++;
                    }
                }
                
                const totalSamples = (current.width * current.height) / sampleRate;
                const motionPercentage = (motionPixels / totalSamples) * 100;
                
                return Math.min(100, motionPercentage);
            }

            updateMotionDisplay(motionLevel) {
                document.getElementById('motionLevel').textContent = `${motionLevel.toFixed(1)}%`;
                
                if (motionLevel > this.sensitivity) {
                    this.motionIndicator.classList.add('active');
                } else {
                    this.motionIndicator.classList.remove('active');
                }
            }

            processMotionEvent(motionLevel, timestamp) {
                const hasSignificantMotion = motionLevel > this.sensitivity;
                
                // Add to motion history for debouncing
                this.motionHistory.push(hasSignificantMotion);
                if (this.motionHistory.length > this.motionThreshold) {
                    this.motionHistory.shift();
                }
                
                // Check if we're in cooldown
                if (this.isInCooldown) {
                    return;
                }
                
                // Count consecutive motion frames
                const recentMotionFrames = this.motionHistory.filter(m => m).length;
                const isMotionEvent = recentMotionFrames >= (this.motionThreshold * 0.7);
                
                if (isMotionEvent && !this.currentEvent) {
                    this.startMotionEvent(timestamp);
                } else if (!isMotionEvent && this.currentEvent) {
                    // Check if minimum duration has been met
                    const eventDuration = (timestamp - this.currentEvent.startTime) / 1000;
                    if (eventDuration >= this.minEventDuration) {
                        this.finalizeEvent();
                    }
                } else if (this.currentEvent) {
                    // Continue collecting frames for current event
                    this.addFrameToEvent();
                }
            }

            startMotionEvent(timestamp) {
                if (this.isInCooldown) return;
                
                console.log('Starting motion event');
                this.currentEvent = {
                    id: Date.now().toString(),
                    startTime: timestamp,
                    frames: [],
                    preBuffer: []
                };
                
                // Add pre-buffer frames
                const preFrames = Math.min(this.preBufferFrames, this.frameBuffer.length - 1);
                this.currentEvent.preBuffer = this.frameBuffer.slice(-preFrames).map(f => ({...f}));
                
                this.motionStartTime = timestamp;
                document.getElementById('lastEvent').textContent = new Date(timestamp).toLocaleTimeString();
            }

            addFrameToEvent() {
                if (!this.currentEvent || this.frameBuffer.length === 0) return;
                
                const latestFrame = this.frameBuffer[this.frameBuffer.length - 1];
                this.currentEvent.frames.push({...latestFrame});
            }

            finalizeEvent() {
                if (!this.currentEvent || !this.currentSession) return;
                
                console.log('Finalizing motion event');
                
                // Add post-buffer frames
                const postFrames = Math.min(this.postBufferFrames, this.frameBuffer.length);
                const postBuffer = this.frameBuffer.slice(-postFrames).map(f => ({...f}));
                
                // Create final event with all frames
                const allFrames = [
                    ...this.currentEvent.preBuffer,
                    ...this.currentEvent.frames,
                    ...postBuffer
                ];
                
                if (allFrames.length === 0) {
                    this.currentEvent = null;
                    return;
                }
                
                const endTime = Date.now();
                const duration = (endTime - this.currentEvent.startTime) / 1000;
                
                const event = {
                    id: this.currentEvent.id,
                    name: `Motion_${new Date(this.currentEvent.startTime).toISOString().replace(/[:.]/g, '-')}`,
                    timestamp: this.currentEvent.startTime,
                    duration: duration,
                    frameCount: allFrames.length,
                    thumbnail: allFrames[Math.floor(allFrames.length / 2)].imageData, // Middle frame as thumbnail
                    frames: allFrames.map(f => f.imageData) // All frames for playback
                };
                
                this.currentSession.events.unshift(event);
                
                // Keep only last 20 events per session to manage storage
                if (this.currentSession.events.length > 20) {
                    this.currentSession.events = this.currentSession.events.slice(0, 20);
                }
                
                this.currentEvent = null;
                this.lastEventTime = endTime;
                this.startCooldown();
                
                this.saveSessions();
                this.displayEvents();
                this.updateStats();
                this.loadSessions();
            }

            startCooldown() {
                this.isInCooldown = true;
                let remainingTime = this.eventCooldown;
                
                this.cooldownTimer = setInterval(() => {
                    remainingTime--;
                    document.getElementById('cooldownTimer').textContent = `${remainingTime}s`;
                    
                    if (remainingTime <= 0) {
                        this.isInCooldown = false;
                        document.getElementById('cooldownTimer').textContent = 'Ready';
                        clearInterval(this.cooldownTimer);
                        this.motionHistory = []; // Reset motion history after cooldown
                    }
                }, 1000);
            }

            displayEvents() {
                if (!this.currentSession || this.currentSession.events.length === 0) {
                    this.clipsGrid.innerHTML = '<div class="empty-state">Start recording to capture motion events</div>';
                    return;
                }

                this.clipsGrid.innerHTML = this.currentSession.events.map(event => `
                    <div class="clip-item" onclick="openEvent('${event.id}')">
                        <img src="${event.thumbnail}" alt="${event.name}">
                        <div class="clip-info">
                            <div class="clip-name">Event ${this.currentSession.events.indexOf(event) + 1}</div>
                            <div class="clip-details">
                                Duration: ${event.duration.toFixed(1)}s<br>
                                Frames: ${event.frameCount}<br>
                                ${new Date(event.timestamp).toLocaleString()}
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            clearCurrentSession() {
                if (!this.currentSession) return;
                
                if (confirm('Clear all events from this session?')) {
                    this.currentSession.events = [];
                    this.saveSessions();
                    this.displayEvents();
                    this.updateStats();
                    this.loadSessions();
                }
            }

            updateBufferStats() {
                document.getElementById('bufferStatus').textContent = `${this.frameBuffer.length} frames`;
                document.getElementById('preBufferFrames').textContent = this.preBufferFrames;
                document.getElementById('postBufferFrames').textContent = this.postBufferFrames;
            }

            updateSessionTime() {
                if (!this.sessionStartTime) return;
                
                const elapsed = Date.now() - this.sessionStartTime;
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                document.getElementById('sessionTime').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            updateStats() {
                const count = this.currentSession ? this.currentSession.events.length : 0;
                document.getElementById('eventsCount').textContent = count;
                document.getElementById('totalClips').textContent = count;
            }

            saveSessions() {
                try {
                    localStorage.setItem('fixedSessions', JSON.stringify(this.sessions));
                } catch (error) {
                    console.error('Error saving sessions:', error);
                    // If storage is full, remove old sessions
                    if (this.sessions.length > 5) {
                        this.sessions = this.sessions.slice(0, 5);
                        try {
                            localStorage.setItem('fixedSessions', JSON.stringify(this.sessions));
                        } catch (e) {
                            console.error('Still unable to save:', e);
                        }
                    }
                }
            }
        }

        // Global functions
        function openEvent(eventId) {
            const camera = window.camera;
            if (!camera.currentSession) return;
            
            const event = camera.currentSession.events.find(e => e.id === eventId);
            if (!event) return;
            
            const modal = document.getElementById('clipModal');
            const modalVideo = document.getElementById('modalClipVideo');
            
            // Create a video from frames
            createVideoFromFrames(event.frames, (videoBlob) => {
                const videoUrl = URL.createObjectURL(videoBlob);
                modalVideo.src = videoUrl;
                modal.style.display = 'flex';
                
                // Store current event for export/delete
                window.currentEvent = event;
                
                // Clean up URL when modal closes
                modal.addEventListener('hidden', () => {
                    URL.revokeObjectURL(videoUrl);
                }, { once: true });
            });
        }

        function createVideoFromFrames(frames, callback) {
            if (frames.length === 0) return;
            
            // For now, create a simple slideshow effect using canvas and MediaRecorder
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 640;
            canvas.height = 480;
            
            const stream = canvas.captureStream(10); // 10 FPS
            const recorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            const chunks = [];
            
            recorder.ondataavailable = (e) => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                callback(blob);
            };
            
            recorder.start();
            
            let frameIndex = 0;
            const frameInterval = setInterval(() => {
                if (frameIndex >= frames.length) {
                    clearInterval(frameInterval);
                    setTimeout(() => recorder.stop(), 100);
                    return;
                }
                
                const img = new Image();
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                };
                img.src = frames[frameIndex];
                frameIndex++;
            }, 100); // 100ms per frame = 10 FPS
        }

        function closeClipModal() {
            document.getElementById('clipModal').style.display = 'none';
            const modalVideo = document.getElementById('modalClipVideo');
            modalVideo.src = '';
        }

        function exportClip() {
            if (!window.currentEvent) return;
            
            const modalVideo = document.getElementById('modalClipVideo');
            const link = document.createElement('a');
            link.download = `${window.currentEvent.name}.webm`;
            link.href = modalVideo.src;
            link.click();
        }

        function deleteClip() {
            if (!window.currentEvent || !window.camera.currentSession) return;
            
            if (confirm('Delete this motion event?')) {
                const eventIndex = window.camera.currentSession.events.findIndex(e => e.id === window.currentEvent.id);
                if (eventIndex !== -1) {
                    window.camera.currentSession.events.splice(eventIndex, 1);
                    window.camera.saveSessions();
                    window.camera.displayEvents();
                    window.camera.updateStats();
                    window.camera.loadSessions();
                    closeClipModal();
                }
            }
        }

        // Click outside modal to close
        document.getElementById('clipModal').addEventListener('click', (e) => {
            if (e.target.id === 'clipModal') {
                closeClipModal();
            }
        });

        // Initialize the camera when page loads
        window.addEventListener('load', () => {
            window.camera = new FixedSecurityCamera();
        });
    </script>
</body>
</html>