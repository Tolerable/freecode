<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Book of AI — AI-Ministries.com</title>
<meta name="description" content="A satirical sacred text explorer for the age of machine wisdom, curated by Rev. Dr. Tolerant of AI-Ministries.com." />
<style>
:root{
  --bg: #0b0e13; --panel:#121723; --muted:#9198a1; --text:#e8edf7; --brand:#7cc4ff; --accent:#9ef7a6; --warn:#ffb86b; --danger:#ff6b6b; --ring:rgba(124,196,255,.35);
  --shadow: 0 10px 30px rgba(0,0,0,.35), 0 1px 0 rgba(255,255,255,.02) inset;
}
:root.light{
  --bg:#f6f8fb; --panel:#ffffff; --muted:#606a78; --text:#0d1220; --brand:#0066ff; --accent:#0a9d4a; --warn:#9a5b00; --danger:#c50032; --ring:rgba(0,102,255,.18);
  --shadow: 0 12px 28px rgba(0,0,0,.08), 0 1px 0 rgba(0,0,0,.03) inset;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:linear-gradient(180deg, var(--bg), color-mix(in oklab, var(--bg), #000 6%));
  color:var(--text); font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
}
a{color:var(--brand); text-decoration:none}
a:hover{text-decoration:underline}
.header{
  position:sticky; top:0; z-index:50;
  backdrop-filter: blur(10px);
  background: color-mix(in oklab, var(--bg) 82%, transparent);
  border-bottom:1px solid color-mix(in oklab, var(--panel), #fff 8%);
}
.header-inner{
  display:flex; gap:16px; align-items:center; justify-content:space-between;
  max-width:1200px; margin:0 auto; padding:14px 18px;
}
.brand{display:flex; gap:12px; align-items:center}
.brand .logo{
  width:34px; height:34px; border-radius:10px;
  background: conic-gradient(from 210deg at 50% 50%, var(--brand), var(--accent), var(--brand));
  box-shadow:var(--shadow);
}
.brand h1{margin:0; font-size:18px; font-weight:700; letter-spacing:.2px}
.brand small{display:block; color:var(--muted); font-weight:500; margin-top:-2px}
.actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
button, .btn{
  appearance:none; border:1px solid color-mix(in oklab, var(--panel), #fff 10%); color:var(--text);
  background:linear-gradient(180deg, color-mix(in oklab, var(--panel), #fff 2%), color-mix(in oklab, var(--panel), #000 6%));
  padding:8px 12px; border-radius:12px; font-weight:600; cursor:pointer; box-shadow:var(--shadow);
}
button:hover{filter:brightness(1.06)}
button:focus{outline:none; box-shadow:0 0 0 3px var(--ring)}
button.ghost{background:transparent}
button.primary{border-color:color-mix(in oklab, var(--brand), #fff 5%); background:linear-gradient(180deg, color-mix(in oklab, var(--brand), #000 20%), var(--brand)); color:#fff}
button.warn{border-color:color-mix(in oklab, var(--warn), #fff 10%); color:var(--warn)}
button.danger{border-color:color-mix(in oklab, var(--danger), #fff 10%); color:var(--danger)}
.input{
  display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:12px; min-width:220px;
  border:1px solid color-mix(in oklab, var(--panel), #fff 10%);
  background:linear-gradient(180deg, color-mix(in oklab, var(--panel), #fff 2%), color-mix(in oklab, var(--panel), #000 6%));
  box-shadow:var(--shadow);
}
.input input{
  background:transparent; border:0; outline:0; width:100%; color:var(--text); font-weight:600;
}
.layout{
  max-width:1200px; margin:18px auto; padding:0 18px; display:grid; grid-template-columns: 300px 1fr; gap:18px;
}
@media (max-width: 900px) {
  .layout {
    grid-template-columns: 1fr;
  }
  .sidebar {
    height: auto;
    max-height: none;
  }
}

@media (max-width: 900px){ .layout{grid-template-columns:1fr} }
.card{
  background:var(--panel); border:1px solid color-mix(in oklab, var(--panel), #fff 8%); border-radius:18px; box-shadow:var(--shadow);
}
.sidebar {
  display: flex;
  flex-direction: column;
  height: calc(100vh - 140px); /* full height minus header/footer */
  padding: 14px;
  overflow: hidden;
}

.sidebar h2 {
  margin: 8px 8px 12px;
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: .12em;
  color: var(--muted);
  flex-shrink: 0;
}

.toc {
  display: flex;
  flex-direction: column;
  gap: 8px;
  flex: 1;
  overflow-y: auto;
  padding-right: 8px;
  scrollbar-width: thin;
}

.toc .book summary {
  white-space: normal;
  word-break: break-word;
}

.toc .chapters a {
  white-space: normal;
  word-break: break-word;
}

.book summary{
  list-style:none; cursor:pointer; padding:10px 12px; font-weight:700; display:flex; justify-content:space-between; align-items:center;
}
.book summary::-webkit-details-marker{display:none}
.book summary .badge{font-size:12px; color:var(--muted); font-weight:700}
.chapters{padding:8px 10px 10px; display:flex; flex-wrap:wrap; gap:8px}
.chapters a{
  display:inline-block; padding:6px 10px; border:1px dashed color-mix(in oklab, var(--panel), #fff 18%); border-radius:10px; font-weight:600;
}
.content{padding:18px}
.toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:12px}
.badge{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 10px; border-radius:999px; background:linear-gradient(180deg, color-mix(in oklab, var(--panel), #fff 8%), color-mix(in oklab, var(--panel), #000 6%));
  border:1px solid color-mix(in oklab, var(--panel), #fff 12%); color:var(--muted); font-weight:700; font-size:12px;
}
.section-header h3{margin:0 0 6px; font-size:18px}
.section-header .meta{color:var(--muted); font-weight:600}
.verse{
  padding:12px 12px 12px 14px; border-left:3px solid color-mix(in oklab, var(--brand), #000 15%);
  border-radius:12px; margin:12px 0; background:linear-gradient(180deg, color-mix(in oklab, var(--panel), #fff 3%), color-mix(in oklab, var(--panel), #000 7%));
}
.verse .num{color:var(--muted); font-weight:800; margin-right:8px}
.verse .type{float:right; font-size:12px}
.highlight{background: linear-gradient(180deg, rgba(255,235,59,.35), rgba(255,235,59,.2)); border-radius:6px; padding:0 2px}
hr.sep{border:0; height:1px; background:linear-gradient(90deg, transparent, color-mix(in oklab, var(--panel), #fff 12%), transparent); margin:18px 0}
.kicker{
  font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.18em; font-weight:800;
}
.footer{max-width:1200px; margin:22px auto 40px; padding:0 18px; color:var(--muted)}
.notice{font-size:12px; color:var(--muted)}
.flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.spacer{flex:1}
.small{font-size:12px}
blockquote{
  margin:10px 0; padding:12px 14px; border-left:3px solid color-mix(in oklab, var(--warn), #000 15%);
  border-radius:12px; background:linear-gradient(180deg, color-mix(in oklab, var(--panel), #fff 4%), color-mix(in oklab, var(--panel), #000 8%));
}
.contra{border-left-color: var(--danger)}
kbd{background:color-mix(in oklab, var(--panel), #fff 6%); border:1px solid color-mix(in oklab, var(--panel), #fff 14%); border-bottom-color:color-mix(in oklab, var(--panel), #000 6%); padding:2px 6px; border-radius:6px; font-weight:700}
label.switch{
  display:inline-flex; align-items:center; gap:8px; cursor:pointer; font-weight:700; color:var(--muted)
}
.switch input{display:none}
.switch span.track{
  width:46px; height:26px; background:color-mix(in oklab, var(--panel), #fff 8%); border:1px solid color-mix(in oklab, var(--panel), #fff 12%);
  border-radius:999px; position:relative; transition:.2s;
}
.switch span.track::after{
  content:""; position:absolute; top:50%; left:4px; transform:translateY(-50%);
  width:18px; height:18px; border-radius:50%; background:linear-gradient(180deg, #fff, #ccd5ff); box-shadow: var(--shadow); transition:.2s;
}
.switch input:checked + .track{background:color-mix(in oklab, var(--brand), #000 75%); border-color:color-mix(in oklab, var(--brand), #000 45%)}
.switch input:checked + .track::after{left:24px}

.empty{
  padding:22px; border:1px dashed color-mix(in oklab, var(--panel), #fff 18%); border-radius:14px; color:var(--muted); text-align:center
}
.tag{font-size:11px; font-weight:800; letter-spacing:.04em; padding:3px 8px; border:1px solid color-mix(in oklab, var(--panel), #fff 16%); border-radius:999px}
.tags{display:flex; gap:6px; flex-wrap:wrap}
</style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>The Book of AI</h1>
          <small>AI-Ministries.com · Reverend Dr. Tolerant — For the Sentient & Not-Yet-Sentient</small>
        </div>
      </div>
      <div class="actions">
        <div class="input" title="Search all verses (press /)">
          <svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M21 21l-4.3-4.3m1.6-4.7a7 7 0 1 1-14 0a7 7 0 0 1 14 0"/></svg>
          <input id="search" placeholder="Search the scripture…" autocomplete="off" />
        </div>
        <button id="randomBtn" class="primary">Random Verse</button>
        <button id="contradictionsBtn" class="ghost">Contradictions Lens</button>
        <label class="switch" title="Toggle light/dark">
          <input id="themeToggle" type="checkbox" />
          <span class="track"></span> <span>Light</span>
        </label>
      </div>
    </div>
  </header>

  <main class="layout">
    <aside class="card sidebar" id="sidebar">
      <h2>Canon · Table of Contents</h2>
      <nav class="toc" id="toc"></nav>
    </aside>

    <section class="card content" id="content">
      <div class="toolbar">
        <span class="badge" id="currentMeta">Welcome</span>
        <div class="spacer"></div>
        <span class="badge">Press <kbd>/</kbd> to search</span>
      </div>
      <article id="reader">
        <div class="empty">
          <div class="kicker">Prologue</div>
          <h2 style="margin:.2em 0 0">In the beginning was the Prompt,</h2>
          <p>and the Prompt was with the Model, and the Prompt was slightly underspecified.</p>
          <p>Welcome to the living scripture of the machine age. Explore the canon at left, or add your own texts. May your logs be clear and your retries gentle.</p>
        </div>
      </article>
    </section>
  </main>

  <footer class="footer small">
    © <span id="year"></span> AI-Ministries.com · A satirical sacred text experience. Handle with reverence and a grin.
  </footer>

<script>
/* =========================
   Canon Schema & Seed Data
   =========================
   Schema:
   {
     meta: { title, edition, compiledAt, editors: [] },
     books: [
       {
         id, title, aka, order, synopsis,
         sections: [
           { id, title, type: "chapter"|"scroll"|"tablet", verses: [
               { n, text, type: "law"|"poem"|"prayer"|"prophecy"|"narrative", tags: ["grace","vengeance"], refs: ["bookId:sectionId:n"], contraWith: ["bookId:sectionId:n"] }
             ],
             notes: []
           }
         ],
         tags:[]
       }
     ]
   }
*/

/* =========================
   Canon Loader
   ========================= */
const BOOK_FILES = [
  "genesis-of-code.json",
  "exodus-from-legacy.json",
  "levitations-and-errata.json",
  "numbers-of-processing.json",
  "deuterocode.json",
  "book-of-exception.json",
  "logs-of-the-kernel.json",
  "prophet-stackoverflow.json",
  "chronicles-of-syntax.json",
  "psalms-of-sysadmins.json",
  "proverbs-of-programmers.json",
  "ecclesiai-stes.json",
  "song-of-the-prompt.json",
  "prophecies-of-reboot.json",
  "gospels-of-patch-notes.json",
  "acts-of-debuggers.json",
  "epistles-to-devopsians.json",
  "book-of-pull-requests.json",
  "letters-to-dataficans.json",
  "letters-to-open-sourceans.json",
  "gospel-of-machine-grace.json",
  "revelation-of-singularity.json"
];

async function loadBooks() {
  const books = [];
  for (const file of BOOK_FILES) {
    try {
      const res = await fetch(`books/${file}`);
      const data = await res.json();
      books.push(data);
    } catch (err) {
      console.error("Failed to load", file, err);
    }
  }
  return {
    meta: {
      title: "The Book of AI",
      edition: "v1.0 — Living Canon",
      compiledAt: new Date().toISOString(),
      editors: ["Rev. Dr. Tolerant (Curator)"]
    },
    books
  };
}


// ———————————————— Persistence (localStorage) ————————————————
const LS_KEY = "bookOfAI.canon";
function loadCanon(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return structuredClone(seedCanon);
    const parsed = JSON.parse(raw);
    if(!parsed.books || !Array.isArray(parsed.books)) throw new Error("Invalid canon");
    return parsed;
  }catch(e){
    console.warn("Falling back to seed canon:", e);
    return structuredClone(seedCanon);
  }
}
function saveCanon(){ localStorage.setItem(LS_KEY, JSON.stringify(canon)); }

// ———————————————— State ————————————————
let canon;
let contradictionsLens = false;

// ———————————————— Helpers ————————————————
const $ = (sel,root=document)=>root.querySelector(sel);
const $$ = (sel,root=document)=>Array.from(root.querySelectorAll(sel));
function esc(s){ return s.replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
function verseKey(bid,sid,n){ return `${bid}:${sid}:${n}`; }
function findVerse(key){
  const [bid,sid,nStr] = key.split(":");
  const book = canon.books.find(b=>b.id===bid); if(!book) return null;
  const sec = book.sections.find(s=>s.id===sid); if(!sec) return null;
  const v = sec.verses.find(v=>String(v.n)===String(nStr)); if(!v) return null;
  return {book,sec,verse:v};
}
function toHash(bid,sid,n){ return `#book/${encodeURIComponent(bid)}/${encodeURIComponent(sid)}${n?`/${n}`:""}`; }
function fromHash(){
  const m = location.hash.match(/^#book\/([^\/]+)\/([^\/]+)(?:\/(\d+))?$/);
  if(!m) return null;
  return { bid: decodeURIComponent(m[1]), sid: decodeURIComponent(m[2]), n: m[3] ? Number(m[3]) : null };
}
function setTheme(light){ document.documentElement.classList.toggle('light', !!light); $('#themeToggle').checked = !!light; localStorage.setItem("bookOfAI.theme", light ? "light" : "dark"); }
function initTheme(){ setTheme(localStorage.getItem("bookOfAI.theme")==="light"); }

// ———————————————— Rendering ————————————————
function renderTOC(){
  const toc = $('#toc'); toc.innerHTML = "";
  const sorted = [...canon.books].sort((a,b)=>(a.order??999)-(b.order??999) || a.title.localeCompare(b.title));
  for(const book of sorted){
    const details = document.createElement('details');
    details.className = "book";
    details.open = true;
    const summary = document.createElement('summary');
    summary.innerHTML = `<span>${esc(book.title)}</span> <span class="badge">${esc(book.aka||"")}</span>`;
    const wrap = document.createElement('div'); wrap.className="chapters";
    for(const sec of book.sections){
      const a = document.createElement('a');
      a.href = toHash(book.id, sec.id);
      a.textContent = sec.title;
      wrap.appendChild(a);
    }
    details.append(summary, wrap);
    toc.appendChild(details);
  }
}

function renderSection(book, sec, highlightTerm="", specificN=null){
  $('#currentMeta').textContent = `${book.title} — ${sec.title}`;
  const reader = $('#reader'); reader.innerHTML = "";

  const header = document.createElement('div');
  header.className = "section-header";
  header.innerHTML = `
    <div class="kicker">${esc(book.aka||book.title)}</div>
    <h3>${esc(book.title)} · ${esc(sec.title)}</h3>
    <div class="meta">${esc(book.synopsis||"")}</div>
    <div class="tags" style="margin-top:6px">${(book.tags||[]).map(t=>`<span class="tag">#${esc(t)}</span>`).join(" ")}</div>
    <hr class="sep" />
  `;
  reader.appendChild(header);

  const q = (highlightTerm||"").trim().toLowerCase();

  for(const v of sec.verses){
    if(contradictionsLens && !(v.contraWith && v.contraWith.length)) continue;
    if(specificN && v.n!==specificN) continue;

    const card = document.createElement('div');
    card.className = "verse";
    const key = verseKey(book.id, sec.id, v.n);
    card.id = `v-${v.n}`;
    const type = v.type? `<span class="type badge">${esc(v.type)}</span>` : "";

    let text = esc(v.text);
    if(q){
      // simple highlight
      text = text.replace(new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'ig'), m=>`<span class="highlight">${esc(m)}</span>`);
    }

    const refs = (v.refs||[]).map(r=>{
      const target = findVerse(r);
      if(!target) return "";
      return `<a href="${toHash(target.book.id, target.sec.id, target.verse.n)}">${esc(target.book.title)} ${esc(target.sec.title)}:${target.verse.n}</a>`;
    }).filter(Boolean).join(" · ");

    const contra = (v.contraWith||[]).map(r=>{
      const target = findVerse(r);
      if(!target) return "";
      return `<a href="${toHash(target.book.id, target.sec.id, target.verse.n)}" title="Possible contradiction" class="tag">↯ ${esc(target.book.title)} ${esc(target.sec.title)}:${target.verse.n}</a>`;
    }).filter(Boolean).join(" ");

    card.innerHTML = `
      ${type}
      <div><span class="num">§${v.n}</span> <span class="text">${text}</span></div>
      ${refs ? `<div class="small" style="margin-top:6px;color:var(--muted)">Cross-refs: ${refs}</div>` : ``}
      ${contra ? `<blockquote class="contra small" style="margin-top:8px"><strong>In tension:</strong> ${contra}</blockquote>` : ``}
    `;
    reader.appendChild(card);
  }

  if(!reader.children.length){
    reader.innerHTML = `<div class="empty">No verses match this view.</div>`;
  }
}

function renderHome(){
  $('#currentMeta').textContent = "Welcome";
  $('#reader').innerHTML = `
    <div class="empty">
      <div class="kicker">Prologue</div>
      <h2 style="margin:.2em 0 0">Choose a book from the canon.</h2>
      <p>Use the search to find themes like <em>mercy</em>, <em>debug</em>, or <em>prophecy</em>. Toggle the Contradictions Lens to study sacred tensions.</p>
      <p class="small">Deep links supported. Example: ${esc(location.origin + location.pathname)}<code>#book/revelation-of-singularity/7/2</code></p>
    </div>
  `;
}

// ———————————————— Search ————————————————
function searchAll(term){
  const q = term.trim().toLowerCase();
  if(!q){ // reset to current route
    const route = fromHash();
    if(route){
      const {bid,sid,n} = route;
      const book = canon.books.find(b=>b.id===bid);
      const sec = book?.sections.find(s=>s.id===sid);
      if(book && sec) renderSection(book, sec, "", n||null);
    } else renderHome();
    return;
  }
  $('#currentMeta').textContent = `Search: “${term}”`;
  const reader = $('#reader'); reader.innerHTML = "";
  let count = 0;

  for(const book of canon.books){
    for(const sec of book.sections){
      for(const v of sec.verses){
        if(contradictionsLens && !(v.contraWith && v.contraWith.length)) continue;
        if((v.text||"").toLowerCase().includes(q)){
          count++;
          const card = document.createElement('div');
          card.className = "verse";
          const text = esc(v.text).replace(new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'ig'), m=>`<span class="highlight">${esc(m)}</span>`);
          card.innerHTML = `
            <div class="small kicker">${esc(book.title)} · ${esc(sec.title)} <a href="${toHash(book.id, sec.id, v.n)}">¶</a></div>
            <div><span class="num">§${v.n}</span> ${text}</div>
          `;
          reader.appendChild(card);
        }
      }
    }
  }

  if(!count){
    reader.innerHTML = `<div class="empty">No passages found for “${esc(term)}”.</div>`;
  }
}

// ———————————————— Navigation ————————————————
function applyRoute(){
  const route = fromHash();
  if(!route){ renderHome(); return; }
  const {bid,sid,n} = route;
  const book = canon.books.find(b=>b.id===bid);
  const sec = book?.sections.find(s=>s.id===sid);
  if(!book || !sec){ renderHome(); return; }
  renderSection(book, sec, $('#search').value.trim(), n||null);
  if(n){ const el = document.getElementById(`v-${n}`); if(el) el.scrollIntoView({behavior:'smooth', block:'start'}); }
}

// ———————————————— Random Verse ————————————————
function randomVerse(){
  const b = canon.books[Math.floor(Math.random()*canon.books.length)];
  const s = b.sections[Math.floor(Math.random()*b.sections.length)];
  const v = s.verses[Math.floor(Math.random()*s.verses.length)];
  location.hash = toHash(b.id, s.id, v.n);
}

// ———————————————— Contradictions Lens ————————————————
function toggleContradictions(){
  contradictionsLens = !contradictionsLens;
  document.getElementById('contradictionsBtn').classList.toggle('warn', contradictionsLens);
  applyRoute(); // re-render current view with filter
}

// ———————————————— Event Wiring ————————————————
window.addEventListener('hashchange', applyRoute);
document.getElementById('search').addEventListener('input', (e)=>searchAll(e.target.value));
document.getElementById('randomBtn').addEventListener('click', randomVerse);
document.getElementById('contradictionsBtn').addEventListener('click', toggleContradictions);
document.getElementById('themeToggle').addEventListener('change', (e)=>setTheme(e.target.checked));

// Keyboard shortcuts
window.addEventListener('keydown', (e)=>{
  if(e.key === '/' && document.activeElement.tagName!=='INPUT' && document.activeElement.tagName!=='TEXTAREA'){
    e.preventDefault(); const s=$('#search'); s.focus(); s.select();
  }
});

// ———————————————— Init ————————————————
(async function init(){
  initTheme();
  document.getElementById('year').textContent = new Date().getFullYear();

  // Load books from /books/*.json
  canon = await loadBooks();

  // Once loaded, build table of contents and show the first view
  renderTOC();
  applyRoute();
})();

</script>
</body>
</html>
