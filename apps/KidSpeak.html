<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kid-Friendly AI Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .disclaimer {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            text-align: center;
            font-size: 0.9em;
            border-bottom: 3px solid #ffeaa7;
        }

        .chat-container {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9ff;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
        }

        .user-message {
            background: #e3f2fd;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .ai-message {
            background: #f1f8e9;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        .message-header {
            font-size: 0.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .user-message .message-header {
            color: #1976d2;
        }

        .ai-message .message-header {
            color: #388e3c;
        }

        .speak-btn {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .speak-btn:hover {
            background: #45a049;
            transform: scale(1.1);
        }

        .input-container {
            padding: 20px;
            background: white;
            border-top: 2px solid #e1e5e9;
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #userInput {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        #userInput:focus {
            border-color: #667eea;
        }

        #sendBtn {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }

        #sendBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        #sendBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
            font-style: italic;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .control-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: #ff5252;
            transform: translateY(-1px);
        }

        .sentence-length-btn {
            background: #4CAF50 !important;
            color: white;
            font-weight: bold;
            min-width: 45px;
        }

        .sentence-length-btn.two-sentences {
            background: #ff9800 !important;
        }

        .sentence-length-btn.three-sentences {
            background: #9c27b0 !important;
        }

        .listen-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            margin-left: 10px;
        }

        .listen-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .listen-btn.listening {
            background: #ff9800;
            animation: pulse 1.5s infinite;
        }

        .listen-btn.speaking {
            background: #ff4444;
        }

        .listen-btn.speaking:hover {
            background: #ff3333;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .voice-status {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .filtered-warning {
            color: #ff6b6b;
            font-size: 0.9em;
            margin-top: 5px;
            font-style: italic;
        }

        .name-picker-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .name-picker-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .name-picker-content h3 {
            margin-bottom: 20px;
            color: #667eea;
        }

        .name-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .name-option {
            background: #f0f8ff;
            border: 2px solid #667eea;
            border-radius: 15px;
            padding: 10px 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .name-option:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }

        .name-option.selected {
            background: #667eea;
            color: white;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        @media (max-width: 600px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .chat-container {
                height: 300px;
            }
            
            .message {
                max-width: 95%;
            }
        }
    </style>
<script src="/js/aiAPI.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåü <span id="aiName">Rainbow</span> üåü</h1>
            <p>Ask me anything! I'm here to help and chat!</p>
        </div>

        <div class="input-container">
            <div class="controls">
                <button class="control-btn" onclick="clearChat()">üóëÔ∏è Clear Chat</button>
                <button class="control-btn" onclick="showNamePicker()">üë§ Names</button>
                <button class="control-btn" onclick="toggleAutoSpeak()">üîä Auto-Speak: <span id="autoSpeakStatus">OFF</span></button>
                <button class="control-btn" onclick="toggleContinuousMode()">üîÑ Continuous Talk: <span id="continuousStatus">OFF</span></button>
                <button id="sentenceLengthBtn" class="control-btn sentence-length-btn" onclick="toggleSentenceLength()">üìè 1</button>
            </div>
            
            <div class="input-wrapper">
                <input type="text" id="userInput" placeholder="Ask me something fun!" maxlength="100">
                <div class="button-row">
                    <button id="sendBtn" onclick="sendMessage()">Send! üöÄ</button>
                    <button id="listenBtn" class="listen-btn" onclick="toggleListening()">üé§ Talk to Me!</button>
                </div>
            </div>
            <div id="voiceStatus" class="voice-status" style="display: none;"></div>
            <div id="filterWarning" class="filtered-warning" style="display: none;"></div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message ai-message">
                <div class="message-header">Rainbow ü§ñ</div>
                <div>Hi! I'm your AI buddy! What would you like to know?</div>
                <button class="speak-btn" onclick="speakText(this)" title="Listen to this message">üîä</button>
            </div>
        </div>

        <div class="disclaimer">
            <strong>‚ö†Ô∏è Important for Parents:</strong> This is an AI assistant designed for children 6+ with content filtering. 
            AI responses may not always be perfect. Please supervise your child's interactions and verify important information. 
            This tool is meant to inspire learning and creativity under adult guidance.
        </div>
    </div>

    <div id="namePickerModal" class="name-picker-modal">
        <div class="name-picker-content">
            <button class="close-modal" onclick="closeNamePicker()">√ó</button>
            
            <h3>Choose Your AI Friend's Name:</h3>
            <div class="name-options" id="aiNameOptions">
                <div class="name-option selected" onclick="selectAIName('Rainbow')">üåà Rainbow</div>
                <div class="name-option" onclick="selectAIName('Spark')">‚ö° Spark</div>
                <div class="name-option" onclick="selectAIName('Buddy')">üòä Buddy</div>
                <div class="name-option" onclick="selectAIName('Nova')">‚≠ê Nova</div>
                <div class="name-option" onclick="selectAIName('Sunny')">‚òÄÔ∏è Sunny</div>
                <div class="name-option" onclick="selectAIName('Echo')">üéµ Echo</div>
            </div>
            
            <h3 style="margin-top: 25px;">What Should I Call You?</h3>
            <div class="name-options" id="kidNameOptions">
                <div class="name-option selected" onclick="selectKidName('Friend')">üëã Friend</div>
                <div class="name-option" onclick="selectKidName('Explorer')">üîç Explorer</div>
                <div class="name-option" onclick="selectKidName('Scientist')">üî¨ Scientist</div>
                <div class="name-option" onclick="selectKidName('Artist')">üé® Artist</div>
                <div class="name-option" onclick="selectKidName('Captain')">üöÄ Captain</div>
                <div class="name-option" onclick="selectKidName('Star')">‚≠ê Star</div>
            </div>
            
            <button class="control-btn" onclick="closeNamePicker()" style="margin-top: 20px; background: #4CAF50;">Done! üéâ</button>
        </div>
    </div>

    <script>
        let chatHistory = [];
        let autoSpeak = false;
        let isListening = false;
        let isSpeaking = false;
        let recognition = null;
        let continuousMode = false;
        let currentUtterance = null;
        let sentenceLength = 1;
        let aiName = 'Rainbow';
        let kidName = 'Friend';
        const MAX_HISTORY = 6;
        
        const inappropriateWords = [
            'fuck', 'shit', 'bitch', 'damn', 'ass', 'asshole', 'bastard',
            'sex', 'porn', 'nude', 'naked', 'rape', 'murder', 'kill yourself'
        ];

        function getSystemPrompt() {
            const basePROMPT = `You are ${aiName}, a friendly AI buddy for kids. Address the child as "${kidName}" when appropriate. Be encouraging and positive, add one emoji at the end, use simple words, never discuss scary/violent topics, and redirect inappropriate topics to fun things.

ALWAYS end with "What else would you like to know?" to keep conversation going.`;

            if (sentenceLength === 1) {
                return basePROMPT + `\n\nIMPORTANT: Keep responses to ONE sentence maximum!`;
            } else if (sentenceLength === 2) {
                return basePROMPT + `\n\nIMPORTANT: Keep responses to TWO sentences maximum!`;
            } else {
                return basePROMPT + `\n\nIMPORTANT: Keep responses to THREE sentences maximum!`;
            }
        }

        function showNamePicker() {
            document.getElementById('namePickerModal').style.display = 'block';
            
            // Highlight current selections
            document.querySelectorAll('.name-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            const currentAIOption = document.querySelector(`[onclick="selectAIName('${aiName}')"]`);
            const currentKidOption = document.querySelector(`[onclick="selectKidName('${kidName}')"]`);
            
            if (currentAIOption) currentAIOption.classList.add('selected');
            if (currentKidOption) currentKidOption.classList.add('selected');
        }

        function closeNamePicker() {
            document.getElementById('namePickerModal').style.display = 'none';
        }

		function saveNames() {
			localStorage.setItem('kidspeak_ai_name', aiName);
			localStorage.setItem('kidspeak_kid_name', kidName);
		}

		function loadNames() {
			const savedAiName = localStorage.getItem('kidspeak_ai_name');
			const savedKidName = localStorage.getItem('kidspeak_kid_name');
			
			if (savedAiName) {
				aiName = savedAiName;
				document.getElementById('aiName').textContent = aiName;
			}
			
			if (savedKidName) {
				kidName = savedKidName;
			}
		}

		// Update the selectAIName function:
		function selectAIName(name) {
			aiName = name;
			document.getElementById('aiName').textContent = name;
			saveNames(); // Add this line
			
			// Update visual selection
			document.querySelectorAll('#aiNameOptions .name-option').forEach(option => {
				option.classList.remove('selected');
			});
			document.querySelector(`[onclick="selectAIName('${name}')"]`).classList.add('selected');
		}

		// Update the selectKidName function:
		function selectKidName(name) {
			kidName = name;
			saveNames(); // Add this line
			
			// Update visual selection
			document.querySelectorAll('#kidNameOptions .name-option').forEach(option => {
				option.classList.remove('selected');
			});
			document.querySelector(`[onclick="selectKidName('${name}')"]`).classList.add('selected');
		}

		function filterInput(text) {
			const words = text.toLowerCase().split(/\s+/);
			const badWords = ['fuck', 'shit', 'bitch', 'damn', 'asshole', 'bastard', 'sex', 'porn', 'nude', 'naked', 'rape', 'murder'];
			
			const foundBadWords = words.filter(word => {
				// Remove punctuation and check exact match
				const cleanWord = word.replace(/[^\w]/g, '');
				return badWords.includes(cleanWord);
			});
			
			if (foundBadWords.length > 0) {
				document.getElementById('filterWarning').textContent = 
					`Let's use kind words instead! Try asking about something fun like animals, space, or science! üòä`;
				document.getElementById('filterWarning').style.display = 'block';
				return false;
			}
			
			document.getElementById('filterWarning').style.display = 'none';
			return true;
		}

        function addMessage(role, content, speak = false) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role === 'user' ? 'user-message' : 'ai-message'}`;
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';
            headerDiv.textContent = role === 'user' ? `${kidName} üë§` : `${aiName} ü§ñ`;
            
            const contentDiv = document.createElement('div');
            contentDiv.textContent = content;
            
            messageDiv.appendChild(headerDiv);
            messageDiv.appendChild(contentDiv);
            
            if (role === 'ai') {
                const speakBtn = document.createElement('button');
                speakBtn.className = 'speak-btn';
                speakBtn.innerHTML = 'üîä';
                speakBtn.title = 'Listen to this message';
                speakBtn.onclick = () => speakText(speakBtn);
                messageDiv.appendChild(speakBtn);
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            if (speak && role === 'ai') {
                setTimeout(() => {
                    speakMessage(messageDiv.querySelector('.speak-btn'));
                }, 500);
            }
        }

        function addLoadingMessage() {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai-message loading';
            messageDiv.id = 'loadingMessage';
            messageDiv.textContent = `${aiName} is thinking`;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeLoadingMessage() {
            const loadingMsg = document.getElementById('loadingMessage');
            if (loadingMsg) {
                loadingMsg.remove();
            }
        }

		async function sendMessage() {
			const input = document.getElementById('userInput');
			const sendBtn = document.getElementById('sendBtn');
			const message = input.value.trim();
			
			if (!message) return;
			if (!filterInput(message)) {
				input.value = '';
				return;
			}
			
			// Stop everything
			stopEverything();
			
			sendBtn.disabled = true;
			addMessage('user', message);
			input.value = '';
			
			chatHistory.push({ role: 'user', content: message });
			if (chatHistory.length > MAX_HISTORY) {
				chatHistory = chatHistory.slice(-MAX_HISTORY);
			}
			
			addLoadingMessage();
			
			try {
				// Build a simple prompt with system context and the current message
				let prompt = `${getSystemPrompt()}\n\nHuman: ${message}\nAssistant:`;
				
				// URL encode the prompt
				const encodedPrompt = encodeURIComponent(prompt);
				
				// Use the same pattern as the working test URL
				const response = await fetch(`https://text.pollinations.ai/${encodedPrompt}?model=openai&referrer=www.ai-ministries.com`);
				
				if (!response.ok) {
					throw new Error(`HTTP error! status: ${response.status}`);
				}
				
				const aiResponse = await response.text();
				
				removeLoadingMessage();
				chatHistory.push({ role: 'assistant', content: aiResponse.trim() });
				addMessage('ai', aiResponse.trim(), autoSpeak || continuousMode);
				
			} catch (error) {
				removeLoadingMessage();
				console.error('Error:', error);
				addMessage('ai', "Oops! I'm having trouble right now. Try again!", false);
			}
			
			sendBtn.disabled = false;
		}
		
        function cleanTextForSpeech(text) {
            return text
                .replace(/[\u{1F600}-\u{1F64F}]/gu, '')
                .replace(/[\u{1F300}-\u{1F5FF}]/gu, '')
                .replace(/[\u{1F680}-\u{1F6FF}]/gu, '')
                .replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '')
                .replace(/[\u{2600}-\u{26FF}]/gu, '')
                .replace(/[\u{2700}-\u{27BF}]/gu, '')
                .replace(/[\u{1F900}-\u{1F9FF}]/gu, '')
                .replace(/[\u{1F018}-\u{1F270}]/gu, '')
                .replace(/ü§ñ|üë§|üòä|üòÖ|üåü|üöÄ|üóëÔ∏è|üîä|‚ö†Ô∏è|üé§|üõë|üìè|üîá|üéß|üñºÔ∏è|üìà|üîÑ/g, '')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function stopEverything() {
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            if (isListening && recognition) {
                recognition.stop();
            }
            isSpeaking = false;
            updateListenButton();
            document.getElementById('voiceStatus').style.display = 'none';
        }

        function speakMessage(button) {
            const messageContent = button.parentElement.children[1].textContent;
            const cleanText = cleanTextForSpeech(messageContent);
            
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                
                currentUtterance = new SpeechSynthesisUtterance(cleanText);
                currentUtterance.rate = 0.7;
                currentUtterance.pitch = 1.1;
                
                const voices = speechSynthesis.getVoices();
                const preferredVoice = voices.find(voice => 
                    voice.name.includes('Female') || 
                    voice.name.includes('Google US English') ||
                    voice.lang.includes('en-US')
                );
                
                if (preferredVoice) {
                    currentUtterance.voice = preferredVoice;
                }
                
                currentUtterance.onstart = () => {
                    isSpeaking = true;
                    updateListenButton();
                };
                
                currentUtterance.onend = () => {
                    isSpeaking = false;
                    updateListenButton();
                    
                    // Only start listening in continuous mode after AI finishes speaking
                    if (continuousMode) {
                        setTimeout(() => {
                            if (continuousMode && !isListening && !isSpeaking) {
                                toggleListening();
                            }
                        }, 1000);
                    }
                };
                
                currentUtterance.onerror = () => {
                    isSpeaking = false;
                    updateListenButton();
                };
                
                speechSynthesis.speak(currentUtterance);
            }
        }

        function speakText(button) {
            const messageContent = button.parentElement.children[1].textContent;
            const cleanText = cleanTextForSpeech(messageContent);
            
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.rate = 0.8;
                utterance.pitch = 1.1;
                
                const voices = speechSynthesis.getVoices();
                const preferredVoice = voices.find(voice => 
                    voice.name.includes('Female') || 
                    voice.name.includes('Google US English') ||
                    voice.lang.includes('en-US')
                );
                
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }
                
                speechSynthesis.speak(utterance);
            }
        }

        function clearChat() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '';
            chatHistory = [];
            stopEverything();
            
            addMessage('ai', `Hi there! I'm your friendly ${aiName}! üòä I love answering questions about science, animals, space, books, and lots of fun stuff! What would you like to know today?`);
        }

        function toggleAutoSpeak() {
            autoSpeak = !autoSpeak;
            document.getElementById('autoSpeakStatus').textContent = autoSpeak ? 'ON' : 'OFF';
        }

        function toggleSentenceLength() {
            sentenceLength = sentenceLength === 3 ? 1 : sentenceLength + 1;
            
            const btn = document.getElementById('sentenceLengthBtn');
            btn.textContent = `üìè ${sentenceLength}`;
            
            btn.className = 'control-btn sentence-length-btn';
            if (sentenceLength === 2) {
                btn.classList.add('two-sentences');
            } else if (sentenceLength === 3) {
                btn.classList.add('three-sentences');
            }
        }

        function toggleContinuousMode() {
            continuousMode = !continuousMode;
            document.getElementById('continuousStatus').textContent = continuousMode ? 'ON' : 'OFF';
            
            if (continuousMode) {
                // Start listening immediately when continuous mode is turned on
                if (!isListening && !isSpeaking) {
                    toggleListening();
                }
            } else {
                stopEverything();
            }
        }

        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;
                
                recognition.onstart = function() {
                    isListening = true;
                    updateListenButton();
                    document.getElementById('voiceStatus').textContent = 'üé§ Listening... Speak now!';
                    document.getElementById('voiceStatus').style.display = 'block';
                };
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('userInput').value = transcript;
                    document.getElementById('voiceStatus').textContent = `üìù I heard: "${transcript}"`;
                    
                    setTimeout(() => {
                        if (transcript.trim()) {
                            sendMessage();
                        }
                    }, 1000);
                };
                
                recognition.onerror = function(event) {
                    isListening = false;
                    updateListenButton();
                    
                    let errorMessage = "üîá Sorry, I couldn't hear you clearly. ";
                    
                    switch(event.error) {
                        case 'network':
                            errorMessage += "Check your internet connection!";
                            break;
                        case 'not-allowed':
                            errorMessage += "Please allow microphone access!";
                            break;
                        case 'no-speech':
                            errorMessage += "I didn't hear anything. Try speaking louder!";
                            break;
                        default:
                            errorMessage += "Try again!";
                    }
                    
                    document.getElementById('voiceStatus').textContent = errorMessage;
                    setTimeout(() => {
                        document.getElementById('voiceStatus').style.display = 'none';
                    }, 3000);
                };
                
                recognition.onend = function() {
                    isListening = false;
                    updateListenButton();
                    
                    setTimeout(() => {
                        if (!document.getElementById('voiceStatus').textContent.includes('I heard:')) {
                            document.getElementById('voiceStatus').style.display = 'none';
                        }
                    }, 3000);
                };
                
                return true;
            }
            return false;
        }
        
        function toggleListening() {
            if (isSpeaking) {
                stopEverything();
                return;
            }
            
            if (!recognition) {
                if (!initSpeechRecognition()) {
                    alert("üîá Voice recognition not available. You can type your questions! üòä");
                    return;
                }
            }
            
            if (isListening) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('Error starting recognition:', error);
                    document.getElementById('voiceStatus').textContent = 'üîá Microphone is busy. Try again!';
                    document.getElementById('voiceStatus').style.display = 'block';
                }
            }
        }
        
		function updateListenButton() {
			const btn = document.getElementById('listenBtn');
			
			if (isSpeaking) {
				btn.classList.remove('listening');
				btn.classList.add('speaking');
				btn.textContent = 'üõë Stop Talking';
				btn.onclick = stopEverything;
			} else if (isListening) {
				btn.classList.remove('speaking');
				btn.classList.add('listening');
				btn.textContent = 'üõë Stop Listening';
				btn.onclick = toggleListening;
			} else {
				btn.classList.remove('listening', 'speaking');
				btn.textContent = 'üé§ Talk to Me!';
				btn.onclick = toggleListening;
			}
		}

		// Enter key to send message
		document.getElementById('userInput').addEventListener('keypress', function(e) {
			if (e.key === 'Enter') {
				sendMessage();
			}
		});

		// Initialize speech recognition on page load
		document.addEventListener('DOMContentLoaded', function() {
			loadNames(); // Load saved names first
			initSpeechRecognition();
		});

		// Load voices when they become available
		if ('speechSynthesis' in window) {
			speechSynthesis.addEventListener('voiceschanged', function() {
				// Voices are now loaded
			});
		}

		// Close modal when clicking outside
		document.getElementById('namePickerModal').addEventListener('click', function(e) {
			if (e.target === this) {
				closeNamePicker();
			}
		});
		
   </script>
</body>
</html>				