<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kid-Friendly AI Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .disclaimer {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            text-align: center;
            font-size: 0.9em;
            border-bottom: 3px solid #ffeaa7;
        }

        .chat-container {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9ff;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
        }

        .user-message {
            background: #e3f2fd;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .ai-message {
            background: #f1f8e9;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        .message-header {
            font-size: 0.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .user-message .message-header {
            color: #1976d2;
        }

        .ai-message .message-header {
            color: #388e3c;
        }

        .speak-btn {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .speak-btn:hover {
            background: #45a049;
            transform: scale(1.1);
        }

        .input-container {
            padding: 20px;
            background: white;
            border-top: 2px solid #e1e5e9;
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #userInput {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        #userInput:focus {
            border-color: #667eea;
        }

        #sendBtn {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }

        #sendBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        #sendBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
            font-style: italic;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .control-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: #ff5252;
            transform: translateY(-1px);
        }

        .sentence-length-btn {
            background: #4CAF50 !important; /* Green for 1 sentence */
            color: white;
            font-weight: bold;
            min-width: 45px;
        }

        .sentence-length-btn.two-sentences {
            background: #ff9800 !important; /* Orange for 2 sentences */
        }

        .sentence-length-btn.three-sentences {
            background: #9c27b0 !important; /* Purple for 3 sentences */
        }

        .listen-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            margin-left: 10px;
        }

        .listen-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .listen-btn.listening {
            background: #ff4444;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .voice-status {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .filtered-warning {
            color: #ff6b6b;
            font-size: 0.9em;
            margin-top: 5px;
            font-style: italic;
        }

        @media (max-width: 600px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .chat-container {
                height: 300px;
            }
            
            .message {
                max-width: 95%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåü Kid-Friendly AI Buddy üåü</h1>
            <p>Ask me anything! I'm here to help and chat safely!</p>
        </div>

        <div class="input-container">
            <div class="controls">
                <button class="control-btn" onclick="clearChat()">üóëÔ∏è Clear Chat</button>
                <button class="control-btn" onclick="toggleAutoSpeak()">üîä Auto-Speak: <span id="autoSpeakStatus">OFF</span></button>
                <button class="control-btn" onclick="toggleContinuousMode()">üîÑ Continuous Talk: <span id="continuousStatus">OFF</span></button>
                <button id="sentenceLengthBtn" class="control-btn sentence-length-btn" onclick="toggleSentenceLength()">üìù 1</button>
                <button id="stopSpeakBtn" class="control-btn stop-speak-btn" onclick="stopSpeaking()" style="display: none;">üõë Stop Talking</button>
            </div>
            
            <div class="input-wrapper">
                <input type="text" id="userInput" placeholder="Ask me something fun!" maxlength="100">
                <div class="button-row">
                    <button id="sendBtn" onclick="sendMessage()">Send! üöÄ</button>
                    <button id="listenBtn" class="listen-btn" onclick="toggleListening()">üé§ Talk to Me!</button>
                </div>
            </div>
            <div id="voiceStatus" class="voice-status" style="display: none;"></div>
            <div id="filterWarning" class="filtered-warning" style="display: none;"></div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message ai-message">
                <div class="message-header">AI Buddy ü§ñ</div>
                <div>Hi! I'm your AI buddy! What would you like to know?</div>
                <button class="speak-btn" onclick="speakText(this)" title="Listen to this message">üîä</button>
            </div>
        </div>

        <div class="disclaimer">
            <strong>‚ö†Ô∏è Important for Parents:</strong> This is an AI assistant designed for children 6+ with content filtering. 
            AI responses may not always be perfect. Please supervise your child's interactions and verify important information. 
            This tool is meant to inspire learning and creativity under adult guidance.
        </div>
    </div>

    <script>
        let chatHistory = [];
        let autoSpeak = false;
        let isListening = false;
        let isSpeaking = false;
        let recognition = null;
        let continuousMode = false;
        let currentUtterance = null;
        let sentenceLength = 1; // 1, 2, or 3 sentences
        const MAX_HISTORY = 6; // Keep conversation short for kids
        
        // Only filter truly inappropriate words - let AI handle the rest
        const inappropriateWords = [
            'fuck', 'shit', 'bitch', 'damn', 'hell', 'ass', 'asshole', 'bastard',
            'sex', 'porn', 'nude', 'naked', 'rape', 'murder', 'kill yourself'
        ];

        // System prompt for adjustable response length
        function getSystemPrompt() {
            const basePROMPT = `You are a friendly AI buddy for kids. Be encouraging and positive, add one emoji at the end, use simple words, never discuss scary/violent topics, and redirect inappropriate topics to fun things.

ALWAYS end with "What else would you like to know?" to keep conversation going.`;

            if (sentenceLength === 1) {
                return basePROMPT + `\n\nIMPORTANT: Keep responses to ONE sentence maximum!

Example: "Cats are furry pets that say meow and love to play! üê± What else would you like to know?"`;
            } else if (sentenceLength === 2) {
                return basePROMPT + `\n\nIMPORTANT: Keep responses to TWO sentences maximum!

Example: "Cats are furry pets that say meow and love to play! They like to chase toys and sleep in sunny spots. üê± What else would you like to know?"`;
            } else {
                return basePROMPT + `\n\nIMPORTANT: Keep responses to THREE sentences maximum!

Example: "Cats are furry pets that say meow and love to play! They like to chase toys and sleep in sunny spots. Cats have excellent night vision and can see in the dark much better than humans can. üê± What else would you like to know?"`;
            }
        }

        function filterInput(text) {
            const lowerText = text.toLowerCase();
            const foundWords = inappropriateWords.filter(word => lowerText.includes(word));
            
            if (foundWords.length > 0) {
                document.getElementById('filterWarning').textContent = 
                    `Let's use kind words instead! Try asking about something fun like animals, space, or science! üòä`;
                document.getElementById('filterWarning').style.display = 'block';
                return false;
            }
            
            document.getElementById('filterWarning').style.display = 'none';
            return true;
        }

		function addMessage(role, content, speak = false) {
			const chatContainer = document.getElementById('chatContainer');
			const messageDiv = document.createElement('div');
			messageDiv.className = `message ${role === 'user' ? 'user-message' : 'ai-message'}`;
			
			const headerDiv = document.createElement('div');
			headerDiv.className = 'message-header';
			headerDiv.textContent = role === 'user' ? 'You üë§' : 'AI Buddy ü§ñ';
			
			const contentDiv = document.createElement('div');
			contentDiv.textContent = content;
			
			messageDiv.appendChild(headerDiv);
			messageDiv.appendChild(contentDiv);
			
			if (role === 'ai') {
				const speakBtn = document.createElement('button');
				speakBtn.className = 'speak-btn';
				speakBtn.innerHTML = 'üîä';
				speakBtn.title = 'Listen to this message';
				speakBtn.onclick = () => speakText(speakBtn);
				messageDiv.appendChild(speakBtn);
			}
			
			chatContainer.appendChild(messageDiv);
			chatContainer.scrollTop = chatContainer.scrollHeight;
			
			// FIXED: Handle TTS for AI messages - ensure we're not already speaking
			if (speak && role === 'ai' && !isSpeaking) {
				// Stop any current listening before speaking
				if (isListening && recognition) {
					recognition.stop();
				}
				
				setTimeout(() => {
					// Double-check we're not speaking before starting
					if (!isSpeaking && !speechSynthesis.speaking) {
						speakTextAndContinue(messageDiv.querySelector('.speak-btn'));
					}
				}, 1000); // Increased delay
			}
		}

        function addLoadingMessage() {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message ai-message loading';
            messageDiv.id = 'loadingMessage';
            messageDiv.textContent = 'AI Buddy is thinking';
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeLoadingMessage() {
            const loadingMsg = document.getElementById('loadingMessage');
            if (loadingMsg) {
                loadingMsg.remove();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const sendBtn = document.getElementById('sendBtn');
            const listenBtn = document.getElementById('listenBtn');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Filter only truly inappropriate content
            if (!filterInput(message)) {
                input.value = '';
                return;
            }
            
            // Stop any current speech and listening
            stopAllAudio();
            
            // Disable controls during processing
            sendBtn.disabled = true;
            listenBtn.classList.add('disabled');
            
            // Add user message
            addMessage('user', message);
            input.value = '';
            
            // Add to history (keep it short for kids)
            chatHistory.push({ role: 'user', content: message });
            if (chatHistory.length > MAX_HISTORY) {
                chatHistory = chatHistory.slice(-MAX_HISTORY);
            }
            
            addLoadingMessage();
            
            try {
                const response = await fetch('https://text.pollinations.ai/openai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'openai',
                        messages: [
                            { role: 'system', content: getSystemPrompt() },
                            ...chatHistory
                        ],
                        temperature: 0.3,
                        max_tokens: sentenceLength === 1 ? 50 : sentenceLength === 2 ? 100 : 180,
                        private: false,
                        referrer: 'www.ai-ministries.com'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const aiResponse = data.choices[0].message.content;
                
                removeLoadingMessage();
                
                // Add AI response to history first
                chatHistory.push({ role: 'assistant', content: aiResponse });
                
                // Add message with proper speech handling
                addMessage('ai', aiResponse, autoSpeak || continuousMode);
                
            } catch (error) {
                removeLoadingMessage();
                console.error('Error:', error);
                addMessage('ai', "Oops! I'm having trouble right now. Try again! üòÖ", false);
            }
            
            // Re-enable controls
            sendBtn.disabled = false;
            listenBtn.classList.remove('disabled');
        }

        function cleanTextForSpeech(text) {
            return text
                .replace(/[\u{1F600}-\u{1F64F}]/gu, '') // Emoticons
                .replace(/[\u{1F300}-\u{1F5FF}]/gu, '') // Misc Symbols and Pictographs
                .replace(/[\u{1F680}-\u{1F6FF}]/gu, '') // Transport and Map
                .replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '') // Regional country flags
                .replace(/[\u{2600}-\u{26FF}]/gu, '')   // Misc symbols
                .replace(/[\u{2700}-\u{27BF}]/gu, '')   // Dingbats
                .replace(/[\u{1F900}-\u{1F9FF}]/gu, '') // Supplemental Symbols and Pictographs
                .replace(/[\u{1F018}-\u{1F270}]/gu, '') // Various symbols
                .replace(/ü§ñ|üë§|üòä|üòÖ|üåü|üöÄ|üóëÔ∏è|üîä|‚ö†Ô∏è|üé§|üõë|üìù|üîá|üéß|üñºÔ∏è|üìà|üîÑ|üîë/g, '') // Specific emoji
                .replace(/\s+/g, ' ') // Replace multiple spaces with single space
                .trim();
        }

        function stopAllAudio() {
            // Stop speech synthesis
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
            
            // Stop listening
            if (isListening && recognition) {
                recognition.stop();
            }
            
            isSpeaking = false;
            document.getElementById('stopSpeakBtn').style.display = 'none';
        }

        function stopSpeaking() {
            stopAllAudio();
        }

        // NEW: Function to speak text and then continue conversation if in continuous mode
		function speakTextAndContinue(button) {
			const messageContent = button.parentElement.children[1].textContent;
			const cleanText = cleanTextForSpeech(messageContent);
			
			if ('speechSynthesis' in window) {
				speechSynthesis.cancel();
				
				currentUtterance = new SpeechSynthesisUtterance(cleanText);
				currentUtterance.rate = 0.7; // Slower for kids
				currentUtterance.pitch = 1.1;
				
				const voices = speechSynthesis.getVoices();
				const preferredVoice = voices.find(voice => 
					voice.name.includes('Female') || 
					voice.name.includes('Google US English') ||
					voice.lang.includes('en-US')
				);
				
				if (preferredVoice) {
					currentUtterance.voice = preferredVoice;
				}
				
				currentUtterance.onstart = () => {
					isSpeaking = true;
					document.getElementById('stopSpeakBtn').style.display = 'inline-block';
				};
				
				currentUtterance.onend = () => {
					isSpeaking = false;
					document.getElementById('stopSpeakBtn').style.display = 'none';
					
					// FIXED: Only continue conversation if in continuous mode AND not already listening
					if (continuousMode && !isListening) {
						// Wait longer to ensure everything is properly finished
						setTimeout(() => {
							// Double-check we're still in continuous mode and not listening
							if (continuousMode && !isListening && !isSpeaking && !speechSynthesis.speaking) {
								startListeningForNext();
							}
						}, 2000); // Increased delay to 2 seconds
					}
				};
				
				currentUtterance.onerror = () => {
					isSpeaking = false;
					document.getElementById('stopSpeakBtn').style.display = 'none';
				};
				
				speechSynthesis.speak(currentUtterance);
			}
		}

        // NEW: Function to start listening for the next question in continuous mode
        function startListeningForNext() {
            if (!continuousMode || isListening || isSpeaking) return;
            
            document.getElementById('voiceStatus').textContent = 'üé§ Ready for your next question! Speak when ready...';
            document.getElementById('voiceStatus').style.display = 'block';
            
            if (recognition) {
                // Simple approach - just restart listening with longer intervals
                const attemptListen = () => {
                    if (!continuousMode || isListening || isSpeaking) return;
                    
                    try {
                        recognition.start();
                    } catch (error) {
                        console.error('Recognition start error:', error);
                        // Try again in 2 seconds if it fails
                        setTimeout(attemptListen, 2000);
                    }
                };
                
                setTimeout(attemptListen, 500);
            }
        }

        function speakText(button) {
            const messageContent = button.parentElement.children[1].textContent;
            const cleanText = cleanTextForSpeech(messageContent);
            
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.rate = 0.8;
                utterance.pitch = 1.1;
                
                const voices = speechSynthesis.getVoices();
                const preferredVoice = voices.find(voice => 
                    voice.name.includes('Female') || 
                    voice.name.includes('Google US English') ||
                    voice.lang.includes('en-US')
                );
                
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }
                
                speechSynthesis.speak(utterance);
            } else {
                alert("Sorry! Your browser doesn't support text-to-speech. üòî");
            }
        }

        function clearChat() {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '';
            chatHistory = [];
            
            // Add welcome message back
            addMessage('ai', "Hi there! I'm your friendly AI buddy! üòä I love answering questions about science, animals, space, books, and lots of fun stuff! What would you like to know today?");
        }

        function toggleAutoSpeak() {
            autoSpeak = !autoSpeak;
            document.getElementById('autoSpeakStatus').textContent = autoSpeak ? 'ON' : 'OFF';
        }

        function toggleSentenceLength() {
            sentenceLength = sentenceLength === 3 ? 1 : sentenceLength + 1;
            
            const btn = document.getElementById('sentenceLengthBtn');
            btn.textContent = `üìù ${sentenceLength}`;
            
            // Update button color based on sentence length
            btn.className = 'control-btn sentence-length-btn';
            if (sentenceLength === 2) {
                btn.classList.add('two-sentences');
            } else if (sentenceLength === 3) {
                btn.classList.add('three-sentences');
            }
            
            // Update button title for accessibility
            const labels = {
                1: 'Short answers (1 sentence)',
                2: 'Medium answers (2 sentences)', 
                3: 'Longer answers (3 sentences)'
            };
            btn.title = labels[sentenceLength];
        }

        function toggleContinuousMode() {
            continuousMode = !continuousMode;
            document.getElementById('continuousStatus').textContent = continuousMode ? 'ON' : 'OFF';
            
            if (continuousMode) {
                // If turning on continuous mode, start listening
                if (!isListening && recognition && !isSpeaking) {
                    setTimeout(() => {
                        toggleListening();
                    }, 500);
                }
            } else {
                // If turning off continuous mode, stop listening
                if (isListening && recognition) {
                    recognition.stop();
                }
                document.getElementById('voiceStatus').style.display = 'none';
            }
        }

        // Speech Recognition Functions
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = false;  // Back to false - this was correct
                recognition.interimResults = false;  // Back to false - this was correct  
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;
                
                recognition.onstart = function() {
                    isListening = true;
                    updateListenButton();
                    if (!document.getElementById('voiceStatus').textContent.includes('Ready for your next question')) {
                        document.getElementById('voiceStatus').textContent = 'üé§ Listening... Speak now!';
                        document.getElementById('voiceStatus').style.display = 'block';
                    }
                };
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('userInput').value = transcript;
                    document.getElementById('voiceStatus').textContent = `üìù I heard: "${transcript}"`;
                    
                    // Auto-send the message after a short delay
                    setTimeout(() => {
                        if (transcript.trim()) {
                            sendMessage();
                        }
                    }, 1000);
                };
                
                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    
                    isListening = false;
                    updateListenButton();
                    
                    // Handle 'no-speech' differently in continuous mode - just restart quietly
                    if (event.error === 'no-speech' && continuousMode) {
                        document.getElementById('voiceStatus').textContent = 'üé§ Still listening... speak when ready!';
                        setTimeout(() => {
                            if (continuousMode && !isListening && !isSpeaking) {
                                startListeningForNext();
                            }
                        }, 1000);
                        return;
                    }
                    
                    // For other errors, show messages
                    let errorMessage = "üîá Sorry, I couldn't hear you clearly. ";
                    
                    switch(event.error) {
                        case 'network':
                            errorMessage += "Check your internet connection and try again!";
                            break;
                        case 'not-allowed':
                            errorMessage += "Please allow microphone access to talk to me!";
                            break;
                        case 'no-speech':
                            errorMessage += "I didn't hear anything. Try speaking louder!";
                            break;
                        case 'audio-capture':
                            errorMessage += "Microphone not working. Try typing instead!";
                            break;
                        default:
                            errorMessage += "Try clicking the microphone button again!";
                    }
                    
                    document.getElementById('voiceStatus').textContent = errorMessage;
                    
                    // Auto-restart for any error in continuous mode (except not-allowed)
                    if (continuousMode && event.error !== 'not-allowed') {
                        setTimeout(() => {
                            if (continuousMode && !isListening && !isSpeaking) {
                                startListeningForNext();
                            }
                        }, 3000);
                    } else {
                        setTimeout(() => {
                            document.getElementById('voiceStatus').style.display = 'none';
                        }, 4000);
                    }
                };
                
                recognition.onend = function() {
                    isListening = false;
                    updateListenButton();
                    
                    // ONLY restart if we're in continuous mode AND not currently speaking
                    if (continuousMode && !isSpeaking) {
                        // Wait longer to ensure speech has completely finished
                        setTimeout(() => {
                            if (continuousMode && !isListening && !isSpeaking && !speechSynthesis.speaking) {
                                console.log('Restarting listening after onend in continuous mode');
                                startListeningForNext();
                            }
                        }, 2000); // Increased delay to 2 seconds
                    } else if (!continuousMode) {
                        setTimeout(() => {
                            if (!document.getElementById('voiceStatus').textContent.includes('I heard:')) {
                                document.getElementById('voiceStatus').style.display = 'none';
                            }
                        }, 3000);
                    }
                };
                
                return true;
            }
            return false;
        }
        
        function toggleListening() {
            const listenBtn = document.getElementById('listenBtn');
            
            if (isSpeaking) {
                document.getElementById('voiceStatus').textContent = 'üîä Wait for me to finish talking first!';
                document.getElementById('voiceStatus').style.display = 'block';
                setTimeout(() => {
                    if (!continuousMode) {
                        document.getElementById('voiceStatus').style.display = 'none';
                    }
                }, 2000);
                return;
            }
            
            if (!recognition) {
                if (!initSpeechRecognition()) {
                    const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    const message = isMobile ? 
                        "üîá Voice recognition not available on this browser. You can type your questions! üòä" :
                        "üîá Sorry! Your browser doesn't support voice recognition. You can still type your questions! üòä";
                    alert(message);
                    return;
                }
            }
            
            if (isListening) {
                recognition.stop();
                document.getElementById('voiceStatus').textContent = 'üõë Stopped listening.';
                setTimeout(() => {
                    if (!continuousMode) {
                        document.getElementById('voiceStatus').style.display = 'none';
                    }
                }, 2000);
            } else {
                stopAllAudio();
                
                try {
                    if (/Android/i.test(navigator.userAgent)) {
                        setTimeout(() => {
                            recognition.start();
                        }, 100);
                    } else {
                        recognition.start();
                    }
                } catch (error) {
                    console.error('Error starting recognition:', error);
                    document.getElementById('voiceStatus').textContent = 'üîá Microphone is busy. Please try again in a moment!';
                    document.getElementById('voiceStatus').style.display = 'block';
                    setTimeout(() => {
                        if (!continuousMode) {
                            document.getElementById('voiceStatus').style.display = 'none';
                        }
                    }, 3000);
                }
            }
        }
        
        function updateListenButton() {
            const btn = document.getElementById('listenBtn');
            if (isListening) {
                btn.classList.add('listening');
                btn.textContent = 'üõë Stop Listening';
            } else {
                btn.classList.remove('listening');
                btn.textContent = 'üé§ Talk to Me!';
            }
        }

        // Enter key to send message
        document.getElementById('userInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Initialize speech recognition on page load
        document.addEventListener('DOMContentLoaded', function() {
            initSpeechRecognition();
        });

        // Load voices when they become available
        if ('speechSynthesis' in window) {
            speechSynthesis.addEventListener('voiceschanged', function() {
                // Voices are now loaded
            });
        }
    </script>
</body>
</html>