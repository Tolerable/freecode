<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Puppy Cuteness Meter</title>
    <style>
        :root {
            --primary-color: #f0f6ff;
            --secondary-color: #e0edff;
            --accent-color-1: #FF5757; /* Red */
            --accent-color-2: #FFBD59; /* Orange */
            --accent-color-3: #FFDE59; /* Yellow */
            --accent-color-4: #59FF8E; /* Green */
            --accent-color-5: #5CE1E6; /* Blue */
            --accent-color-6: #C47AFF; /* Purple */
            --text-color: #333333;
            --text-secondary: #5271ff;
            --border-radius: 16px;
            --box-shadow: 0 6px 16px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--primary-color);
            color: var(--text-color);
            min-height: 100vh;
            height: auto;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding-top: 60px;
        }

        /* Header Styles */
        header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: linear-gradient(to right, var(--accent-color-5), var(--accent-color-6));
            border-bottom: none;
            box-shadow: var(--box-shadow);
            z-index: 1000;
        }

        .logo-container {
            color: white;
            text-decoration: none; 
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: bold;
            font-size: 1.25rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .paw-icon {
            width: 28px;
            height: 28px;
            vertical-align: middle;
            margin-right: 4px;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
        }

        /* Voice toggle switch styles */
        .voice-toggle-container {
            display: flex;
            align-items: center;
            gap: 8px;
            color: white;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 46px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255,255,255,0.3);
            transition: .4s;
            border: 1px solid white;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: var(--accent-color-3);
            border-color: var(--accent-color-3);
        }

        input:checked + .slider:before {
            background-color: white;
            transform: translateX(22px);
        }

        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        /* Main Conversation Area */
        .conversation-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            margin-top: 60px;
            margin-bottom: 70px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: 0;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            width: 100%;
        }

        /* Initial State Styles */
        .initial-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 2rem;
            padding: 1rem;
            text-align: center;
        }

        .puppy-icon {
            width: 120px;
            height: 120px;
            margin-bottom: 1rem;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
        }

        .greeting {
            font-size: 2rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-weight: 800;
        }

        .assistant-intro {
            max-width: 600px;
            line-height: 1.6;
            margin-bottom: 1.5rem;
            font-size: 1.1rem;
        }

        /* User input container */
        .user-input-container {
            display: flex;
            gap: 0.5rem;
            width: 100%;
            max-width: 600px;
            margin-bottom: 1rem;
        }

        /* Upload area */
        .upload-zone {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(240,246,255,0.7));
            border: 3px dashed var(--accent-color-5);
            border-radius: var(--border-radius);
            padding: 2rem;
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 2rem;
            box-shadow: var(--box-shadow);
        }

        .upload-zone:hover {
            border-color: var(--accent-color-4);
            transform: translateY(-5px);
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(230,240,255,0.8));
        }

        .upload-icon {
            width: 60px;
            height: 60px;
            margin-bottom: 1rem;
            color: var(--accent-color-6);
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .upload-text {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            background: linear-gradient(to right, var(--accent-color-1), var(--accent-color-6));
            -webkit-background-clip: text;
            color: transparent;
        }

        .upload-subtext {
            font-size: 0.9rem;
            color: var(--text-color);
        }

        /* Message Styles */
        .message {
            max-width: 80%;
            padding: 1.25rem 1.5rem;
            border-radius: var(--border-radius);
            word-wrap: break-word;
            white-space: normal;
            line-height: 1.6;
            box-shadow: var(--box-shadow);
        }
        
        .message.user {
            background: linear-gradient(135deg, var(--accent-color-5), var(--accent-color-6));
            align-self: flex-end;
            border-bottom-right-radius: 4px;
            color: white;
        }

        .message.assistant {
            background: white;
            align-self: flex-start;
            border-radius: var(--border-radius);
            border-bottom-left-radius: 4px;
            border-left: 4px solid var(--accent-color-4);
        }

        .message img.uploaded-photo {
            max-width: 100%;
            border-radius: 12px;
            margin-top: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Input container styling */
        .input-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            background: white;
            display: flex;
            gap: 0.5rem;
            border-top: none;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            z-index: 1000;
            border-radius: 16px 16px 0 0;
        }

        .message-input {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius);
            border: 2px solid var(--accent-color-5);
            background: white;
            color: var(--text-color);
            font-size: 1rem;
            transition: all 0.2s;
        }

        .message-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(92, 225, 230, 0.3);
        }

        .image-upload-button {
            background: var(--accent-color-4);
            border: none;
            border-radius: var(--border-radius);
            padding: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            color: white;
        }

        .image-upload-button:hover {
            background: var(--accent-color-3);
            transform: translateY(-2px);
        }

        .image-upload-button svg {
            width: 24px;
            height: 24px;
        }

        .send-button {
            padding: 0.75rem;
            background: var(--accent-color-6);
            border: none;
            border-radius: var(--border-radius);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-button:hover {
            background: var(--text-secondary);
            transform: translateY(-2px);
        }

        .send-button svg {
            width: 24px;
            height: 24px;
        }

        /* Recent uploads gallery */
        .recent-uploads {
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto;
            gap: 12px;
            padding: 15px;
            background: linear-gradient(to right, rgba(255, 189, 89, 0.1), rgba(89, 255, 142, 0.1));
            border-radius: 12px;
            margin-top: 20px;
            margin-bottom: 10px;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color-3) white;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
        }

        .thumbnail {
            min-width: 85px;
            height: 85px;
            border-radius: 10px;
            object-fit: cover;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
            border: 3px solid white;
        }

        .thumbnail:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .thumbnail.active {
            border: 3px solid var(--accent-color-6);
        }

        /* Cute Meter */
        .cuteness-meter {
            margin-top: 15px;
            background: linear-gradient(to right, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            backdrop-filter: blur(5px);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--box-shadow);
            border-left: 4px solid var(--accent-color-3);
        }

        .meter-title {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .meter-value {
            font-size: 1.2rem;
            color: var(--accent-color-6);
            font-weight: 800;
        }

        .meter-bar {
            height: 12px;
            background: #f0f0f0;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .meter-fill {
            height: 100%;
            background: linear-gradient(to right, 
                var(--accent-color-1), 
                var(--accent-color-2),
                var(--accent-color-3),
                var(--accent-color-4),
                var(--accent-color-5),
                var(--accent-color-6));
            border-radius: 6px;
            transition: width 1s ease-in-out;
        }

        .cuteness-traits {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .trait-tag {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            white-space: nowrap;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Loading indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 1rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .dot {
            width: 8px;
            height: 8px;
            background: var(--accent-color-5);
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        .dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .uploaded-image-preview {
            max-width: 150px;
            max-height: 150px;
            border-radius: 12px;
            margin-top: 8px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .drag-over {
            background-color: rgba(255, 158, 128, 0.15);
            transform: scale(1.02);
        }

        /* Audio player styles */
        .audio-container {
            margin-top: 15px;
            width: 100%;
            max-width: 300px;
            position: relative;
        }

        .audio-player {
            width: 100%;
            height: 36px;
            opacity: 0.8;
            transition: opacity 0.2s;
            border-radius: 18px;
            background: rgba(76, 175, 80, 0.1);
        }

        .audio-player:hover {
            opacity: 1;
        }

        .audio-loading {
            font-size: 0.8rem;
            color: var(--accent-color-6);
            margin-bottom: 5px;
            font-style: italic;
        }

        .voice-indicator {
            font-size: 0.8rem;
            color: var(--accent-color-4);
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .voice-indicator:before {
            content: '';
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--accent-color-4);
            animation: pulse 1.5s infinite;
        }
        
        /* Audio replay button styles */
        .audio-replay-btn {
          display: flex;
          align-items: center;
          justify-content: center;
          position: absolute;
          bottom: -12px;
          right: 10px;
          width: 24px;
          height: 24px;
          background: var(--accent-color-4);
          border-radius: 50%;
          border: none;
          cursor: pointer;
          box-shadow: 0 2px 5px rgba(0,0,0,0.2);
          transition: all 0.2s ease;
          opacity: 0.8;
          z-index: 5;
        }

        .audio-replay-btn:hover {
          transform: scale(1.1);
          opacity: 1;
        }

        .audio-replay-btn svg {
          width: 14px;
          height: 14px;
          color: white;
        }

        .message.assistant {
          position: relative;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .message {
                max-width: 85%;
            }
            
            .upload-zone {
                padding: 1.5rem;
            }
            
            .greeting {
                font-size: 1.75rem;
            }
            
            .assistant-intro {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo-container">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="paw-icon" fill="currentColor">
                <path d="M256 224c-79.5 0-144 64.5-144 144s64.5 144 144 144 144-64.5 144-144-64.5-144-144-144zm0 240c-52.9 0-96-43.1-96-96s43.1-96 96-96 96 43.1 96 96-43.1 96-96 96zm143.8-295.2c0-33.8-27.4-61.2-61.2-61.2-16.8 0-32.1 6.8-43.2 17.8-10.8 10.7-17.8 25.4-17.8 41.3 0 7.8 6.3 14.1 14.1 14.1s14.1-6.3 14.1-14.1c0-7 2.7-13.3 7.1-18 4.4-4.4 10.6-7.1 17.8-7.1 13.9 0 25.1 11.3 25.1 25.1 0 13.9-11.3 25.1-25.1 25.1-7.8 0-14.1 6.3-14.1 14.1s6.3 14.1 14.1 14.1c33.8 0 61.2-27.4 61.2-61.2zm-184.8-61.2c-33.8 0-61.2 27.4-61.2 61.2 0 33.8 27.4 61.2 61.2 61.2 7.8 0 14.1-6.3 14.1-14.1s-6.3-14.1-14.1-14.1c-13.9 0-25.1-11.3-25.1-25.1 0-13.9 11.3-25.1 25.1-25.1 7 0 13.3 2.7 18 7.1 4.4 4.4 7.1 10.6 7.1 18 0 7.8 6.3 14.1 14.1 14.1s14.1-6.3 14.1-14.1c0-16.8-6.8-32.1-17.8-43.2-11.2-10.8-26.5-17.7-43.3-17.7zm90.9 59.4c0-20.3-20.7-32.1-41-14.1-20.3-18-41 0-41 17.4 0 20.3 16.9 37.1 37.2 37.1 20.3 0 44.8-9.1 44.8-40.4zm-17.9 13.4a20.3 20.3 0 1 1-40.6 0 20.3 20.3 0 0 1 40.6 0zM90.8 228.8C56.9 228.8 29.6 256.2 29.6 290s27.4 61.2 61.2 61.2c33.8 0 61.2-27.4 61.2-61.2s-27.4-61.2-61.2-61.2zm0 98.5c-20.6 0-37.2-16.6-37.2-37.2s16.6-37.2 37.2-37.2S128 269.5 128 290s-16.6 37.3-37.2 37.3z"/>
            </svg>
            Puppy Cuteness Meter
        </div>
        <div class="voice-toggle-container">
            <span>Voice</span>
            <label class="switch">
                <input type="checkbox" id="voice-toggle" checked>
                <span class="slider round"></span>
            </label>
        </div>
    </header>    
    <div class="conversation-container" id="conversation-container">
        <div class="initial-state" id="initial-state">                
            <div>
                <img src="https://cdn.pixabay.com/photo/2016/12/13/05/15/puppy-1903313_960_720.png" alt="Cute puppy illustration" class="puppy-icon">
                <h2 class="greeting">Puppy Cuteness Meter</h2>
                <p class="assistant-intro">Upload photos of your puppies and our AI assistant will measure their cuteness score, identify adorable features, and let you compare how cute your puppies are. Perfect for celebrating your furry friends' irresistible charm!</p>
            </div>

            <div class="user-input-container">
                <input type="text" class="message-input" placeholder="Ask a question..." id="initial-message-input" onkeydown="if(event.key === 'Enter') sendMessageFromInitialState()">
                
                <button class="image-upload-button" id="initial-image-upload-button" title="Upload an image">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                </button>
                <input type="file" id="initial-file-input" accept="image/*" style="display: none;">
                
                <button class="send-button" onclick="sendMessageFromInitialState()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>

            <!-- Add image preview container -->
            <div id="initial-image-preview-container" style="max-width: 300px; margin: 10px auto; display: none;"></div>
            
            <div class="upload-zone" id="upload-zone">
                <svg class="upload-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <p class="upload-text">Upload a puppy photo</p>
                <p class="upload-subtext">or drag and drop here</p>
            </div>
        </div>
        
        <!-- This will hold the recent uploads thumbnails -->
        <div class="recent-uploads" id="recent-uploads" style="display: none;">
            <!-- Thumbnails will be added here dynamically -->
        </div>
    </div>

    <div class="input-container" id="question-input" style="display: none;">
        <input type="text" class="message-input" placeholder="Ask about this puppy..." id="message-input">

        <button class="image-upload-button" id="image-upload-button" title="Upload a puppy photo">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                <polyline points="21 15 16 10 5 21"></polyline>
            </svg>
        </button>
        <input type="file" id="file-input" accept="image/*" style="display: none;">
        
        <button class="send-button" id="send-button">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        </button>
    </div>

    <script>
        let conversationHistory = [];
        let currentImageData = null;
        let imagePreviewElement = null;
        let recentUploads = [];
        let voiceEnabled = true;
        let currentlyPlayingAudio = null;
        
        // Color assignments for traits
        const colorList = [
            'var(--accent-color-1)',
            'var(--accent-color-2)',
            'var(--accent-color-3)',
            'var(--accent-color-4)',
            'var(--accent-color-5)',
            'var(--accent-color-6)'
        ];
        
        // State management
        let state = {
            messages: [],
            controller: null,
            isLoading: false,
            systemPrompt: "You are a Puppy Cuteness Meter assistant. Your job is to analyze puppy photos with enthusiasm and positivity. When a user uploads a puppy image: 1) Comment on specific visible features (fur color, eyes, ears, size, breed if recognizable) 2) Rate cuteness on a scale of 85-100 (all puppies are cute!) 3) List 3-5 cute traits you notice by starting with 'Cute Traits:' and then listing them with bullets or commas 4) Be playful and warm in your tone. If the image doesn't contain a puppy, kindly ask for a puppy photo instead. Always format your response to include a Cuteness Rating: [NUMBER] that can be easily parsed. Sign responses as 'Puppy Cuteness Meter ðŸ¾'"
        };

        // DOM Elements
        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');
        const initialFileInput = document.getElementById('initial-file-input');
        const conversationContainer = document.getElementById('conversation-container');
        const initialState = document.getElementById('initial-state');
        const questionInput = document.getElementById('question-input');
        const messageInput = document.getElementById('message-input');
        const initialMessageInput = document.getElementById('initial-message-input');
        const sendButton = document.getElementById('send-button');
        const imageUploadButton = document.getElementById('image-upload-button');
        const initialImageUploadButton = document.getElementById('initial-image-upload-button');
        const recentUploadsContainer = document.getElementById('recent-uploads');
        const voiceToggle = document.getElementById('voice-toggle');

        // Set up voice toggle
        voiceToggle.addEventListener('change', function() {
            voiceEnabled = this.checked;
            
            // Stop audio playback when toggled off
            if (!voiceEnabled && currentlyPlayingAudio) {
                currentlyPlayingAudio.pause();
                currentlyPlayingAudio.currentTime = 0;
                currentlyPlayingAudio = null;
            }
            
            // Update visibility of all replay buttons
            document.querySelectorAll('.audio-replay-btn').forEach(btn => {
                btn.style.display = this.checked ? 'flex' : 'none';
            });
            
            saveVoicePreference(this.checked);
        });

        // Load voice preference from localStorage
        function loadVoicePreference() {
            const savedPreference = localStorage.getItem('voiceEnabled');
            if (savedPreference !== null) {
                voiceEnabled = savedPreference === 'true';
                voiceToggle.checked = voiceEnabled;
            }
        }

        // Save voice preference to localStorage
        function saveVoicePreference(enabled) {
            localStorage.setItem('voiceEnabled', enabled);
            voiceEnabled = enabled;
        }

        // Create cuteness meter
        function createCutenessMeter(score, traits) {
            const meterDiv = document.createElement('div');
            meterDiv.className = 'cuteness-meter';
            
            const meterTitle = document.createElement('div');
            meterTitle.className = 'meter-title';
            meterTitle.innerHTML = `Cuteness Rating <span class="meter-value">${score}/100</span>`;
            
            const meterBar = document.createElement('div');
            meterBar.className = 'meter-bar';
            
            const meterFill = document.createElement('div');
            meterFill.className = 'meter-fill';
            meterFill.style.width = '0%'; // Start at 0 for animation
            meterBar.appendChild(meterFill);
            
            const traitsDiv = document.createElement('div');
            traitsDiv.className = 'cuteness-traits';
            
            // Create colorful trait tags
            traits.forEach((trait, index) => {
                const traitTag = document.createElement('span');
                traitTag.className = 'trait-tag';
                traitTag.textContent = trait;
                
                // Cycle through colors for each trait
                const colorIndex = index % colorList.length;
                traitTag.style.backgroundColor = colorList[colorIndex];
                
                traitsDiv.appendChild(traitTag);
            });
            
            meterDiv.appendChild(meterTitle);
            meterDiv.appendChild(meterBar);
            meterDiv.appendChild(traitsDiv);
            
            // Animate the meter fill after a short delay
            setTimeout(() => {
                meterFill.style.width = `${score}%`;
            }, 300);
            
            return meterDiv;
        }

        // Add to recent uploads
        function addToRecentUploads(dataUrl) {
            recentUploads.unshift({
                dataUrl: dataUrl,
                base64: dataUrl.split(',')[1],
                timestamp: new Date().getTime()
            });
            
            // Limit to 10 recent uploads
            if (recentUploads.length > 10) {
                recentUploads.pop();
            }
            
            // Update the UI
            updateRecentUploadsUI();
            
            // Show the recent uploads section
            recentUploadsContainer.style.display = 'flex';
        }

        // Update recent uploads UI
        function updateRecentUploadsUI() {
            recentUploadsContainer.innerHTML = '';
            
            recentUploads.forEach((upload) => {
                const thumbnail = document.createElement('img');
                thumbnail.src = upload.dataUrl;
                thumbnail.className = 'thumbnail';
                
                if (upload.base64 === currentImageData) {
                    thumbnail.classList.add('active');
                }
                
                thumbnail.addEventListener('click', () => {
                    currentImageData = upload.base64;
                    sendQuestion("What do you think of this puppy?");
                    
                    // Update active state
                    document.querySelectorAll('.thumbnail').forEach(thumb => {
                        thumb.classList.remove('active');
                    });
                    thumbnail.classList.add('active');
                });
                
                recentUploadsContainer.appendChild(thumbnail);
            });
        }

        // Get readable text from HTML
        function getReadableText(htmlContent) {
            // Create a temporary div to parse the HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            
            // Get paragraphs and list items
            const paragraphs = tempDiv.querySelectorAll('p');
            const listItems = tempDiv.querySelectorAll('li');
            
            let text = '';
            
            // Process paragraphs (up to first 3-4)
            if (paragraphs.length) {
                const maxParagraphs = Math.min(paragraphs.length, 3);
                for (let i = 0; i < maxParagraphs; i++) {
                    text += paragraphs[i].textContent + ' ';
                }
            }
            
            // If we didn't get anything from paragraphs or lists, fall back to full text
            if (!text) {
                text = tempDiv.textContent;
            }
            
            // Clean up the text
            return text.trim();
        }
        
        // Generate audio from text
        async function generateAudio(text) {
            try {
                // Create a direct instruction to read verbatim
                const instructionPrefix = "READ THIS TEXT VERBATIM WITHOUT ANY COMMENTARY OR RESPONSE: ";
                const textToRead = instructionPrefix + text;
                const encodedText = encodeURIComponent(textToRead);
                const url = `https://text.pollinations.ai/${encodedText}?model=openai-audio&voice=nova`;
                return url;
            } catch (error) {
                console.error("Audio generation error:", error);
                return null;
            }
        }
        
        // Function to play audio directly
        async function generateAndPlayAudio(text) {
            try {
                // Get the audio URL
                const audioUrl = await generateAudio(text);
                if (!audioUrl) return false;
                
                // Create and play audio directly
                const audio = new Audio(audioUrl);
                
                // Store reference to current audio
                currentlyPlayingAudio = audio;
                
                await audio.play();
                
                // Clear reference when audio finishes naturally
                audio.onended = function() {
                    currentlyPlayingAudio = null;
                };
                
                return true;
            } catch (error) {
                console.error("Audio playback error:", error);
                currentlyPlayingAudio = null;
                return false;
            }
        }

        // Process the image file - IMPORTANT FOR DIRECT FILE UPLOADS
        function processImageFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const base64Image = e.target.result.split(',')[1]; // Remove the data URL part
                currentImageData = base64Image;
                
                // Store in recent uploads
                addToRecentUploads(e.target.result);
                
                // Show image preview if in chat mode
                if (initialState.style.display === 'none') {
                    showImagePreview(e.target.result);
                }
            };
            
            reader.readAsDataURL(file);
        }

        // Process initial image file
        function processInitialImageFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const base64Image = e.target.result.split(',')[1];
                currentImageData = base64Image;
                
                // Show image preview
                const previewContainer = document.getElementById('initial-image-preview-container');
                previewContainer.style.display = 'block';
                previewContainer.innerHTML = '';
                
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'uploaded-image-preview';
                img.title = 'Click to remove image';
                img.onclick = () => {
                    currentImageData = null;
                    previewContainer.style.display = 'none';
                    previewContainer.innerHTML = '';
                };
                
                previewContainer.appendChild(img);
            };
            
            reader.readAsDataURL(file);
        }
        
        // Show image preview next to input
        function showImagePreview(dataUrl) {
            // Remove existing preview if any
            if (imagePreviewElement) {
                imagePreviewElement.remove();
            }
            
            // Create preview element
            imagePreviewElement = document.createElement('img');
            imagePreviewElement.src = dataUrl;
            imagePreviewElement.className = 'uploaded-image-preview';
            imagePreviewElement.title = "Click to remove image";
            
            imagePreviewElement.onclick = () => {
                currentImageData = null;
                imagePreviewElement.remove();
                imagePreviewElement = null;
            };
            
            // Insert before input container
            questionInput.insertBefore(imagePreviewElement, messageInput);
        }

        // Switch to Assistant Mode
        function switchToAssistantMode() {
            if (initialState) {
                initialState.style.display = 'none';
            }
            questionInput.style.display = 'flex';
            messageInput.focus();
        }

        // Add Message to Conversation
        async function addMessage(content, role) {
            const message = document.createElement('div');
            message.classList.add('message', role);
            
            if (role === 'assistant') {
                // Process for cuteness information
                let processedContent = content;
                
                // Parse the content for cuteness score and traits
                const scoreMatch = content.match(/Cuteness Rating:?\s*(\d+)/i);
                const traitsMatch = content.match(/Cute Traits:([^]*?)(?=\n\n|\n$|$)/is);
                
                let score = 0;
                let traits = [];
                
                if (scoreMatch && scoreMatch[1]) {
                    score = parseInt(scoreMatch[1], 10);
                }
                
                if (traitsMatch && traitsMatch[1]) {
                    // Extract traits from the matching content
                    traits = traitsMatch[1].split(/[,â€¢\n-]/)
                        .map(trait => trait.trim())
                        .filter(trait => trait.length > 0 && trait !== "-" && !trait.startsWith("Puppy"));
                }
                
                // Apply line breaks
                processedContent = processedContent.replace(/\n/g, '<br>');
                message.innerHTML = processedContent;
                
                // Add cuteness meter if score was found
                if (score > 0) {
                    const cutenessMeter = createCutenessMeter(score, traits);
                    message.appendChild(cutenessMeter);
                }
                
                // Extract readable text from the actual rendered HTML for audio
                let readableText = getReadableText(message.innerHTML);
                
                // Limit to a reasonable length (first 3-4 sentences)
                let sentences = readableText.split(/(?<=[.!?])\s+/).filter(s => s.trim().length > 5);
                let voiceText = sentences.slice(0, 4).join(' ');
                
                // Store the text for replay purposes
                message.dataset.voiceText = voiceText;
                
                // Add audio player if voice is enabled
                if (voiceEnabled) {
                    // Add voice marker
                    const voiceMarker = document.createElement('div');
                    voiceMarker.className = 'voice-indicator';
                    voiceMarker.innerHTML = '<span>Preparing voice...</span>';
                    message.appendChild(voiceMarker);
                    
                    // Use the streaming audio function directly
                    generateAndPlayAudio(voiceText).then(success => {
                        if (success) {
                            voiceMarker.remove(); // Remove when done playing
                        } else {
                            voiceMarker.innerHTML = '<span>Voice generation failed</span>';
                        }
                    });
                    
                    // Add the replay button
                    const replayButton = document.createElement('button');
                    replayButton.className = 'audio-replay-btn';
                    replayButton.title = 'Replay audio';
                    replayButton.innerHTML = `
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polygon points="5 3 19 12 5 21 5 3"></polygon>
                      </svg>
                    `;
                    replayButton.onclick = function() {
                        // Stop any currently playing audio
                        if (currentlyPlayingAudio) {
                            currentlyPlayingAudio.pause();
                            currentlyPlayingAudio.currentTime = 0;
                            currentlyPlayingAudio = null;
                        }
                        
                        // Play this message's audio
                        generateAndPlayAudio(message.dataset.voiceText);
                    };
                    
                    message.appendChild(replayButton);
                }
            } else {
                // For user messages
                message.textContent = content;
                
                // If there's an image, add it
                if (currentImageData && role === 'user') {
                    const img = document.createElement('img');
                    img.src = `data:image/jpeg;base64,${currentImageData}`;
                    img.className = 'uploaded-photo';
                    img.alt = 'Uploaded puppy photo';
                    message.appendChild(img);
                }
            }
            
            conversationContainer.appendChild(message);
            conversationContainer.scrollTop = conversationContainer.scrollHeight;
            state.messages.push({ role, content });
        }

        // Add loading indicator
        function addLoadingIndicator() {
            const loadingDiv = document.createElement('div');
            loadingDiv.classList.add('message', 'assistant', 'loading');
            loadingDiv.innerHTML = `
                <div class="typing-indicator">
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            `;
            conversationContainer.appendChild(loadingDiv);
            conversationContainer.scrollTop = conversationContainer.scrollHeight;
            return loadingDiv;
        }

        // Analyze image using AI
        async function analyzeImage(base64Image) {
            // We need a format that works with the text generation API
            const requestBody = {
                "model": "openai-large",
                "messages": [
                    {
                        "role": "system",
                        "content": state.systemPrompt
                    },
                    {
                        "role": "user",
                        "content": [
                            {
                                "type": "text",
                                "text": "What do you think of this puppy? Please analyze its cuteness level."
                            },
                            {
                                "type": "image_url",
                                "image_url": {
                                    "url": `data:image/jpeg;base64,${base64Image}`
                                }
                            }
                        ]
                    }
                ]
            };

            try {
                const response = await fetch('https://text.pollinations.ai/', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error('Failed to analyze image');
                }

                const responseData = await response.json();
                const analysisText = responseData.choices?.[0]?.message?.content || '';
                
                return analysisText;
            } catch (error) {
                console.error('Image analysis error:', error);
                throw error;
            }
        }

        // Send message from initial state
        function sendMessageFromInitialState() {
            let inputField = initialMessageInput;
            let userMessage = inputField.value.trim();
            
            // If there's no text but there is an image, use a default prompt
            if (userMessage === "" && !currentImageData) return; // Prevent empty messages with no image
            
            // Hide initial state & show chat UI
            switchToAssistantMode();
            
            // Clear input field
            inputField.value = "";
            
            // Send the message
            sendQuestion(userMessage);
        }

        // Send Question to API
        async function sendQuestion(content) {
            if ((!content.trim() && !currentImageData) || state.isLoading) return;

            // Cancel any existing request
            if (state.controller) {
                state.controller.abort();
            }
            
            state.isLoading = true;

            // Create new AbortController for this request
            state.controller = new AbortController();

            try {
                // Prepare messages
                let messages = [
                    {
                        role: 'system',
                        content: state.systemPrompt
                    }
                ];
                
                // Add previous messages from history
                state.messages.forEach(msg => {
                    messages.push({
                        role: msg.role,
                        content: msg.content
                    });
                });
                
                // Add current user message, possibly with image
                if (currentImageData) {
                    // Create a message with both text and image
                    const userMessage = {
                        role: 'user',
                        content: [
                            { 
                                type: 'text', 
                                text: content.trim() ? content : "What do you think of this puppy?"
                            },
                            { 
                                type: 'image_url', 
                                image_url: { 
                                    url: `data:image/jpeg;base64,${currentImageData}` 
                                } 
                            }
                        ]
                    };
                    
                    messages.push(userMessage);
                    
                    // Display the message to the user (text only)
                    addMessage(userMessage.content[0].text, 'user');
                } else {
                    // Text-only message
                    messages.push({
                        role: 'user',
                        content: content
                    });
                    
                    // Display the message
                    addMessage(content, 'user');
                }
                
                // Clear input field
                messageInput.value = '';
                
                // Show loading indicator
                const loadingIndicator = addLoadingIndicator();

                // Use direct image analysis for first message with an image
                let responseText;
                if (currentImageData && state.messages.length <= 2) {
                    responseText = await analyzeImage(currentImageData);
                } else {
                    // Use standard API for follow-up conversations
                    const response = await fetch('https://text.pollinations.ai/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            messages: messages,
                            seed: Math.floor(Math.random() * 1000000),
                            model: 'openai-large',
                            jsonMode: false
                        }),
                        signal: state.controller.signal
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    responseText = await response.text();
                }

                // Remove loading indicator
                loadingIndicator.remove();

                // Add the response to the conversation
                addMessage(responseText, 'assistant');
                
                // Add assistant response to history
                state.messages.push({
                    role: 'assistant',
                    content: responseText
                });
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('Request was cancelled');
                } else {
                    console.error('Error:', error);
                    
                    // Remove loading indicator if it exists
                    const loadingIndicator = document.querySelector('.message.loading');
                    if (loadingIndicator) {
                        loadingIndicator.remove();
                    }
                    
                    addMessage('Sorry, I had trouble analyzing that image. Please try again or upload a different puppy photo. Puppy Cuteness Meter ðŸ¾', 'assistant');
                }
            } finally {
                state.controller = null;
                state.isLoading = false;
                messageInput.focus();
            }
        }

        // Setup event handlers for pasting images - THIS IS CRITICAL FOR PASTING IMAGES
        function setupPastingImages() {
            // Initial state input field
            initialMessageInput.addEventListener('paste', (event) => {
                const items = (event.clipboardData || event.originalEvent.clipboardData).items;
                
                for (const item of items) {
                    if (item.type.indexOf('image') === 0) {
                        const blob = item.getAsFile();
                        processInitialImageFile(blob);
                        event.preventDefault();
                        return;
                    }
                }
            });
            
            // Chat UI input field
            messageInput.addEventListener('paste', (event) => {
                const items = (event.clipboardData || event.originalEvent.clipboardData).items;
                
                for (const item of items) {
                    if (item.type.indexOf('image') === 0) {
                        const blob = item.getAsFile();
                        processImageFile(blob);
                        event.preventDefault();
                        return;
                    }
                }
            });
            
            // Initial state drag and drop
            initialState.addEventListener('dragover', (e) => {
                e.preventDefault();
                initialState.classList.add('drag-over');
            });
            
            initialState.addEventListener('dragleave', () => {
                initialState.classList.remove('drag-over');
            });
            
            initialState.addEventListener('drop', (e) => {
                e.preventDefault();
                initialState.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    processInitialImageFile(files[0]);
                }
            });
            
            // Chat UI drag and drop
            conversationContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                conversationContainer.classList.add('drag-over');
            });
            
            conversationContainer.addEventListener('dragleave', () => {
                conversationContainer.classList.remove('drag-over');
            });
            
            conversationContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                conversationContainer.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    processImageFile(files[0]);
                }
            });
        }

        // Event listeners
        uploadZone.addEventListener('click', () => {
            initialFileInput.click();
        });

        initialFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file && file.type.match('image.*')) {
                processInitialImageFile(file);
            }
        });

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file && file.type.match('image.*')) {
                processImageFile(file);
            }
        });

        initialImageUploadButton.addEventListener('click', () => {
            initialFileInput.click();
        });

        imageUploadButton.addEventListener('click', () => {
            fileInput.click();
        });

        sendButton.addEventListener('click', () => {
            if (messageInput.value.trim() || currentImageData) {
                sendQuestion(messageInput.value);
            }
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && (messageInput.value.trim() || currentImageData)) {
                sendQuestion(messageInput.value);
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved voice preference
            loadVoicePreference();
            
            // Setup image pasting
            setupPastingImages();
        });

        // Handle window events
        window.addEventListener('beforeunload', () => {
            if (state.controller) {
                state.controller.abort();
            }
        });

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden' && state.controller) {
                state.controller.abort();
            }
        });
    </script>
</body>
</html>	
