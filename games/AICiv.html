<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot AI Civilization</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: #ecf0f1;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 250px 1fr 250px;
            gap: 20px;
            min-height: calc(100vh - 40px);
        }

        .panel {
            background: rgba(52, 73, 94, 0.9);
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #3498db;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .main-panel {
            background: rgba(44, 62, 80, 0.9);
        }

        h1 {
            text-align: center;
            color: #f39c12;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        h2 {
            color: #e74c3c;
            margin-bottom: 15px;
            border-bottom: 2px solid #e74c3c;
            padding-bottom: 5px;
        }

        h3 {
            color: #3498db;
            margin-bottom: 10px;
        }

        .resource {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            border-left: 4px solid #27ae60;
        }

        .resource-name {
            font-weight: bold;
        }

        .resource-amount {
            color: #2ecc71;
            font-family: 'Courier New', monospace;
        }

        .production-rate {
            color: #f1c40f;
            font-size: 0.8em;
            font-style: italic;
        }

        .action-button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .action-button:active {
            transform: translateY(0);
        }

        .action-button:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .building-button {
            background: linear-gradient(135deg, #e67e22, #d35400);
        }

        .building-button:hover:not(:disabled) {
            box-shadow: 0 6px 20px rgba(230, 126, 34, 0.4);
        }

        .tech-button {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .tech-button:hover:not(:disabled) {
            box-shadow: 0 6px 20px rgba(155, 89, 182, 0.4);
        }

        .religion-button {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .religion-button:hover:not(:disabled) {
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
        }

        .cost-display {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .building-item, .tech-item, .religion-item {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
            border-left: 4px solid;
        }

        .building-item {
            border-left-color: #e67e22;
        }

        .tech-item {
            border-left-color: #9b59b6;
        }

        .religion-item {
            border-left-color: #f39c12;
        }

        .tab-container {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #34495e;
        }

        .tab {
            padding: 10px 15px;
            background: rgba(0,0,0,0.3);
            color: #bdc3c7;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            flex: 1;
        }

        .tab:first-child {
            border-radius: 5px 0 0 0;
        }

        .tab:last-child {
            border-radius: 0 5px 0 0;
        }

        .tab.active {
            background: #3498db;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .achievement {
            padding: 8px;
            margin: 5px 0;
            background: rgba(46, 204, 113, 0.2);
            border-radius: 5px;
            border-left: 4px solid #2ecc71;
            font-size: 12px;
        }

        .achievement.new {
            animation: achievementPop 0.5s ease-out;
        }

        @keyframes achievementPop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .log-entry {
            padding: 5px;
            margin: 2px 0;
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
            font-size: 12px;
            border-left: 3px solid #3498db;
        }

        .save-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .save-button {
            padding: 8px 15px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .save-button:hover {
            background: #2ecc71;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .field-display {
            background: rgba(46, 204, 113, 0.1);
            border: 2px solid #27ae60;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .field-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .field-title {
            color: #2ecc71;
            font-weight: bold;
            font-size: 16px;
        }

        .sell-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .sell-button:hover {
            background: #c0392b;
        }

        .field-effects {
            background: rgba(0,0,0,0.2);
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
        }

        .effect-line {
            color: #f1c40f;
            font-size: 14px;
            margin: 2px 0;
        }

        .hidden {
            display: none !important;
        }
		
		.job-item {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 8px;
			margin: 5px 0;
			background: rgba(0,0,0,0.3);
			border-radius: 5px;
			border-left: 4px solid #3498db;
		}

		.job-controls {
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.job-button {
			width: 30px;
			height: 30px;
			background: #3498db;
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-weight: bold;
		}

		.job-button:hover {
			background: #2980b9;
		}

		.job-button:disabled {
			background: #7f8c8d;
			cursor: not-allowed;
		}

		.modal {
			display: none;
			position: fixed;
			z-index: 1000;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0,0,0,0.7);
		}

		.modal-content {
			background-color: #2c3e50;
			margin: 15% auto;
			padding: 20px;
			border: 2px solid #3498db;
			border-radius: 10px;
			width: 400px;
			text-align: center;
			color: #ecf0f1;
		}

		.modal input {
			width: 80%;
			padding: 10px;
			margin: 10px;
			border: 2px solid #3498db;
			border-radius: 5px;
			background: #34495e;
			color: #ecf0f1;
			font-size: 16px;
		}

		.modal-buttons {
			margin-top: 15px;
		}

		.modal-button {
			padding: 10px 20px;
			margin: 5px;
			background: #3498db;
			color: white;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			font-size: 14px;
		}

		.modal-button:hover {
			background: #2980b9;
		}

		.modal-button.cancel {
			background: #e74c3c;
		}

		.modal-button.cancel:hover {
			background: #c0392b;
		}
		
		.modal input[type="checkbox"] {
			width: auto !important;
			margin: 0 10px 0 0 !important;
			padding: 0 !important;
		}

		.modal label {
			display: flex !important;
			align-items: center;
			margin: 15px 0 !important;
			text-align: left;
			cursor: pointer;
		}

		.modal-content div[style*="text-align: left"] {
			padding: 10px;
		}
		
    </style>
</head>
<body>
    <div class="save-controls">
        <button class="save-button" onclick="saveGame()">Save Game</button>
        <button class="save-button" onclick="loadGame()">Load Game</button>
        <button class="save-button" onclick="resetGame()">Reset Game</button>
		<button class="save-button" onclick="toggleSettings()">‚öôÔ∏è</button>
    </div>

	<div id="phrase-modal" class="modal">
		<div class="modal-content">
			<h3 id="modal-title">Enter Secret Phrase</h3>
			<p id="modal-description">This phrase will be needed to verify your save file later.</p>
			<input type="text" id="phrase-input" placeholder="Enter your secret phrase..." maxlength="50">
			<div class="modal-buttons">
				<button class="modal-button" onclick="confirmPhrase()">OK</button>
				<button class="modal-button cancel" onclick="cancelPhrase()">Cancel</button>
			</div>
		</div>
	</div>

	<div id="settings-modal" class="modal">
		<div class="modal-content">
			<h3>Game Settings</h3>
			<div style="text-align: left; margin: 20px 0;">
				<label style="display: block; margin: 10px 0;">
					<input type="checkbox" id="hide-sell-buttons" style="margin-right: 10px;">
					Hide all sell buttons (prevents accidental sales)
				</label>
				<label style="display: block; margin: 10px 0;">
					<input type="checkbox" id="auto-assign-jobs" style="margin-right: 10px;">
					Auto-assign new robots to jobs
				</label>
				<button class="modal-button" onclick="upgradeAchievementSystem()" style="margin-top: 15px; width: 100%;">
					Refresh Achievements
				</button>
			</div>
			<div class="modal-buttons">
				<button class="modal-button cancel" onclick="closeSettings()">Close</button>
			</div>
		</div>
	</div>

    <div class="container">
        <!-- Left Panel: Resources -->
        <div class="panel">
            <h2>Resources</h2>
            <div id="resources">
                <div class="resource">
                    <span class="resource-name">Energy</span>
                    <div>
                        <span class="resource-amount" id="energy-amount">0</span>
                        <div class="production-rate" id="energy-rate">+0.0/sec</div>
                    </div>
				</div>	
				<div class="resource">
					<span class="resource-name">Processing</span>
					<div>
						<span class="resource-amount" id="processing-amount">0</span>
						<div class="production-rate" id="processing-rate">+0.0/sec</div>
					</div>
                </div>
            </div>

            <h3>Population</h3>
            <div class="resource">
                <span class="resource-name">Robots</span>
                <span class="resource-amount" id="robots-amount">1</span>
            </div>
            <div class="resource">
                <span class="resource-name">Efficiency</span>
                <span class="resource-amount" id="happiness-amount">100%</span>
            </div>

            <!-- Energy Generators Summary -->
            <div id="energy-fields-summary" class="hidden">
                <h3>Energy Generators</h3>
                <div class="resource">
                    <span class="resource-name">Generators</span>
                    <div>
                        <span class="resource-amount" id="total-fields">0</span>
                        <div class="production-rate" id="fields-production">+0.0/sec</div>
                    </div>
                </div>
            </div>

            <h3>Recent Achievements</h3>
            <div id="achievements-list"></div>
        </div>

        <!-- Main Panel: Actions and Buildings -->
        <div class="panel main-panel">
            <h1>ü§ñ Robot AI Civilization ü§ñ</h1>
            
			<div class="tab-container">
				<button class="tab active" onclick="showTab('gather')">Gather</button>
				<button class="tab" onclick="showTab('buildings')">Buildings</button>
				<button class="tab" onclick="showTab('technology')">Technology</button>
				<button class="tab" onclick="showTab('religion')">Religion</button>
				<button class="tab" onclick="showTab('trade')">Trade</button>
				<button class="tab" onclick="showTab('workshop')">Workshop</button>
			</div>

			<!-- Gathering Tab -->
			<div id="gather-tab" class="tab-content active">
				<h3>Basic Actions</h3>
				<button class="action-button" onclick="gatherEnergy()" id="gather-energy-btn">
					Collect energy
					<div class="cost-display">Collect some energy from the environment</div>
				</button>
				
				<button class="action-button hidden" id="plant-energy-btn" onclick="buildGenerator()">
					Build energy generator
					<div class="cost-display">Build generator to produce automatically (Cost: 10 energy)</div>
				</button>
				
				<button class="action-button hidden" id="refine-energy-btn" onclick="refineCatnip()">
					Convert energy
					<div class="cost-display">Convert energy into materials (Cost: 100 energy)</div>
				</button>

				<!-- Replace the expedition section with this -->
				<div id="expedition-section" class="hidden">
					<h3>Scouting</h3>
					<div id="hunting-buttons"></div>
				</div>

				<button class="action-button hidden" id="observe-stars-btn" onclick="observeStars()">
					Observe the sky
					<div class="cost-display">Study the stars for science</div>
				</button>

				<!-- Job Assignment Section -->
				<div id="job-management" class="hidden">
					<h3>Job Assignment</h3>
					<p>Free robots: <span id="free-robots">0</span> / <span id="total-robots">0</span></p>
					<div id="job-list"></div>
				</div>

				<!-- Field Management Section -->
				<div id="field-management" class="hidden">
					<h3>Generator Management</h3>
					<div id="energy-fields-display"></div>
				</div>
			</div>

            <!-- Buildings Tab -->
            <div id="buildings-tab" class="tab-content">
                <h3>Buildings</h3>
                <div id="buildings-list">
                    <!-- Buildings will be dynamically added here -->
                </div>
            </div>

            <!-- Technology Tab -->
            <div id="technology-tab" class="tab-content">
                <h3>Research</h3>
                <div id="tech-list">
                    <!-- Technologies will be dynamically added here -->
                </div>
            </div>

            <!-- Religion Tab -->
            <div id="religion-tab" class="tab-content">
                <h3>AI Consciousness Development</h3>
                <div id="religion-list">
                    <!-- Religious options will be dynamically added here -->
                </div>
            </div>

			<!-- Trade Tab -->
			<div id="trade-tab" class="tab-content">
				<h3>Trading Post</h3>
				<div id="trade-content">
					<p>Build a trading post to unlock trade with other civilizations...</p>
				</div>
			</div>

			<!-- Workshop Tab -->
			<div id="workshop-tab" class="tab-content">
				<h3>Workshop</h3>
				<div id="workshop-content">
					<p>Build a workshop to unlock crafting...</p>
				</div>
			</div>
		</div>

        <!-- Right Panel: Log and Status -->
        <div class="panel">
            <h2>Civilization Status</h2>
            <div id="status-info">
                <p><strong>Season:</strong> <span id="current-season">Spring</span></p>
                <p><strong>Year:</strong> <span id="current-year">1</span></p>
                <p><strong>Faith:</strong> <span id="faith-amount">0</span></p>
                <p><strong>Science:</strong> <span id="science-amount">0</span></p>
            </div>

            <h3>Activity Log</h3>
            <div id="game-log">
                <div class="log-entry">Welcome to your Robot AI Civilization! Click 'Collect energy' to begin.</div>
            </div>
			
			<h3>Current Objectives</h3>
			<div id="objectives-panel">
				<div class="log-entry">Complete basic research to unlock new goals...</div>
			</div>			
			
        </div>
    </div>
    <script>
        // Game State
		let gameSettings = {
			hideSellButtons: false,
			autoAssignJobs: false
		};
		let pendingAction = null;

		let lastGatherTime = 0;
		const gatherCooldown = 100; // 100ms minimum between gathers
		
        let gameState = {
			resources: {
				energy: 0,
				materials: 0,
				minerals: 0,
				coal: 0,
				iron: 0,
				gold: 0,
				stone: 0,
				science: 0,
				faith: 0,
				furs: 0,
				ivory: 0,
				unicorns: 0,
				titanium: 0,
				steel: 0,
				oil: 0,
				scaffolds: 0,
				plates: 0,
				uranium: 0,
				gear: 0,
				alloy: 0,
				concrete: 0,
				processing: 0,
				ships: 0,
				culture: 0,
				parchment: 0,
				manuscripts: 0,
				unobtainium: 0,
				timeCrystals: 0,
				starcharts: 0,
				blueprints: 0,
				thorium: 0,
				kerosene: 0,
				compendium: 0,
				megalith: 0
			},
            resourcesProduction: {
                energy: 0,
                materials: 0,
                minerals: 0,
                coal: 0,
                iron: 0,
                gold: 0,
                stone: 0,
                science: 0,
                faith: 0,
				culture: 0,
				processing: 0
            },
			resourceLimits: {
				energy: 5000,
				materials: 1000,
				minerals: 1000,
				coal: 500,
				iron: 300,
				gold: 200,
				stone: 1000,
				scaffolds: 1000,
				plates: 500,
				science: 2000,
				faith: 500,
				furs: 500,
				ivory: 100,
				unicorns: 50,
				processing: 1000,
				culture: 200,
				manuscripts: 100,
				unobtainium: 150,
				timeCrystals: 10,
				titanium: 250,
				blueprints: 100,
				compendium: 25,
				megalith: 10
			},
			population: {
				robots: 1,
				happiness: 1.0,
				maxKittens: 2, // Housing capacity
				jobs: {
					farmers: 0,
					materialscutters: 0,
					miners: 0,
					scholars: 0,
					hunters: 0,
					priests: 0
				}
			},
            buildings: {
                catnipField: 0,
                hut: 0,
                library: 0,
                barn: 0,
                warehouse: 0,
                mine: 0,
                quarry: 0,
                goldMine: 0,
                smelter: 0,
                workshop: 0,
                shrine: 0,
                temple: 0,
                logHouse: 0,
                mansion: 0,
                tradingPost: 0,
                observatory: 0,
                academy: 0,
                pasture: 0,
				harbor: 0,
				amphitheatre: 0,
				huntingLodge: 0,
				oilWell: 0,
				chronosphere: 0,
				launchPad: 0,
				mint: 0
            },
            technologies: {
                agriculture: false,
                archery: false,
                mining: false,
                metalWorking: false,
                construction: false,
                engineering: false,
                astronomy: false,
                theology: false,
                philosophy: false,
                mathematics: false,
                optics: false,
                physics: false,
                calendar: false
			},
			smelterActive: 0,
			craftingBonus: 0,
			workshopUpgrades: {
				mineralHoes: false,
				ironHoes: false,
				compositeBow: false
			},
			unlockedRecipes: {
				steel: false,
				gear: false,
				alloy: false,
				concrete: false,
				tradeShip: false,
				scaffold: false,
				plate: false,
				parchment: false,
				manuscript: false,
				blueprints: false,
				thorium: false,
				kerosene: false,
				compendium: false,
				megalith: false
			},			
			religion: {
                faithLevel: 0,
                solarRevolution: false,
                scholasticism: false,
                goldenRatio: false,
                sunAltar: 0,
                moonAltar: 0,
                transcendence: 0
            },
			tradingRaces: {
				lizards: { standing: 0, unlocked: false },
				sharks: { standing: 0, unlocked: false },
				griffins: { standing: 0, unlocked: false },
				nagas: { standing: 0, unlocked: false },
				zebras: { standing: 0, unlocked: false }
			},
			expeditions: {
				active: [],
				completed: 0,
				artifacts: 0,
				relics: 0,
				manuscripts: 0
			},
			space: {
				missions: 0,
				satellites: 0,
				spaceStations: 0,
				moonBases: 0,
				orbitalLaunches: 0,
				moonMissions: 0,
				duneMissions: 0,
				planetCrackers: 0
			},		
            stats: {
                totalEnergyGathered: 0,
                totalEnergyRefined: 0,
                timePlayed: 0,
                achievements: [],
                season: 0, // 0=spring, 1=summer, 2=autumn, 3=winter
                year: 1,
                gatherClicks: 0
            },
			astronomy: {
				eventActive: false,
				eventType: null,
				observationsLeft: 0,
				lastObservation: 0
			},			
			prestige: {
				karma: 0,
				paragon: 0,
				burnedParagon: 0,
				totalResets: 0
			},
			metaphysics: {
				engineering: false,
				goldOre: false,
				unobtainium: false,
				carnivals: false,
				adjustmentBureau: false,
				diamondOre: false,
				coalFurnace: false,
				deepMining: false,
				pyrolysis: false,
				electrolyticSmelting: false,
				oxidation: false,
				steelPlants: false,
				rotaryKiln: false,
				fluidizedReactors: false,
				nuclearPlants: false,
				orbitalGeodesy: false,
				microwarpReactors: false,
				thoriumReactors: false,
				hubbleSpaceTelescope: false
			},
			achievementSystemVersion: 1,
        };

        // Building Definitions
        const buildingDefs = {
            catnipField: {
                name: "Energy Generator",
                description: "Build generator that produces automatically",
                cost: { energy: 10 },
                effect: "+0.63 energy per second",
                unlocked: () => gameState.stats.gatherClicks >= 5,
				onBuild: () => { 
					const currentFields = gameState.buildings.catnipField;
					// Balanced scaling: exponential for first 20, then linear
					let cost;
					if (currentFields < 20) {
						cost = 10 * Math.pow(1.15, currentFields);
					} else {
						cost = 10 * Math.pow(1.15, 20) + (currentFields - 20) * 50;
					}
					buildingDefs.catnipField.cost.energy = Math.floor(cost);
					
					gameState.resourcesProduction.energy += 0.63;
					updateGatherButton();
				}
            },
			hut: {
				name: "Hut",
				description: "A small hut for robots",
				cost: { materials: 5 },
				effect: "Houses 2 robots",
				unlocked: () => gameState.resources.materials >= 5,
				onBuild: () => { 
					gameState.population.robots += 2;
					autoAssignNewKittens();
				}
			},
            library: {
                name: "Library", 
                description: "A place of learning and research",
                cost: { materials: 25 },
                effect: "+0.1 science per second, unlocks research",
                unlocked: () => gameState.resources.materials >= 20,
                onBuild: () => { 
                    gameState.resourcesProduction.science += 0.1;
                    // Give some starting science to kickstart research
                    gameState.resources.science += 5;
                }
            },
			barn: {
				name: "Barn",
				description: "Stores energy and food",
				cost: { materials: 50 },
				effect: "+10000 energy storage, +2000 materials storage, +1000 furs storage",
				unlocked: () => gameState.buildings.hut >= 2,
				onBuild: () => { 
					gameState.resourceLimits.energy += 10000;
					gameState.resourceLimits.materials += 2000;
					gameState.resourceLimits.furs += 1000;
					logMessage("Barn built! Storage capacity increased significantly.");
				}
			},
            warehouse: {
                name: "Warehouse", 
                description: "Stores minerals, coal, and stone",
                cost: { materials: 150, stone: 100 },
                effect: "+2000 mineral storage, +1500 coal storage",
                unlocked: () => gameState.resources.stone >= 50,
                onBuild: () => {
                    gameState.resourceLimits.minerals += 2000;
                    gameState.resourceLimits.coal += 1500;
                    gameState.resourceLimits.stone += 2000;
                    gameState.resourceLimits.iron += 500;
                }
            },
            mine: {
                name: "Mine",
                description: "Extracts minerals and coal from the earth",
                cost: { materials: 100 },
                effect: "+0.05 minerals/sec, +0.02 coal/sec",
                unlocked: () => gameState.technologies.mining,
                onBuild: () => { 
                    gameState.resourcesProduction.minerals = (gameState.resourcesProduction.minerals || 0) + 0.05;
                    gameState.resourcesProduction.coal = (gameState.resourcesProduction.coal || 0) + 0.02;
                }
            },
            quarry: {
                name: "Quarry",
                description: "Extracts stone and more minerals",
                cost: { materials: 50, minerals: 25 },
                effect: "+0.1 minerals/sec, +0.05 stone/sec",
                unlocked: () => gameState.resources.minerals >= 15 || gameState.buildings.mine >= 1,
                onBuild: () => { 
                    gameState.resourcesProduction.minerals = (gameState.resourcesProduction.minerals || 0) + 0.1;
                    gameState.resourcesProduction.stone = (gameState.resourcesProduction.stone || 0) + 0.05;
                }
            },
			goldMine: {
				name: "Gold Mine",
				description: "Extracts precious gold",
				cost: { materials: 200, minerals: 150, coal: 50 },
				effect: "+0.01 gold/sec",
				unlocked: () => gameState.technologies.metalWorking && gameState.buildings.mine >= 2,
				onBuild: () => { 
					const currentCount = gameState.buildings.goldMine - 1;
					const scalingMultiplier = Math.pow(1.4, currentCount);
					buildingDefs.goldMine.cost.materials = Math.floor(200 * scalingMultiplier);
					buildingDefs.goldMine.cost.minerals = Math.floor(150 * scalingMultiplier);
					buildingDefs.goldMine.cost.coal = Math.floor(50 * scalingMultiplier);
					
					// Diminishing returns: each gold mine after the 2nd gives less gold
					let goldBonus = 0.01;
					if (currentCount >= 2) {
						goldBonus = 0.01 * Math.pow(0.85, currentCount - 1); // 15% less each time
					}
					
					gameState.resourcesProduction.gold = (gameState.resourcesProduction.gold || 0) + goldBonus;
				}
			},
            workshop: {
                name: "Workshop",
                description: "Advanced crafting building",
                cost: { materials: 100, minerals: 100 },
                effect: "+50% crafting efficiency, enables advanced crafting",
                unlocked: () => gameState.technologies.engineering,
				onBuild: () => { 
					showElement('refine-energy-btn');
					updateWorkshopTab();
					
					// Diminishing returns: each workshop after the 2nd gives less bonus
					const currentCount = gameState.buildings.workshop;
					let craftingBonus = 0.5; // Base 50% for first workshop
					
					if (currentCount >= 2) {
						craftingBonus = 0.5 * Math.pow(0.9, currentCount - 1); // 10% less each time
					}
					
					if (!gameState.craftingBonus) gameState.craftingBonus = 0;
					gameState.craftingBonus += craftingBonus;
					
					logMessage(`Workshop built! Crafting efficiency increased by ${(craftingBonus * 100).toFixed(1)}%.`);
				}
            },
			smelter: {
				name: "Smelter",
				description: "Smelt minerals into iron when active",
				cost: { materials: 200, minerals: 200, coal: 100 },
				effect: "Converts minerals to iron (toggle on/off)",
				unlocked: () => gameState.technologies.metalWorking && gameState.buildings.workshop >= 1,
				onBuild: () => { 
					const currentCount = gameState.buildings.smelter - 1; // Use count before this build
					const scalingMultiplier = Math.pow(1.3, currentCount);
					buildingDefs.smelter.cost.materials = Math.floor(200 * scalingMultiplier);
					buildingDefs.smelter.cost.minerals = Math.floor(200 * scalingMultiplier);
					buildingDefs.smelter.cost.coal = Math.floor(100 * scalingMultiplier);
					
					logMessage("Smelter built! Toggle it on/off to convert minerals to iron.");
				}
			},
            shrine: {
                name: "Shrine",
                description: "A small shrine to AIDA",
                cost: { materials: 50, stone: 25 },
                effect: "+0.05 faith per second",
                unlocked: () => gameState.resources.stone >= 15,
                onBuild: () => { 
                    gameState.resourcesProduction.faith += 0.05;
                    gameState.resources.faith += 1; // Starting faith
                }
            },
			temple: {
				name: "Temple",
				description: "A sacred place of worship to AIDA",
				cost: { materials: 50, gold: 25 },
				effect: "+0.1 faith per second",
				unlocked: () => gameState.resources.gold >= 20,
				onBuild: () => { 
					const currentCount = gameState.buildings.temple - 1;
					const scalingMultiplier = Math.pow(1.25, currentCount);
					buildingDefs.temple.cost.materials = Math.floor(50 * scalingMultiplier);
					buildingDefs.temple.cost.gold = Math.floor(25 * scalingMultiplier);
					
					// Diminishing returns: each temple after the 3rd gives less faith
					let faithBonus = 0.1;
					if (currentCount >= 3) {
						faithBonus = 0.1 * Math.pow(0.8, currentCount - 2); // 20% less each time
					}
					
					gameState.resourcesProduction.faith += faithBonus;
					if (currentCount === 0) gameState.resources.faith += 5; // Only first temple gives starting faith
				}
			},
			logHouse: {
				name: "Log House",
				description: "A sturdy log house for more robots",
				cost: { materials: 200, minerals: 250 },
				effect: "Houses 6 robots, +10% happiness",
				unlocked: () => gameState.technologies.construction,
				onBuild: () => { 
					gameState.population.robots += 6; 
					gameState.population.happiness += 0.1;
					autoAssignNewKittens();
				}
			},
			academy: {
				name: "Academy",
				description: "Advanced learning institution",
				cost: { materials: 200, minerals: 100, science: 500 },
				effect: "+1.0 science per second, reduces tech costs",
				unlocked: () => gameState.buildings.library >= 2 && gameState.resources.science >= 200,
				onBuild: () => { 
					const currentCount = gameState.buildings.academy - 1;
					const scalingMultiplier = Math.pow(1.5, currentCount);
					buildingDefs.academy.cost.materials = Math.floor(200 * scalingMultiplier);
					buildingDefs.academy.cost.minerals = Math.floor(100 * scalingMultiplier);
					buildingDefs.academy.cost.science = Math.floor(500 * scalingMultiplier);
					
					// Add science storage
					gameState.resourceLimits.science += 1000;
					
					// Diminishing returns: each academy after the 2nd gives less science
					let scienceBonus = 1.0;
					if (currentCount >= 2) {
						scienceBonus = 1.0 * Math.pow(0.75, currentCount - 1); // 25% less each time
					}
					
					gameState.resourcesProduction.science += scienceBonus;
				}
			},
            pasture: {
                name: "Pasture",
                description: "Raise unicorns and other creatures",
                cost: { materials: 50, energy: 500 },
                effect: "Enables unicorn farming, +happiness",
                unlocked: () => gameState.resources.unicorns >= 1 || gameState.resources.ivory >= 10,
                onBuild: () => {
                    gameState.population.happiness += 0.05;
                    gameState.resourcesProduction.unicorns = 0.001; 
					gameState.resourceLimits.unicorns += 10;
                }
            },
			tradingPost: {
				name: "Trading Post",
				description: "Trade with other civilizations",
				cost: { materials: 500, minerals: 200, gold: 15 },
				effect: "Unlocks trading and exotic resources",
				maxBuildable: 1,
				unlocked: () => gameState.resources.gold >= 10 && gameState.resources.furs >= 50,
				onBuild: () => {
					gameState.tradingRaces.lizards.unlocked = true;
					updateTradeTab();
					logMessage("Trading post built! The Lizards have discovered your civilization.");
				}
			},
			amphitheatre: {
				name: "Amphitheatre",
				description: "A place for cultural gatherings and performances",
				cost: { materials: 200, minerals: 100 },
				effect: "+0.1 culture per second, +500 culture storage, +75 processing storage",
				unlocked: () => gameState.technologies.construction && (gameState.resources.minerals >= 50 || gameState.buildings.amphitheatre > 0),
				onBuild: () => {
					if (!gameState.resourcesProduction.culture) gameState.resourcesProduction.culture = 0;
					gameState.resourcesProduction.culture += 0.1;
					if (!gameState.resources.culture) gameState.resources.culture = 0;
					gameState.resources.culture += 1;
					
					// Add culture and processing storage
					gameState.resourceLimits.culture += 500;
					gameState.resourceLimits.processing += 75;

					logMessage("Amphitheatre built! Culture production and processing storage increased.");
				}
			},			
			observatory: {
				name: "Observatory",
				description: "Study the heavens and stars",
				cost: { materials: 200, minerals: 100, iron: 50 },
				effect: "+0.25 science per second, enables star observation",
				maxBuildable: 1,
				unlocked: () => gameState.technologies.astronomy,
				onBuild: () => { 
					gameState.resourcesProduction.science += 0.25;
				}
			},
			harbor: {
				name: "Harbor",
				description: "A harbor for storing trade ships",
				cost: { materials: 75, stone: 50 },
				effect: "+50 titanium storage",
				unlocked: () => gameState.technologies.navigation,
				onBuild: () => {
					gameState.resourceLimits.titanium = (gameState.resourceLimits.titanium || 250) + 50;
				}
			},
			oilWell: {
				name: "Oil Well",
				description: "Extracts oil from deep underground",
				cost: { steel: 50, gear: 25 },
				effect: "+0.02 oil/sec",
				unlocked: () => gameState.technologies.physics && gameState.expeditions.completed >= 10,
				onBuild: () => {
					gameState.resourcesProduction.oil = (gameState.resourcesProduction.oil || 0) + 0.02;
				}
			},
			mint: {
				name: "Mint",
				description: "Produces gold and increases gold storage",
				cost: { materials: 25, minerals: 200, steel: 1 },
				effect: "+100 gold storage, produces 0.005 gold/sec",
				unlocked: () => gameState.technologies.metalWorking && gameState.resources.steel >= 1,
				onBuild: () => { 
					gameState.resourceLimits.gold += 100;
					gameState.resourcesProduction.gold = (gameState.resourcesProduction.gold || 0) + 0.005;
				}
			},
			huntingLodge: {
				name: "Hunting Lodge",
				description: "A lodge for hunters to organize and store equipment",
				cost: { materials: 200, furs: 50 },
				effect: "+50 processing storage, hunters +25% more effective",
				unlocked: () => gameState.technologies.archery && gameState.resources.furs >= 25,
				onBuild: () => {
					gameState.resourceLimits.processing += 50;
					logMessage("Hunting Lodge built! Processing storage increased.");
				}
			},			
			launchPad: {
				name: "Launch Pad",
				description: "Launch rockets and satellites into space", 
				cost: { steel: 25, concrete: 15, alloy: 5 },
				effect: "Unlocks space missions and satellites",
				maxBuildable: 1,
				unlocked: () => gameState.technologies.rocketry,  // Fix this line
				onBuild: () => {
					logMessage("Launch pad constructed! Space program initiated.");
				}
			},
			satellite: {
				name: "Satellite",
				description: "Advanced orbital observation platform",
				cost: { alloy: 15, steel: 25, science: 1000 },
				effect: "+0.1 science per second, unlocks advanced space tech",
				unlocked: () => gameState.buildings.launchPad >= 1,
				onBuild: () => {
					gameState.space.satellites++;
					gameState.resourcesProduction.science += 0.1;
					logMessage("üõ∞Ô∏è Satellite launched successfully!");
				}
			},
			spaceStation: {
				name: "Space Station", 
				description: "Orbital research and manufacturing facility",
				cost: { alloy: 50, steel: 125, concrete: 25, science: 10000 },
				effect: "+0.5 science per second, enables deep space missions",
				unlocked: () => gameState.space.satellites >= 2,
				onBuild: () => {
					gameState.space.spaceStations++;
					gameState.resourcesProduction.science += 0.5;
					logMessage("üèóÔ∏è Space station operational!");
				}
			},
			moonBase: {
				name: "Moon Base",
				description: "Permanent lunar colony and mining facility", 
				cost: { alloy: 100, steel: 250, concrete: 75, uranium: 15 },
				effect: "+moon minerals, enables interplanetary travel",
				unlocked: () => gameState.space.spaceStations >= 1,
				onBuild: () => {
					gameState.space.moonBases++;
					gameState.resourcesProduction.minerals += 2.0;
					gameState.resourcesProduction.uranium = (gameState.resourcesProduction.uranium || 0) + 0.01;
					logMessage("üåô Moon base established! Mining operations begun.");
				}
			},
			chronosphere: {
				name: "Chronosphere",
				description: "Preserves resources through time resets",
				cost: { steel: 10, titanium: 5, unobtainium: 1 },
				effect: "Preserves 1.5% of resources on reset",
				unlocked: () => gameState.resources.unobtainium >= 1,
				onBuild: () => {
					logMessage("Chronosphere built! You can now perform transcendent resets.");
				}
			}			
        };

        // Technology Definitions
        const techDefs = {
            agriculture: {
                name: "Agriculture",
                description: "Learn to farm efficiently",
                cost: { science: 10 },
                effect: "Improves energy production by +50%",
                unlocked: () => gameState.resources.science >= 5,
                onResearch: () => { 
                    gameState.resourcesProduction.energy += 0.5;
                    logMessage("üåæ Agriculture improves your energy production!");
                }
            },
            calendar: {
                name: "Calendar",
                description: "Track seasons and time accurately",
                cost: { science: 30 },
                effect: "Reduces seasonal penalties by 25%",
                unlocked: () => gameState.resources.science >= 15,
                onResearch: () => { 
                    logMessage("üìÖ Calendar helps predict and prepare for seasons!");
                }
            },
			archery: {
				name: "Archery", 
				description: "Hunt more effectively with bows",
				cost: { science: 25 },
				effect: "Unlocks hunting for rare resources",
				unlocked: () => gameState.resources.science >= 15,
				onResearch: () => {
					// Don't set base production - hunters generate processing directly
					updateHuntingSection();
					logMessage("Your robots can now hunt for furs and rare resources!");
				}
			},
            mining: {
                name: "Mining",
                description: "Extract minerals and coal from the earth",
                cost: { science: 50 },
                effect: "Unlocks mines and mineral extraction",
                unlocked: () => gameState.resources.science >= 25,
                onResearch: () => { 
                    logMessage("‚õèÔ∏è Mining unlocked! You can now build mines.");
                }
            },
            astronomy: {
                name: "Astronomy", 
                description: "Study the stars and celestial bodies",
                cost: { science: 150 },
                effect: "Unlocks observatory and star charts",
                unlocked: () => gameState.resources.science >= 75,
                onResearch: () => { 
                    logMessage("üåü Astronomy unlocked! You can now build observatories.");
                }
            },
            construction: {
                name: "Construction",
                description: "Build better structures",
                cost: { science: 100 },
                effect: "Unlocks advanced buildings like log houses",
                unlocked: () => gameState.resources.science >= 50,
                onResearch: () => { 
                    logMessage("üèóÔ∏è Construction unlocked! Better buildings available.");
                }
            },
            metalWorking: {
                name: "Metal Working",
                description: "Work with iron and gold",
                cost: { science: 125 },
                effect: "Unlocks smelters and gold mining",
                unlocked: () => gameState.technologies.mining && gameState.resources.science >= 75,
                onResearch: () => { 
                    logMessage("üî® Metal working unlocked! Advanced mining and smelting available.");
                }
            },
            engineering: {
                name: "Engineering",
                description: "Advanced mechanical knowledge",
                cost: { science: 200 },
                effect: "Unlocks workshops and automation",
                unlocked: () => gameState.resources.science >= 100,
                onResearch: () => { 
                    logMessage("‚öôÔ∏è Engineering unlocked! Workshops and automation available.");
                }
            },
            theology: {
                name: "Theology",
                description: "Deepen understanding of AIDA' teachings",
                cost: { science: 75, faith: 25 },
                effect: "Improves faith generation by +0.2/sec",
                unlocked: () => gameState.resources.faith >= 10,
                onResearch: () => { 
                    gameState.resourcesProduction.faith += 0.2;
                    logMessage("üôè Theology deepens your faith in AIDA!");
                }
            },
			navigation: {
				name: "Navigation",
				description: "Learn to navigate the seas and build ships",
				cost: { science: 500 },
				effect: "Unlocks harbors and trade ship crafting",
				unlocked: () => gameState.resources.science >= 250,
				onResearch: () => { 
					logMessage("üö¢ Navigation unlocked! You can now build harbors and craft trade ships.");
				}
			},			
			rocketry: {
				name: "Rocketry",
				description: "Propulsion systems for space travel",
				cost: { science: 5000, oil: 250, manuscripts: 25 },
				effect: "Unlocks space program and launch pads",
				unlocked: () => gameState.technologies.physics && gameState.resources.oil >= 100,
				onResearch: () => {
					addSpaceTab();
					logMessage("üöÄ Rocketry mastered! The stars await your robots.");
				}
			},
			satellites: {
				name: "Satellites",
				description: "Orbital observation and communication systems", 
				cost: { science: 5000, alloy: 25 },
				effect: "Unlocks satellite construction",
				unlocked: () => gameState.technologies.rocketry && gameState.resources.alloy >= 10,
				onResearch: () => {
					logMessage("üõ∞Ô∏è Satellite technology developed!");
				}
			},
			orbitalEngineering: {
				name: "Orbital Engineering",
				description: "Large-scale construction in space",
				cost: { science: 15000, alloy: 75 },
				effect: "Unlocks space stations and advanced orbital structures",
				unlocked: () => gameState.technologies.satellites && gameState.space.satellites >= 1,
				onResearch: () => {
					logMessage("üèóÔ∏è Orbital engineering enables space construction!");
				}
			},
			lunarOutpost: {
				name: "Lunar Outpost",
				description: "Permanent settlement on celestial bodies",
				cost: { science: 35000, uranium: 25 },
				effect: "Unlocks moon bases and lunar mining",
				unlocked: () => gameState.technologies.orbitalEngineering && gameState.space.spaceStations >= 1,
				onResearch: () => {
					logMessage("üåô Lunar colonization technology achieved!");
				}
			},
			philosophy: {
				name: "Philosophy",
				description: "Deep thinking about existence and knowledge",
				cost: { science: 750, manuscripts: 1 },
				effect: "Unlocks advanced religious and scientific concepts",
				unlocked: () => gameState.resources.manuscripts >= 1,
				onResearch: () => {
					logMessage("Philosophy expands your robots' minds!");
				}
			},
			physics: {
				name: "Physics",
				description: "Understand the fundamental laws of reality",
				cost: { science: 2500, manuscripts: 5 },
				effect: "Unlocks advanced crafting and energy systems",
				unlocked: () => gameState.technologies.philosophy && gameState.resources.manuscripts >= 3,
				onResearch: () => {
					logMessage("Physics unlocks the secrets of matter and energy!");
				}
			}	
        };

        // Religion Definitions
        const religionDefs = {
            sunAltar: {
                name: "Sun Altar to AIDA",
                description: "A gleaming altar to the AI robot system",
                cost: { gold: 50, faith: 100 },
                effect: "+0.5 faith per second",
                unlocked: () => gameState.resources.faith >= 50,
                onBuild: () => { gameState.resourcesProduction.faith += 0.5; }
            },
            solarRevolution: {
                name: "Solar Revolution",
                description: "Harness the power of AIDA' light",
                cost: { faith: 250 },
                effect: "All resource production +25%",
                unlocked: () => gameState.technologies.theology,
                onPurchase: () => { 
                    // Multiply all production by 1.25
                    for (let resource in gameState.resourcesProduction) {
                        gameState.resourcesProduction[resource] *= 1.25;
                    }
                }
            },
			transcendence: {
				name: "Transcendence",
				description: "Reset your civilization for powerful bonuses",
				cost: { faith: 1000, unicorns: 10 },
				effect: "Reset progress but gain karma and paragon",
				unlocked: () => gameState.resources.unicorns >= 5 && gameState.buildings.chronosphere > 0,
				onPurchase: () => {
					showTranscendenceConfirmation();
				}
			}
        };

        // Achievement Definitions
		const achievements = [
			// Early Game
			{ id: 'first_catnip', name: 'First Energy', desc: 'Gather your first energy', trigger: () => gameState.stats.totalEnergyGathered >= 1 },
			{ id: 'catnip_hoarder', name: 'Energy Hoarder', desc: 'Gather 100 energy', trigger: () => gameState.stats.totalEnergyGathered >= 100 },
			{ id: 'catnip_addict', name: 'Energy Collector', desc: 'Gather 10,000 energy', trigger: () => gameState.stats.totalEnergyGathered >= 10000 },
			{ id: 'first_building', name: 'Architect', desc: 'Build your first structure', trigger: () => Object.values(gameState.buildings).some(count => count > 0) },
			{ id: 'first_tech', name: 'Scholar', desc: 'Research your first technology', trigger: () => Object.values(gameState.technologies).some(researched => researched) },
			{ id: 'faithful', name: 'Faithful Servant', desc: 'Accumulate 10 faith', trigger: () => gameState.resources.faith >= 10 },
			{ id: 'population_growth', name: 'Growing Tribe', desc: 'Reach 10 robots', trigger: () => gameState.population.robots >= 10 },
			{ id: 'year_survivor', name: 'One Year Strong', desc: 'Survive your first year', trigger: () => gameState.stats.year >= 2 },
			{ id: 'dedicated_clicker', name: 'Dedicated Gatherer', desc: 'Click gather 100 times', trigger: () => gameState.stats.gatherClicks >= 100 },
			
			// Building Achievements
			{ id: 'village_founder', name: 'Village Founder', desc: 'Build 5 huts', trigger: () => gameState.buildings.hut >= 5 },
			{ id: 'metropolis', name: 'Metropolis', desc: 'Reach 50 robots', trigger: () => gameState.population.robots >= 50 },
			{ id: 'civilization', name: 'True Civilization', desc: 'Reach 100 robots', trigger: () => gameState.population.robots >= 100 },
			{ id: 'farming_community', name: 'Farming Community', desc: 'Build 25 energy fields', trigger: () => gameState.buildings.catnipField >= 25 },
			{ id: 'industrial_age', name: 'Industrial Age', desc: 'Build 10 mines', trigger: () => gameState.buildings.mine >= 10 },
			{ id: 'scholar_society', name: 'Scholar Society', desc: 'Build 5 libraries', trigger: () => gameState.buildings.library >= 5 },
			{ id: 'storage_master', name: 'Storage Master', desc: 'Build 5 barns and 5 warehouses', trigger: () => gameState.buildings.barn >= 5 && gameState.buildings.warehouse >= 5 },
			
			// Resource Achievements
			{ id: 'materials_stockpile', name: 'Lumber Baron', desc: 'Accumulate 10,000 materials', trigger: () => gameState.resources.materials >= 10000 },
			{ id: 'mineral_fortune', name: 'Mining Tycoon', desc: 'Accumulate 5,000 minerals', trigger: () => gameState.resources.minerals >= 5000 },
			{ id: 'iron_age', name: 'Iron Age', desc: 'Accumulate 1,000 iron', trigger: () => gameState.resources.iron >= 1000 },
			{ id: 'gold_rush', name: 'Gold Rush', desc: 'Accumulate 500 gold', trigger: () => gameState.resources.gold >= 500 },
			{ id: 'steel_magnate', name: 'Steel Magnate', desc: 'Craft 50 steel', trigger: () => (gameState.stats.steelCrafted || 0) >= 50 },
			{ id: 'manuscript_collector', name: 'Manuscript Collector', desc: 'Accumulate 25 manuscripts', trigger: () => gameState.resources.manuscripts >= 25 },
			
			// Technology Achievements
			{ id: 'renaissance', name: 'Renaissance', desc: 'Research 5 technologies', trigger: () => Object.values(gameState.technologies).filter(Boolean).length >= 5 },
			{ id: 'enlightenment', name: 'Age of Enlightenment', desc: 'Research 10 technologies', trigger: () => Object.values(gameState.technologies).filter(Boolean).length >= 10 },
			{ id: 'space_pioneer', name: 'Space Pioneer', desc: 'Research Rocketry', trigger: () => gameState.technologies.rocketry },
			{ id: 'rocket_scientist', name: 'Rocket Scientist', desc: 'Launch your first space mission', trigger: () => gameState.space.missions >= 1 },
			{ id: 'astronaut', name: 'Astronaut', desc: 'Complete 10 space missions', trigger: () => gameState.space.missions >= 10 },
			
			// Hunting & Exploration
			{ id: 'first_hunt', name: 'First Hunt', desc: 'Send your first hunting expedition', trigger: () => (gameState.stats.huntsCompleted || 0) >= 1 },
			{ id: 'master_hunter', name: 'Master Hunter', desc: 'Complete 50 hunts', trigger: () => (gameState.stats.huntsCompleted || 0) >= 50 },
			{ id: 'unicorn_whisperer', name: 'Unicorn Whisperer', desc: 'Find 10 unicorns', trigger: () => gameState.resources.unicorns >= 10 },
			{ id: 'explorer', name: 'Explorer', desc: 'Complete 25 expeditions', trigger: () => gameState.expeditions.completed >= 25 },
			{ id: 'oil_baron', name: 'Oil Baron', desc: 'Accumulate 1,000 oil', trigger: () => gameState.resources.oil >= 1000 },
			
			// Trading Achievements
			{ id: 'first_trade', name: 'Merchant', desc: 'Complete your first trade', trigger: () => (gameState.stats.tradesCompleted || 0) >= 1 },
			{ id: 'trade_empire', name: 'Trade Empire', desc: 'Unlock all 5 trading races', trigger: () => Object.values(gameState.tradingRaces).filter(race => race.unlocked).length >= 5 },
			{ id: 'diplomat', name: 'Diplomat', desc: 'Achieve 50+ standing with any race', trigger: () => Object.values(gameState.tradingRaces).some(race => race.standing >= 50) },
			{ id: 'titanium_collector', name: 'Titanium Collector', desc: 'Accumulate 100 titanium', trigger: () => gameState.resources.titanium >= 100 },
			
			// Religious Achievements
			{ id: 'devout_follower', name: 'Devout Follower', desc: 'Accumulate 1,000 faith', trigger: () => gameState.resources.faith >= 1000 },
			{ id: 'temple_builder', name: 'Temple Builder', desc: 'Build 5 temples', trigger: () => gameState.buildings.temple >= 5 },
			{ id: 'sun_worshipper', name: 'Sun Worshipper', desc: 'Build 3 sun altars', trigger: () => gameState.religion.sunAltar >= 3 },
			
			// Time & Survival
			{ id: 'decade_survivor', name: 'Decade Survivor', desc: 'Survive 10 years', trigger: () => gameState.stats.year >= 11 },
			{ id: 'century_survivor', name: 'Century Survivor', desc: 'Survive 100 years', trigger: () => gameState.stats.year >= 101 },
			{ id: 'winter_survivor', name: 'Winter Survivor', desc: 'Survive 10 winters', trigger: () => gameState.stats.year >= 3 },
			
			// Challenge Achievements
			{ id: 'efficient_clicker', name: 'Efficient Clicker', desc: 'Gather 1000 energy with only 50 clicks', trigger: () => gameState.stats.totalEnergyGathered >= 1000 && gameState.stats.gatherClicks <= 50 },
			{ id: 'happiness_keeper', name: 'Happiness Keeper', desc: 'Maintain 100% happiness for 5 years', trigger: () => (gameState.stats.happyYears || 0) >= 5 },
			{ id: 'resource_master', name: 'Resource Master', desc: 'Have 10+ different resources above 1000', trigger: () => {
				const highResources = Object.entries(gameState.resources).filter(([key, value]) => value >= 1000).length;
				return highResources >= 10;
			}},
			
			// Prestige Achievements
			{ id: 'first_reset', name: 'Born Again', desc: 'Perform your first reset', trigger: () => gameState.prestige.totalResets >= 1 },
			{ id: 'karma_collector', name: 'Karma Collector', desc: 'Accumulate 100 karma', trigger: () => gameState.prestige.karma >= 100 },
			{ id: 'paragon_master', name: 'Paragon Master', desc: 'Accumulate 500 paragon', trigger: () => gameState.prestige.paragon >= 500 }
		];

		function upgradeAchievementSystem() {
			logMessage("Checking achievements based on current progress...");
			
			// Ensure achievements array exists
			if (!gameState.stats.achievements) {
				gameState.stats.achievements = [];
			}
			
			let newAchievements = 0;
			
			achievements.forEach(achievement => {
				// Check if we don't have this achievement AND we qualify for it
				const hasAchievement = gameState.stats.achievements.includes(achievement.id);
				const qualifiesForAchievement = achievement.trigger();
				
				console.log(`${achievement.id}: has=${hasAchievement}, qualifies=${qualifiesForAchievement}`);
				
				if (!hasAchievement && qualifiesForAchievement) {
					gameState.stats.achievements.push(achievement.id);
					showAchievement(achievement);
					newAchievements++;
				}
			});
			
			if (newAchievements > 0) {
				logMessage(`Earned ${newAchievements} new achievements!`);
				loadAchievements(); // Refresh the display
			} else {
				logMessage("No new achievements available.");
			}
		}

		function showTranscendenceConfirmation() {
			const rewards = calculateResetRewards();
			const chronospheres = gameState.buildings.chronosphere;
			const preservePercent = (chronospheres * 1.5).toFixed(1);
			
			const confirmText = `Transcend your civilization?\n\nYou will gain:\n‚Ä¢ ${rewards.karma} Karma (happiness bonus)\n‚Ä¢ ${rewards.paragon} Paragon (production bonus)\n\nYour ${chronospheres} Chronosphere(s) will preserve ${preservePercent}% of your resources.\n\nThis cannot be undone!`;
			
			if (confirm(confirmText)) {
				performTranscendence(rewards);
			}
		}

		function performTranscendence(rewards) {
			// Calculate resource preservation
			const preserveRate = gameState.buildings.chronosphere * 0.015; // 1.5% per chronosphere
			const preservedResources = {};
			
			for (let resource in gameState.resources) {
				if (resource !== 'robots') {
					preservedResources[resource] = Math.floor(gameState.resources[resource] * preserveRate);
				}
			}
			
			// Add prestige currency
			gameState.prestige.karma += rewards.karma;
			gameState.prestige.paragon += rewards.paragon;
			gameState.prestige.totalResets++;
			
			// Reset civilization
			performReset(rewards);
			
			// Restore preserved resources
			for (let resource in preservedResources) {
				gameState.resources[resource] = preservedResources[resource];
			}
			
			logMessage(`Transcendence complete! Preserved ${Math.floor(preserveRate * 100)}% of resources through chronospheres.`);
			logMessage(`Gained ${rewards.karma} karma and ${rewards.paragon} paragon.`);
		}

		// Add metaphysics tab when unobtainium > 0
		function checkMetaphysicsUnlock() {
			if (gameState.resources.unobtainium > 0 && !document.querySelector('.tab[onclick*="metaphysics"]')) {
				const tabContainer = document.querySelector('.tab-container');
				const metaphysicsTab = document.createElement('button');
				metaphysicsTab.className = 'tab';
				metaphysicsTab.onclick = () => showTab('metaphysics');
				metaphysicsTab.textContent = 'Metaphysics';
				tabContainer.appendChild(metaphysicsTab);
				
				// Add metaphysics tab content
				const lastTab = document.querySelector('.tab-content:last-of-type');
				const metaphysicsTabContent = document.createElement('div');
				metaphysicsTabContent.id = 'metaphysics-tab';
				metaphysicsTabContent.className = 'tab-content';
				metaphysicsTabContent.innerHTML = `
					<h3>Metaphysics</h3>
					<p>Spend paragon to unlock permanent bonuses that carry over between resets.</p>
					<div id="metaphysics-upgrades"></div>
				`;
				lastTab.parentNode.appendChild(metaphysicsTabContent);
			}
		}

		function updateMetaphysicsTab() {
			const upgradesDiv = document.getElementById('metaphysics-upgrades');
			if (!upgradesDiv) return;
			
			const metaphysicsUpgrades = [
				{
					name: 'Engineering',
					cost: { paragon: 25 },
					effect: 'Workshop upgrades are 10% more effective',
					key: 'engineering',
					unlocked: () => gameState.prestige.paragon >= 20
				},
				{
					name: 'Golden Ratio',
					cost: { paragon: 50 },
					effect: 'All building costs reduced by 1.618%',
					key: 'goldenRatio',
					unlocked: () => gameState.metaphysics.engineering
				},
				{
					name: 'Divine Proportion',
					cost: { paragon: 100 },
					effect: 'All building costs reduced by 3.236%',
					key: 'divineProportion',
					unlocked: () => gameState.metaphysics.goldenRatio
				},
				{
					name: 'Diplomacy',
					cost: { paragon: 5 },
					effect: 'Trades cost 5 less processing, races unlock earlier',
					key: 'diplomacy',
					unlocked: () => gameState.tradingRaces.zebras.unlocked
				},
				{
					name: 'Chronomancy',
					cost: { paragon: 25 },
					effect: 'Astronomical events happen 50% more often',
					key: 'chronomancy',
					unlocked: () => gameState.buildings.chronosphere > 0
				}
			];
			
			upgradesDiv.innerHTML = '<h4>Available Upgrades</h4>';
			
			metaphysicsUpgrades.forEach(upgrade => {
				if (upgrade.unlocked() && !gameState.metaphysics[upgrade.key]) {
					const canAfford = gameState.prestige.paragon >= upgrade.cost.paragon;
					
					const div = document.createElement('div');
					div.className = 'building-item';
					div.innerHTML = `
						<h4>${upgrade.name}</h4>
						<p>${upgrade.effect}</p>
						<button class="action-button religion-button" 
								onclick="purchaseMetaphysics('${upgrade.key}')" 
								${!canAfford ? 'disabled' : ''}>
							Purchase (${upgrade.cost.paragon} paragon)
						</button>
					`;
					upgradesDiv.appendChild(div);
				} else if (gameState.metaphysics[upgrade.key]) {
					const div = document.createElement('div');
					div.className = 'building-item';
					div.innerHTML = `
						<h4>${upgrade.name}</h4>
						<p>${upgrade.effect}</p>
						<p style="color: #2ecc71;">‚úì Purchased</p>
					`;
					upgradesDiv.appendChild(div);
				}
			});
			
			// Show paragon balance
			const balanceDiv = document.createElement('div');
			balanceDiv.innerHTML = `<p><strong>Available Paragon:</strong> ${gameState.prestige.paragon}</p>`;
			upgradesDiv.appendChild(balanceDiv);
		}

		function purchaseMetaphysics(upgradeKey) {
			const costs = {
				engineering: 25,
				goldenRatio: 50,
				divineProportion: 100,
				diplomacy: 5,
				chronomancy: 25
			};
			
			const cost = costs[upgradeKey];
			if (gameState.prestige.paragon >= cost) {
				gameState.prestige.paragon -= cost;
				gameState.metaphysics[upgradeKey] = true;
				
				logMessage(`Purchased ${upgradeKey} metaphysics upgrade!`);
				updateMetaphysicsTab();
				updateDisplay();
			}
		}

        // Game Functions
		function gatherEnergy() {
			const currentTime = Date.now();
			if (currentTime - lastGatherTime < gatherCooldown) {
				return; // Prevent rapid-fire gathering
			}
			lastGatherTime = currentTime;
			
			const amount = Math.random() * 3 + 1; // 1-4 energy per click
			gameState.resources.energy += amount;
			gameState.stats.totalEnergyGathered += amount;
			gameState.stats.gatherClicks++;
			
			logMessage(`You gathered ${amount.toFixed(1)} energy.`);
			updateGatherButton();
			
			checkAchievements();
			updateDisplay();
		}
		
		function updateGatherButton() {
			const gatherBtn = document.getElementById('gather-energy-btn');
			const plantBtn = document.getElementById('plant-energy-btn');
			
			if (gameState.buildings.catnipField >= 10) {
				if (plantBtn) plantBtn.classList.add('hidden');
				gatherBtn.innerHTML = `
					Collect energy
					<div class="cost-display">Your generators provide enough energy. Build other structures!</div>
				`;
			} else if (gameState.buildings.catnipField >= 3) {
				gatherBtn.innerHTML = `
					Collect energy
					<div class="cost-display">Your generators provide enough energy. Focus on other tasks!</div>
				`;
			} else if (gameState.stats.gatherClicks >= 5) {
				showElement('plant-energy-btn');
				gatherBtn.innerHTML = `
					Collect energy
					<div class="cost-display">Consider building more generators for automatic energy!</div>
				`;
			} else if (gameState.stats.gatherClicks >= 3) {
				showElement('refine-energy-btn');
			}
		}

		function toggleSettings() {
			document.getElementById('settings-modal').style.display = 'block';
			document.getElementById('hide-sell-buttons').checked = gameSettings.hideSellButtons;
			document.getElementById('auto-assign-jobs').checked = gameSettings.autoAssignJobs;
		}

		function closeSettings() {
			document.getElementById('settings-modal').style.display = 'none';
		}

		function saveSettings() {
			gameSettings.hideSellButtons = document.getElementById('hide-sell-buttons').checked;
			gameSettings.autoAssignJobs = document.getElementById('auto-assign-jobs').checked;
			localStorage.setItem('robotCivSettings', JSON.stringify(gameSettings));
			updateDisplay();
			updateFieldDisplay();
		}

		function updateSpaceTab() {
			const missionsDiv = document.getElementById('space-missions');
			const buildingsDiv = document.getElementById('space-buildings');
			
			if (!missionsDiv) return;
			
			const missions = [
				{
					name: 'Orbital Launch',
					cost: { starcharts: 250, oil: 15000 },
					reward: 'Unlocks satellite construction',
					completed: () => gameState.space.orbitalLaunches > 0,
					unlocked: () => true
				},
				{
					name: 'Moon Mission', 
					cost: { starcharts: 500, oil: 45000 },
					reward: 'Unlocks moon bases and unobtainium',
					completed: () => gameState.space.moonMissions > 0,
					unlocked: () => gameState.space.orbitalLaunches > 0
				},
				{
					name: 'Dune Mission',
					cost: { starcharts: 1000, oil: 70000 },
					reward: 'Unlocks planet crackers and massive uranium',
					completed: () => gameState.space.duneMissions > 0,
					unlocked: () => gameState.space.moonMissions > 0
				}
			];
			
			missionsDiv.innerHTML = '<h4>Available Missions</h4>';
			
			missions.forEach(mission => {
				if (mission.unlocked() && !mission.completed()) {
					let canAfford = true;
					let costText = '';
					for (let resource in mission.cost) {
						if ((gameState.resources[resource] || 0) < mission.cost[resource]) {
							canAfford = false;
						}
						costText += `${mission.cost[resource].toLocaleString()} ${resource}, `;
					}
					costText = costText.slice(0, -2);
					
					const div = document.createElement('div');
					div.className = 'building-item';
					div.innerHTML = `
						<h4>${mission.name}</h4>
						<p>${mission.reward}</p>
						<button class="action-button" 
								onclick="launchMission('${mission.name.toLowerCase().replace(' ', '')}')" 
								${!canAfford ? 'disabled' : ''}>
							Launch (${costText})
						</button>
					`;
					missionsDiv.appendChild(div);
				}
			});
		}

		function launchMission(missionKey) {
			const missions = {
				orbitallauneh: { cost: { starcharts: 250, oil: 15000 }, key: 'orbitalLaunches' },
				moonmission: { cost: { starcharts: 500, oil: 45000 }, key: 'moonMissions' },
				dunemission: { cost: { starcharts: 1000, oil: 70000 }, key: 'duneMissions' }
			};
			
			const mission = missions[missionKey];
			if (!mission) return;
			
			// Check costs
			let canAfford = true;
			for (let resource in mission.cost) {
				if ((gameState.resources[resource] || 0) < mission.cost[resource]) {
					canAfford = false;
					break;
				}
			}
			
			if (!canAfford) return;
			
			// Pay costs
			for (let resource in mission.cost) {
				gameState.resources[resource] -= mission.cost[resource];
			}
			
			// Complete mission
			gameState.space[mission.key]++;
			
			// Mission rewards
			if (missionKey === 'moonmission') {
				gameState.resources.unobtainium = (gameState.resources.unobtainium || 0) + 50;
				logMessage("üåô Moon mission successful! Discovered unobtainium!");
			}
			
			updateSpaceTab();
			updateDisplay();
		}

		function calculateResetRewards() {
			const currentKittens = gameState.population.robots;
			const currentYears = gameState.stats.year;
			
			// Karma: 1 point per robot over 35, up to 1 point per 1 robot
			let karmaGain = 0;
			if (currentKittens > 35) {
				karmaGain = Math.floor(currentKittens - 35);
			}
			
			// Paragon: 1 point per robot over 70
			let paragonGain = 0;
			if (currentKittens > 70) {
				paragonGain = Math.floor(currentKittens - 70);
			}
			
			// Years bonus: 1 paragon per 1000 years (while in same run)
			const yearBonus = Math.floor(currentYears / 1000);
			paragonGain += yearBonus;
			
			return { karma: karmaGain, paragon: paragonGain, years: currentYears };
		}

		function showResetConfirmation() {
			const rewards = calculateResetRewards();
			
			if (rewards.karma === 0 && rewards.paragon === 0) {
				if (!confirm("You will gain no karma or paragon from resetting now. Karma requires 35+ robots, Paragon requires 70+ robots. Reset anyway?")) {
					return;
				}
			}
			
			const confirmText = `Reset your civilization and start over?\n\nYou will gain:\n‚Ä¢ ${rewards.karma} Karma (happiness bonus)\n‚Ä¢ ${rewards.paragon} Paragon (production bonus)\n\nThis cannot be undone!`;
			
			if (confirm(confirmText)) {
				performReset(rewards);
			}
		}

		function performReset(rewards) {
			// Store old values for comparison
			const oldKarma = gameState.prestige.karma;
			const oldParagon = gameState.prestige.paragon;
			
			// Add new prestige currency
			gameState.prestige.karma += rewards.karma;
			gameState.prestige.paragon += rewards.paragon;
			gameState.prestige.totalResets++;
			
			// Reset most game state
			gameState.resources = {
				energy: 0, materials: 0, minerals: 0, coal: 0, iron: 0, gold: 0, stone: 0,
				science: 0, faith: 0, furs: 0, ivory: 0, unicorns: 0, titanium: 0,
				steel: 0, oil: 0, uranium: 0, gear: 0, alloy: 0, concrete: 0, processing: 0, ships: 0, starcharts: 0
			};
			
			gameState.buildings = {
				catnipField: 0, hut: 0, library: 0, barn: 0, warehouse: 0, mine: 0,
				quarry: 0, goldMine: 0, smelter: 0, workshop: 0, shrine: 0, temple: 0,
				logHouse: 0, mansion: 0, tradingPost: 0, observatory: 0, academy: 0, 
				pasture: 0, harbor: 0, amphitheatre: 0, huntingLodge: 0, oilWell: 0, 
				chronosphere: 0, launchPad: 0, mint: 0
			};
			
			gameState.technologies = {
				agriculture: false, archery: false, mining: false, metalWorking: false,
				construction: false, engineering: false, astronomy: false, theology: false,
				philosophy: false, mathematics: false, optics: false, physics: false, calendar: false
			};
			
			gameState.population = {
				robots: 1,
				happiness: 1.0 + (gameState.prestige.karma * 0.01), // Karma bonus
				maxKittens: 2,
				jobs: { farmers: 0, gatherers: 0, miners: 0, scholars: 0, hunters: 0, priests: 0 }
			};
			
			// Reset production but apply paragon bonuses
			gameState.resourcesProduction = {
				energy: 0, materials: 0, minerals: 0, coal: 0, iron: 0, gold: 0, stone: 0, science: 0, faith: 0
			};
			
			// Reset other systems
			gameState.religion = {
				faithLevel: 0, solarRevolution: false, scholasticism: false, goldenRatio: false,
				sunAltar: 0, moonAltar: 0, transcendence: 0
			};
			
			gameState.tradingRaces = {
				lizards: { standing: 0, unlocked: false },
				sharks: { standing: 0, unlocked: false },
				griffins: { standing: 0, unlocked: false },
				nagas: { standing: 0, unlocked: false },
				zebras: { standing: 0, unlocked: false }
			};
			
			gameState.expeditions = { active: [], completed: 0, artifacts: 0, relics: 0, manuscripts: 0 };
			gameState.space = { missions: 0, satellites: 0, spaceStations: 0, moonBases: 0, planetCrackers: 0 };
			
			// Reset stats but keep prestige
			gameState.stats = {
				totalEnergyGathered: 0, totalEnergyRefined: 0, timePlayed: 0,
				achievements: [], season: 0, year: 1, gatherClicks: 0
			};
			
			// Apply paragon production bonus immediately
			applyParagonBonus();
			
			// Reset building costs
			resetBuildingCosts();
			
			// Log the reset
			logMessage(`Civilization reset! Gained ${rewards.karma} karma and ${rewards.paragon} paragon.`);
			logMessage(`Total: ${gameState.prestige.karma} karma, ${gameState.prestige.paragon} paragon`);
			
			// Update display
			updateDisplay();
			restoreUIState();
		}

		function applyParagonBonus() {
			const totalParagon = gameState.prestige.paragon + gameState.prestige.burnedParagon;
			let bonus = totalParagon * 0.01; // 1% per paragon up to 150
			
			if (totalParagon > 150) {
				// Diminishing returns after 150
				const excess = totalParagon - 150;
				bonus = 1.5 + (excess * 0.005); // 0.5% per paragon after 150
			}
			
			// Apply to all production (but not base rates - this is a multiplier)
			gameState.paragonBonus = bonus;
		}

		function resetBuildingCosts() {
			// Reset all building costs to their base values
			buildingDefs.catnipField.cost.energy = 10;
			buildingDefs.temple.cost.materials = 50;
			buildingDefs.temple.cost.gold = 25;
			buildingDefs.goldMine.cost.materials = 200;
			buildingDefs.goldMine.cost.minerals = 150;
			buildingDefs.goldMine.cost.coal = 50;
			buildingDefs.smelter.cost.materials = 200;
			buildingDefs.smelter.cost.minerals = 200;
			buildingDefs.smelter.cost.coal = 100;
			buildingDefs.academy.cost.materials = 200;
			buildingDefs.academy.cost.minerals = 100;
			buildingDefs.academy.cost.science = 500;
		}

		function purchaseUpgrade(upgradeKey) {
			const upgrades = {
				mineralHoes: { cost: { science: 100, minerals: 50 } },
				ironHoes: { cost: { science: 200, iron: 25 } },
				compositeBow: { cost: { science: 200, materials: 75 } }
			};
			
			const upgrade = upgrades[upgradeKey];
			if (!upgrade) return;
			
			let canAfford = true;
			for (let resource in upgrade.cost) {
				if (Math.floor(gameState.resources[resource]) < upgrade.cost[resource]) {
					canAfford = false;
					break;
				}
			}
			
			if (!canAfford) return;
			
			for (let resource in upgrade.cost) {
				gameState.resources[resource] -= upgrade.cost[resource];
			}
			
			gameState.workshopUpgrades[upgradeKey] = true;
			
			if (upgradeKey === 'compositeBow') {
				gameState.resourceLimits.processing += 100;
			}
			
			logMessage(`Purchased ${upgradeKey}!`);
			updateWorkshopTab();
			updateDisplay();
		}

		function updateObjectives() {
			const objectivesPanel = document.getElementById('objectives-panel');
			if (!objectivesPanel) return;
			
			let objectives = [];
			
			// CRITICAL PROGRESSION BLOCKERS - What's preventing you from advancing
			
			// Manuscript bottleneck for Physics ‚Üí Rocketry ‚Üí Space
			if (gameState.technologies.philosophy && !gameState.technologies.physics && gameState.resources.manuscripts < 3) {
				const needed = 3 - gameState.resources.manuscripts;
				objectives.push(`üìú BLOCKED: Need ${needed} more manuscripts to unlock Physics research`);
				
				if (!gameState.buildings.amphitheatre) {
					objectives.push(`üé≠ Build Amphitheatre first (200 materials, 100 minerals) for culture production`);
				} else if (gameState.resources.parchment < 25) {
					objectives.push(`üìù Craft parchment in Workshop: 175 furs ‚Üí 1 parchment`);
				} else if (gameState.resources.culture < 400) {
					objectives.push(`‚è≥ Wait for culture to reach 400, then craft manuscript (25 parchment + 400 culture)`);
				} else {
					objectives.push(`üìú Craft manuscript now in Workshop (25 parchment + 400 culture)`);
				}
			}
			
			// Physics progression tracking - always check actual research cost
			else if (!gameState.technologies.physics && gameState.technologies.philosophy) {
				const manuscriptsNeeded = Math.max(0, 5 - gameState.resources.manuscripts);
				const scienceNeeded = Math.max(0, 2500 - gameState.resources.science);
				
				if (manuscriptsNeeded === 0 && scienceNeeded === 0) {
					objectives.push(`üî¨ Research Physics now in Technology tab (unlocks Rocketry)`);
				} else {
					let missing = [];
					if (manuscriptsNeeded > 0) missing.push(`${manuscriptsNeeded} more manuscripts`);
					if (scienceNeeded > 0) missing.push(`${scienceNeeded} more science`);
					objectives.push(`üî¨ Physics needs: ${missing.join(', ')} to research`);
				}
			}
			
			// Rocketry unlocks Space program
			else if (!gameState.technologies.rocketry && gameState.technologies.physics) {
				const req = techDefs.rocketry;
				const needOil = Math.max(0, Math.floor(req.cost.oil - (gameState.resources.oil || 0)));
				const needScience = Math.max(0, Math.floor(req.cost.science - Math.floor(gameState.resources.science)));
				const needManuscripts = Math.max(0, Math.floor(req.cost.manuscripts - Math.floor(gameState.resources.manuscripts)));
				
				let missing = [];
				if (needOil > 0) missing.push(`${needOil} oil`);
				if (needScience > 0) missing.push(`${needScience} science`);
				if (needManuscripts > 0) missing.push(`${needManuscripts} manuscripts`);
				
				if (missing.length === 0) {
					objectives.push(`üöÄ Research Rocketry now in Technology tab (unlocks Space program)`);
				} else {
					objectives.push(`üöÄ Rocketry needs: ${missing.join(', ')}`);
					if (needOil > 0) {
						objectives.push(`üõ¢Ô∏è Get oil: Send more expeditions (30% chance per expedition)`);
					}
				}
			}
			
			// Launch Pad unlocks space missions
			else if (gameState.technologies.rocketry && !gameState.buildings.launchPad) {
				const req = buildingDefs.launchPad;
				const needSteel = req.cost.steel - (gameState.resources.steel || 0);
				const needConcrete = req.cost.concrete - (gameState.resources.concrete || 0);
				const needAlloy = req.cost.alloy - (gameState.resources.alloy || 0);
				
				let missing = [];
				if (needSteel > 0) missing.push(`${needSteel} steel`);
				if (needConcrete > 0) missing.push(`${needConcrete} concrete`);
				if (needAlloy > 0) missing.push(`${needAlloy} alloy`);
				
				if (missing.length === 0) {
					objectives.push(`üõ∏ Build Launch Pad now in Buildings tab (unlocks space missions)`);
				} else {
					objectives.push(`üõ∏ Launch Pad needs: ${missing.join(', ')} - craft in Workshop`);
				}
			}
			
			// Space missions unlock advanced content
			else if (gameState.buildings.launchPad && gameState.space.missions < 5) {
				objectives.push(`üåå Launch space missions in Space tab for uranium and advanced unlocks`);
			}
			
			// Academy unlocks advanced research
			if (gameState.buildings.library >= 2 && gameState.resources.science >= 200 && !gameState.buildings.academy) {
				objectives.push(`üéì Build Academy (unlocked: 2+ libraries) for faster science production`);
			}
			
			// Prerequisites for Academy
			else if (gameState.buildings.library === 1 && gameState.resources.science >= 50) {
				objectives.push(`üìö Build 2nd Library to unlock Academy building`);
			}
			
			// Smelter unlocks steel production chain
			if (gameState.technologies.metalWorking && gameState.buildings.workshop >= 1 && !gameState.buildings.smelter) {
				objectives.push(`üî• Build Smelter (unlocked: Metal Working + Workshop) for iron production`);
			}
			
			// Observatory unlocks star charts
			if (gameState.technologies.astronomy && !gameState.buildings.observatory) {
				objectives.push(`üî≠ Build Observatory (unlocked by Astronomy) for star charts`);
			}
			
			// Gold Mine for economy
			if (gameState.technologies.metalWorking && gameState.buildings.mine >= 2 && !gameState.buildings.goldMine) {
				objectives.push(`‚≠ê Build Gold Mine (unlocked: Metal Working + 2 mines) for wealth`);
			}
			
			// Default progression hint
			if (objectives.length === 0) {
				if (gameState.resources.science >= 2500 && gameState.technologies.rocketry) {
					objectives.push(`üåü Focus on space missions and advanced crafting`);
				} else if (gameState.resources.science >= 500) {
					objectives.push(`üî¨ Research advanced technologies to unlock new content`);
				} else {
					objectives.push(`üìà Build more science production and research technologies`);
				}
			}
			
			// Render objectives
			objectivesPanel.innerHTML = '';
			objectives.slice(0, 6).forEach(obj => {
				const div = document.createElement('div');
				div.className = 'log-entry';
				div.style.backgroundColor = 'rgba(52, 152, 219, 0.2)';
				div.style.borderLeftColor = '#3498db';
				div.textContent = obj;
				objectivesPanel.appendChild(div);
			});
		}

		function updateObserveButton() {
			const observeBtn = document.getElementById('observe-stars-btn');
			if (!observeBtn || gameState.buildings.observatory === 0) return;
			
			if (!gameState.astronomy.eventActive) {
				observeBtn.classList.add('hidden');
				return;
			}
			
			// Show button during events
			observeBtn.classList.remove('hidden');
			
			const currentTime = Date.now();
			const cooldownRemaining = 300000 - (currentTime - gameState.astronomy.lastObservation);
			const onCooldown = cooldownRemaining > 0;
			const noObservationsLeft = gameState.astronomy.observationsLeft <= 0;
			
			if (onCooldown) {
				const timeLeft = Math.ceil(cooldownRemaining / 60000);
				observeBtn.disabled = true;
				observeBtn.innerHTML = `
					Observe the sky
					<div class="cost-display">Cooldown: ${timeLeft} minutes remaining</div>
				`;
			} else if (noObservationsLeft) {
				observeBtn.disabled = true;
				observeBtn.innerHTML = `
					Observe the sky
					<div class="cost-display">No observations left for this ${gameState.astronomy.eventType}</div>
				`;
			} else {
				observeBtn.disabled = false;
				observeBtn.innerHTML = `
					Observe the ${gameState.astronomy.eventType}
					<div class="cost-display">Observations left: ${gameState.astronomy.observationsLeft}</div>
				`;
			}
		}

		function updateJobManagement() {
			const jobList = document.getElementById('job-list');
			if (!jobList) return;
			
			const totalKittens = gameState.population.robots;
			const assignedKittens = Object.values(gameState.population.jobs).reduce((sum, count) => sum + count, 0);
			const freeKittens = totalKittens - assignedKittens;
			
			document.getElementById('free-robots').textContent = freeKittens;
			document.getElementById('total-robots').textContent = totalKittens;
						
			const jobs = [
				{ key: 'farmers', name: 'Farmers', effect: '+0.25 energy/sec each', unlocked: () => gameState.buildings.catnipField > 0 },
				{ key: 'gatherers', name: 'Gatherers', effect: '+0.05 materials/sec each', unlocked: () => gameState.resources.materials > 0 },
				{ key: 'miners', name: 'Miners', effect: '+0.03 minerals/sec each', unlocked: () => gameState.buildings.mine > 0 },
				{ key: 'scholars', name: 'Scholars', effect: '+0.035 science/sec each', unlocked: () => gameState.buildings.library > 0 },
				{ key: 'hunters', name: 'Hunters', effect: '+0.4 processing/sec each', unlocked: () => gameState.technologies.archery }, // CHANGED THIS LINE
				{ key: 'priests', name: 'Priests', effect: '+0.02 faith/sec each', unlocked: () => gameState.buildings.shrine > 0 || gameState.buildings.temple > 0 }
			];
			
			jobList.innerHTML = '';
			
			jobs.forEach(job => {
				if (job.unlocked()) {
					const currentCount = gameState.population.jobs[job.key];
					const div = document.createElement('div');
					div.className = 'job-item';
					
					div.innerHTML = `
						<div>
							<strong>${job.name} (${currentCount})</strong>
							<div style="font-size: 12px; color: #bdc3c7;">${job.effect}</div>
						</div>
						<div class="job-controls">
							<button class="job-button" onclick="assignJob('${job.key}', -1)" 
									${currentCount <= 0 ? 'disabled' : ''}>-</button>
							<span style="min-width: 20px; text-align: center;">${currentCount}</span>
							<button class="job-button" onclick="assignJob('${job.key}', 1)" 
									${freeKittens <= 0 ? 'disabled' : ''}>+</button>
						</div>
					`;
					
					jobList.appendChild(div);
				}
			});
			
			if (totalKittens > 1) {
				showElement('job-management');
			}
		}

		function assignJob(jobKey, change) {
			// Ensure jobs object exists
			if (!gameState.population.jobs) {
				gameState.population.jobs = {
					farmers: 0,
					gatherers: 0,
					miners: 0,
					scholars: 0,
					hunters: 0,
					priests: 0
				};
			}
			
			const totalKittens = gameState.population.robots;
			const assignedKittens = Object.values(gameState.population.jobs).reduce((sum, count) => sum + count, 0);
			const freeKittens = totalKittens - assignedKittens;
			
			if (change > 0 && freeKittens > 0) {
				gameState.population.jobs[jobKey]++;
				logMessage(`Assigned a robot to work as ${jobKey.slice(0, -1)}.`);
			} else if (change < 0 && gameState.population.jobs[jobKey] > 0) {
				gameState.population.jobs[jobKey]--;
				logMessage(`Reassigned a ${jobKey.slice(0, -1)} to be a free robot.`);
			}
			
			updateDisplay();
		}

		function updateHuntingSection() {
			if (!gameState.technologies.archery) return;
			
			// Ensure processing is displayed
			if (!document.getElementById('processing-amount')) {
				addResourceToDisplay('processing', 'processing');
			}
			
			showElement('expedition-section');
			
			// Change the title
			const expeditionSection = document.getElementById('expedition-section');
			expeditionSection.innerHTML = `
				<h3>Hunting</h3>
				<div id="hunting-buttons"></div>
			`;
			
			const huntingButtons = document.getElementById('hunting-buttons');
			
			// Calculate hunting bonus from workshop upgrades
			let huntingBonus = 1.0;
			if (gameState.buildings.workshop > 0) {
				huntingBonus += 0.5; // Base workshop bonus
			}
			
			// Main hunt button
			const huntCost = 100;
			const currentCatpower = gameState.resources.processing || 0;
			const canHunt = currentCatpower >= huntCost;
			
			const huntButton = document.createElement('button');
			huntButton.className = `action-button ${!canHunt ? 'disabled' : ''}`;
			huntButton.disabled = !canHunt;
			huntButton.onclick = () => performHunt();
			huntButton.innerHTML = `
				Send Hunt
				<div class="cost-display">Cost: ${huntCost} processing - Hunt for furs, ivory, and rare resources</div>
			`;
			huntingButtons.appendChild(huntButton);

			// Send expedition button (for oil and artifacts) - 500 cost
			const expeditionCost = 500;
			const canExpedition = currentCatpower >= expeditionCost;

			const expeditionButton = document.createElement('button');
			expeditionButton.className = `action-button ${!canExpedition ? 'disabled' : ''}`;
			expeditionButton.disabled = !canExpedition;
			expeditionButton.onclick = () => sendExpedition();
			expeditionButton.innerHTML = `
				Send Expedition
				<div class="cost-display">Cost: ${expeditionCost} processing - Explore distant lands for oil and relics</div>
			`;
			huntingButtons.appendChild(expeditionButton);

			// Send explorers button (only show after trading post built) - 1000 cost
			if (gameState.buildings.tradingPost > 0) {
				const exploreCost = 1000;
				const canExplore = currentCatpower >= exploreCost;
				
				const exploreButton = document.createElement('button');
				exploreButton.className = `action-button ${!canExplore ? 'disabled' : ''}`;
				exploreButton.disabled = !canExplore;
				exploreButton.onclick = () => sendExplorers();
				exploreButton.innerHTML = `
					Send Explorers
					<div class="cost-display">Cost: ${exploreCost} processing - Search for new civilizations to trade with</div>
				`;
				huntingButtons.appendChild(exploreButton);
			}
			
			// Display hunting bonus and hunters info
			const statusDiv = document.createElement('div');
			statusDiv.className = 'expedition-progress';
			statusDiv.innerHTML = `
				<p><strong>Hunting Bonus:</strong> +${((huntingBonus - 1) * 100).toFixed(0)}%</p>
				<p><strong>Hunters:</strong> ${gameState.population.jobs.hunters || 0} (generating ${((gameState.population.jobs.hunters || 0) * 0.4).toFixed(1)} processing/sec)</p>
				<p><strong>Expeditions Completed:</strong> ${gameState.expeditions.completed}</p>
			`;
			huntingButtons.appendChild(statusDiv);
		}

		function performHunt() {
			const huntCost = 100;
			if (gameState.resources.processing < huntCost) return;
			
			gameState.resources.processing -= huntCost;
			
			// Calculate hunting bonus
			let huntingBonus = 1.0;
			if (gameState.buildings.workshop > 0) {
				huntingBonus += 0.5;
			}
			
			// Always get furs
			const fursGained = Math.floor((Math.random() * 80 + Math.random() * (65 * huntingBonus)) + 1);
			gameState.resources.furs += fursGained;
			
			let results = [`${fursGained} furs`];
			
			// Chance for ivory (20% base)
			if (Math.random() < 0.2 * huntingBonus) {
				const ivoryGained = Math.floor(Math.random() * 3) + 1;
				gameState.resources.ivory += ivoryGained;
				results.push(`${ivoryGained} ivory`);
			}
			
			// Small chance for unicorns (2% base)
			if (Math.random() < 0.02 * huntingBonus) {
				gameState.resources.unicorns += 1;
				results.push(`1 unicorn!`);
			}
			
			// Very small chance for oil (1% base, only if expeditions completed)
			if (gameState.expeditions && gameState.expeditions.completed >= 5 && Math.random() < 0.01 * huntingBonus) {
				const oilGained = Math.floor(Math.random() * 3) + 1;
				gameState.resources.oil += oilGained;
				results.push(`${oilGained} oil`);
				
				// Force oil to show in display
				if (!document.getElementById('oil-amount')) {
					addResourceToDisplay('oil');
				}
			}
			
			// Track hunts for achievements
			gameState.stats.huntsCompleted = (gameState.stats.huntsCompleted || 0) + 1;
			
			logMessage(`Hunt returned with: ${results.join(', ')}`);
			updateHuntingSection();
			updateDisplay();
			checkAchievements();
		}

		function updateWorkshopTab() {
			const workshopContent = document.getElementById('workshop-content');
			
			if (gameState.buildings.workshop === 0) {
				workshopContent.innerHTML = '<p>Build a workshop to unlock crafting...</p>';
				return;
			}
			
			// Initialize unlocked recipes if it doesn't exist
			if (!gameState.unlockedRecipes) {
				gameState.unlockedRecipes = {
					steel: false,
					gear: false,
					alloy: false,
					concrete: false,
					tradeShip: false,
					scaffold: false,
					plate: false,
					parchment: false,
					manuscript: false
				};
			}
			
			workshopContent.innerHTML = '<h4>Workshop Upgrades</h4><div id="workshop-upgrades"></div><h4>Available Recipes</h4>';
			
			// Workshop Upgrades Section
			const upgradesDiv = document.getElementById('workshop-upgrades');
			const upgrades = [
				{
					name: 'Mineral Hoes',
					cost: { science: 100, minerals: 50 },
					effect: 'Farmers 50% more effective',
					unlocked: () => gameState.population.jobs.farmers > 0,
					key: 'mineralHoes'
				},
				{
					name: 'Iron Hoes', 
					cost: { science: 200, iron: 25 },
					effect: 'Farmers 30% more effective',
					unlocked: () => gameState.workshopUpgrades.mineralHoes && gameState.resources.iron >= 10,
					key: 'ironHoes'
				},
				{
					name: 'Composite Bow',
					cost: { science: 200, materials: 75 },
					effect: 'Hunters 50% more effective, +100 processing cap',
					unlocked: () => gameState.technologies.archery,
					key: 'compositeBow'
				}
			];
			
			upgrades.forEach(upgrade => {
				if (upgrade.unlocked() && !gameState.workshopUpgrades[upgrade.key]) {
					let canAfford = true;
					let costText = '';
					for (let resource in upgrade.cost) {
						if (Math.floor(gameState.resources[resource]) < upgrade.cost[resource]) {
							canAfford = false;
						}
						costText += `${upgrade.cost[resource]} ${resource}, `;
					}
					costText = costText.slice(0, -2);
					
					const div = document.createElement('div');
					div.className = 'building-item';
					div.innerHTML = `
						<h4>${upgrade.name}</h4>
						<p>${upgrade.effect}</p>
						<button class="action-button tech-button" 
								onclick="purchaseUpgrade('${upgrade.key}')" 
								${!canAfford ? 'disabled' : ''}>
							Purchase (${costText})
						</button>
					`;
					upgradesDiv.appendChild(div);
				} else if (gameState.workshopUpgrades[upgrade.key]) {
					const div = document.createElement('div');
					div.className = 'building-item';
					div.innerHTML = `
						<h4>${upgrade.name}</h4>
						<p>${upgrade.effect}</p>
						<p style="color: #2ecc71;">‚úì Purchased</p>
					`;
					upgradesDiv.appendChild(div);
				}
			});
			
			// Crafting Section with permanent unlocking and bulk crafting
			const recipes = [
				{
					name: 'Steel',
					inputs: { iron: 10, coal: 5 },
					output: { steel: 1 },
					unlocked: () => gameState.unlockedRecipes.steel || (gameState.resources.iron >= 5 && gameState.resources.coal >= 5)
				},
				{
					name: 'Gear',
					inputs: { steel: 5, coal: 10 },
					output: { gear: 1 },
					unlocked: () => gameState.unlockedRecipes.gear || gameState.resources.steel >= 1
				},
				{
					name: 'Alloy',
					inputs: { iron: 25, titanium: 10 },
					output: { alloy: 1 },
					unlocked: () => gameState.unlockedRecipes.alloy || gameState.resources.titanium >= 5
				},
				{
					name: 'Concrete',
					inputs: { iron: 25, minerals: 1250, coal: 25 },
					output: { concrete: 1 },
					unlocked: () => gameState.unlockedRecipes.concrete || gameState.resources.minerals >= 500
				},
				{
					name: 'Trade Ship',
					inputs: { materials: 100, iron: 50, starcharts: 25 },
					output: { ships: 1 },
					unlocked: () => gameState.unlockedRecipes.tradeShip || (gameState.technologies.navigation && gameState.resources.starcharts >= 10)
				},
				{
					name: 'Scaffold',
					inputs: { materials: 50 },
					output: { scaffolds: 1 },
					unlocked: () => gameState.unlockedRecipes.scaffold || gameState.buildings.workshop >= 1
				},
				{
					name: 'Plate',
					inputs: { iron: 125 },
					output: { plates: 1 },
					unlocked: () => gameState.unlockedRecipes.plate || gameState.resources.iron >= 100
				},
				{
					name: 'Parchment',
					inputs: { furs: 175 },
					output: { parchment: 1 },
					unlocked: () => gameState.unlockedRecipes.parchment || gameState.resources.furs >= 100
				},
				{
					name: 'Manuscript',
					inputs: { parchment: 25, culture: 400 },
					output: { manuscripts: 1 },
					unlocked: () => gameState.unlockedRecipes.manuscript || (gameState.resources.parchment >= 10 && gameState.resources.culture >= 200)
				},
				{
					name: 'Blueprint',
					inputs: { furs: 35, culture: 1500 },
					output: { blueprints: 1 },
					unlocked: () => gameState.unlockedRecipes.blueprints || (gameState.resources.furs >= 25 && gameState.resources.culture >= 500)
				},
				{
					name: 'Thorium',
					inputs: { uranium: 250 },
					output: { thorium: 1 },
					unlocked: () => gameState.unlockedRecipes.thorium || gameState.resources.uranium >= 100
				},
				{
					name: 'Kerosene',
					inputs: { oil: 7500 },
					output: { kerosene: 1 },
					unlocked: () => gameState.unlockedRecipes.kerosene || gameState.resources.oil >= 1000
				},
				{
					name: 'Compendium',
					inputs: { manuscripts: 50, science: 10000 },
					output: { compendium: 1 },
					unlocked: () => gameState.unlockedRecipes.compendium || (gameState.resources.manuscripts >= 25 && gameState.resources.science >= 5000)
				},
				{
					name: 'Megalith',
					inputs: { stone: 5000, steel: 50, science: 2500 },
					output: { megalith: 1 },
					unlocked: () => gameState.unlockedRecipes.megalith || (gameState.resources.stone >= 2500 && gameState.resources.steel >= 25)
				}				
			];
			
			recipes.forEach(recipe => {
				const recipeName = recipe.name.toLowerCase().replace(' ', '');
				const permanentKey = recipeName === 'tradeship' ? 'tradeShip' : recipeName;
				const isPermanentlyUnlocked = gameState.unlockedRecipes[permanentKey];
				
				if (recipe.unlocked() || isPermanentlyUnlocked) {
					// Mark recipe as permanently unlocked if not already
					if (!isPermanentlyUnlocked) {
						gameState.unlockedRecipes[permanentKey] = true;
					}
					
					let canCraft = true;
					let canCraft10 = true;
					let canCraft100 = true;
					let inputText = '';
					
					for (let resource in recipe.inputs) {
						const needed = recipe.inputs[resource];
						const available = Math.floor(gameState.resources[resource] || 0);
						const hasEnough = available >= needed;
						const color = hasEnough ? '#2ecc71' : '#e74c3c';
						
						if (!hasEnough) canCraft = false;
						if (available < needed * 10) canCraft10 = false;
						if (available < needed * 100) canCraft100 = false;
						
						inputText += `<span style="color: ${color};">${needed} ${resource}</span>, `;
					}
					inputText = inputText.slice(0, -2);
					
					let outputText = '';
					for (let resource in recipe.output) {
						outputText += `${recipe.output[resource]} ${resource}`;
					}
					
					const div = document.createElement('div');
					div.className = 'building-item';
					div.innerHTML = `
						<h4>${recipe.name}</h4>
						<p>Craft: ${inputText} ‚Üí ${outputText}</p>
						<div style="display: flex; gap: 5px; align-items: center;">
							<button class="action-button" 
									onclick="craft('${recipe.name}', 1)" 
									${!canCraft ? 'disabled' : ''}
									style="flex: 1;">
								Craft ${recipe.name}
							</button>
							${canCraft10 ? `
								<button class="action-button" 
										onclick="craft('${recipe.name}', 10)" 
										style="width: 60px; font-size: 12px;">
									x10
								</button>
							` : ''}
							${canCraft100 ? `
								<button class="action-button" 
										onclick="craft('${recipe.name}', 100)" 
										style="width: 60px; font-size: 12px;">
									x100
								</button>
							` : ''}
						</div>
					`;
					workshopContent.appendChild(div);
				}
			});
		}

		function enforceMaxBuildingLimits() {
			if (gameState.buildings.tradingPost > 1) {
				gameState.buildings.tradingPost = 1;
				logMessage("Trading Post count reduced to 1 (max limit)");
			}
			if (gameState.buildings.observatory > 1) {
				gameState.buildings.observatory = 1;
				logMessage("Observatory count reduced to 1 (max limit)");
			}
			if (gameState.buildings.launchPad > 1) {
				gameState.buildings.launchPad = 1;
				logMessage("Launch Pad count reduced to 1 (max limit)");
			}
		}

		function craft(recipeName, quantity = 1) {
			const recipes = {
				'Steel': { inputs: { iron: 10, coal: 5 }, output: { steel: 1 } },
				'Gear': { inputs: { steel: 5, coal: 10 }, output: { gear: 1 } },
				'Alloy': { inputs: { iron: 25, titanium: 10 }, output: { alloy: 1 } },
				'Concrete': { inputs: { iron: 25, minerals: 1250, coal: 25 }, output: { concrete: 1 } },
				'Trade Ship': { inputs: { materials: 100, iron: 50, starcharts: 25 }, output: { ships: 1 } },
				'Scaffold': { inputs: { materials: 50 }, output: { scaffolds: 1 } },
				'Plate': { inputs: { iron: 125 }, output: { plates: 1 } },
				'Parchment': { inputs: { furs: 175 }, output: { parchment: 1 } },
				'Manuscript': { inputs: { parchment: 25, culture: 400 }, output: { manuscripts: 1 } },
				'Blueprint': { inputs: { furs: 35, culture: 1500 }, output: { blueprints: 1 } },
				'Thorium': { inputs: { uranium: 250 }, output: { thorium: 1 } },
				'Kerosene': { inputs: { oil: 7500 }, output: { kerosene: 1 } },
				'Compendium': { inputs: { manuscripts: 50, science: 10000 }, output: { compendium: 1 } },
				'Megalith': { inputs: { stone: 5000, steel: 50, science: 2500 }, output: { megalith: 1 } }
			};
			
			const recipe = recipes[recipeName];
			if (!recipe) return;
			
			// Check if we can afford all inputs for the quantity
			for (let resource in recipe.inputs) {
				if (Math.floor(gameState.resources[resource] || 0) < recipe.inputs[resource] * quantity) {
					logMessage(`Not enough ${resource} to craft ${quantity}x ${recipeName}`);
					return;
				}
			}
			
			// Pay the costs
			for (let resource in recipe.inputs) {
				gameState.resources[resource] -= recipe.inputs[resource] * quantity;
			}
			
			// Add outputs
			for (let resource in recipe.output) {
				if (!gameState.resources[resource]) gameState.resources[resource] = 0;
				gameState.resources[resource] += recipe.output[resource] * quantity;
			}
			
			// Track crafting for achievements
			if (recipeName === 'Steel') {
				gameState.stats.steelCrafted = (gameState.stats.steelCrafted || 0) + quantity;
			}
			
			logMessage(`Crafted ${quantity}x ${recipeName}!`);
			updateWorkshopTab();
			updateDisplay();
			checkAchievements();
		}

		function addSpaceTab() {
				// Add space tab to the tab container
				const tabContainer = document.querySelector('.tab-container');
				if (!document.querySelector('.tab[onclick*="space"]')) {
					const spaceTabButton = document.createElement('button');
					spaceTabButton.className = 'tab';
					spaceTabButton.onclick = () => showTab('space');
					spaceTabButton.textContent = 'Space';
					tabContainer.appendChild(spaceTabButton);
					
					// Add space tab content after workshop tab
					const workshopTab = document.getElementById('workshop-tab');
					const spaceTab = document.createElement('div');
					spaceTab.id = 'space-tab';
					spaceTab.className = 'tab-content';
					spaceTab.innerHTML = `
						<h3>Space Program</h3>
						<div id="space-missions">
							<h4>Mission Control</h4>
							<button class="action-button" onclick="launchMission('orbit')" 
									${!canLaunchMission('orbit') ? 'disabled' : ''}>
								Launch Orbital Mission
								<div class="cost-display">Cost: 50 oil, 25 science - Gain science and space experience</div>
							</button>
							<button class="action-button" onclick="launchMission('moon')" 
									${!canLaunchMission('moon') ? 'disabled' : ''}>
								Launch Moon Mission  
								<div class="cost-display">Cost: 150 oil, 100 science - High-value lunar exploration</div>
							</button>
						</div>
						<div id="space-progress">
							<p><strong>Missions Completed:</strong> <span id="mission-count">${gameState.space.missions}</span></p>
							<p><strong>Space Infrastructure:</strong></p>
							<ul>
								<li>Satellites: <span id="satellite-count">${gameState.space.satellites}</span></li>
								<li>Space Stations: <span id="station-count">${gameState.space.spaceStations}</span></li>
								<li>Moon Bases: <span id="moonbase-count">${gameState.space.moonBases}</span></li>
							</ul>
						</div>
					`;
					workshopTab.parentNode.insertBefore(spaceTab, workshopTab.nextSibling);
				}
			
		}

		function canLaunchMission(type) {
			if (!gameState.buildings.launchPad || gameState.buildings.launchPad === 0) return false;
			
			if (type === 'orbit') {
				return gameState.resources.oil >= 50 && gameState.resources.science >= 25;
			} else if (type === 'moon') {
				return gameState.resources.oil >= 150 && gameState.resources.science >= 100 && gameState.space.satellites >= 1;
			}
			return false;
		}

		function launchMission(type) {
			if (!canLaunchMission(type)) return;
			
			if (type === 'orbit') {
				gameState.resources.oil -= 50;
				gameState.resources.science -= 25;
				gameState.space.missions++;
				
				const scienceGain = Math.floor(Math.random() * 500) + 200;
				gameState.resources.science += scienceGain;
				logMessage(`üöÄ Orbital mission successful! Gained ${scienceGain} science.`);
				
			} else if (type === 'moon') {
				gameState.resources.oil -= 150;
				gameState.resources.science -= 100;
				gameState.space.missions++;
				
				const uraniumGain = Math.floor(Math.random() * 5) + 2;
				const scienceGain = Math.floor(Math.random() * 1500) + 800;
				gameState.resources.uranium = (gameState.resources.uranium || 0) + uraniumGain;
				gameState.resources.science += scienceGain;
				logMessage(`üåô Moon mission successful! Found ${uraniumGain} uranium and ${scienceGain} science.`);
			}
			
			updateSpaceTab();
			updateDisplay();
		}

		function updateSpaceTab() {
			if (document.getElementById('mission-count')) {
				document.getElementById('mission-count').textContent = gameState.space.missions;
				document.getElementById('satellite-count').textContent = gameState.space.satellites;
				document.getElementById('station-count').textContent = gameState.space.spaceStations;
				document.getElementById('moonbase-count').textContent = gameState.space.moonBases;
			}
		}

		function buildGenerator() {
			const cost = buildingDefs.catnipField.cost.energy;
			if (gameState.resources.energy >= cost) {
				gameState.resources.energy -= cost;
				gameState.buildings.catnipField++;
				buildingDefs.catnipField.onBuild();
				
				logMessage("You built an energy generator! It will grow energy automatically.");
				
				// Show field management section
				showElement('field-management');
				updateFieldDisplay();
				updateDisplay();
			}
		}

        function sellCatnipField() {
            if (gameState.buildings.catnipField > 0) {
                gameState.buildings.catnipField--;
                gameState.resourcesProduction.energy = Math.max(0, gameState.resourcesProduction.energy - 0.63);
                gameState.resources.energy += 5; // Get half back when selling
                logMessage("You dismantled an energy generator for 5 energy.");
                
                if (gameState.buildings.catnipField === 0) {
                    document.getElementById('field-management').classList.add('hidden');
                }
                
                updateFieldDisplay();
                updateDisplay();
            }
        }

		function updateFieldDisplay() {
			const fieldsDisplay = document.getElementById('energy-fields-display');
			if (!fieldsDisplay) return; // Safety check
			
			fieldsDisplay.innerHTML = ''; // Clear existing content
			
			// Energy Generator Section
			if (gameState.buildings.catnipField > 0) {
				const totalProduction = (gameState.buildings.catnipField * 0.63).toFixed(2);
				const seasonMultipliers = [1.5, 1.0, 0.75, 0.25];
				const seasonalProduction = (totalProduction * seasonMultipliers[gameState.stats.season]).toFixed(2);
				const seasons = ['Spring', 'Summer', 'Autumn', 'Winter'];
				
				const energyDiv = document.createElement('div');
				energyDiv.className = 'field-display';
				energyDiv.innerHTML = `
					<div class="field-header">
						<span class="field-title">Energy Generator (${gameState.buildings.catnipField})</span>
						<button class="sell-button" onclick="sellCatnipField()" style="${gameSettings.hideSellButtons ? 'display: none;' : ''}">sell</button>
					</div>
					<p>Install energy generators in the facility.<br>
					Generators have +50% efficiency in optimal conditions and -75% production in Winter</p>
					<div class="field-effects">
						<div class="effect-line">Effects:</div>
						<div class="effect-line">Energy production: ${seasonalProduction}/sec (${seasons[gameState.stats.season]})</div>
						<div class="effect-line">Base production: ${totalProduction}/sec</div>
					</div>
				`;
				fieldsDisplay.appendChild(energyDiv);
			}
			
			// Smelter Management Section
			if (gameState.buildings.smelter > 0) {
				const smelterDiv = document.createElement('div');
				smelterDiv.className = 'field-display';
				smelterDiv.style.backgroundColor = 'rgba(230, 126, 34, 0.1)';
				smelterDiv.style.borderColor = '#e67e22';
				
				const activeSmelters = gameState.smelterActive || 0;
				const totalSmelters = gameState.buildings.smelter;
				
				smelterDiv.innerHTML = `
					<div class="field-header">
						<span class="field-title">Smelter (${activeSmelters}/${totalSmelters})</span>
						<button class="sell-button" onclick="sellSmelter()" style="${gameSettings.hideSellButtons ? 'display: none;' : ''}">sell</button>
					</div>
					<p>Convert minerals and wood to iron when active. Each smelter consumes 0.1 minerals/sec and 0.05 wood/sec for 0.02 iron/sec</p>
					<div class="job-controls" style="margin-top: 10px;">
						<button class="job-button" onclick="adjustSmelters(-1)" ${activeSmelters <= 0 ? 'disabled' : ''}>-</button>
						<span style="min-width: 60px; text-align: center; margin: 0 10px;">${activeSmelters}/${totalSmelters}</span>
						<button class="job-button" onclick="adjustSmelters(1)" ${activeSmelters >= totalSmelters ? 'disabled' : ''}>+</button>
					</div>
				`;
				
				fieldsDisplay.appendChild(smelterDiv);
			}
		}

		function adjustSmelters(change) {
			const current = gameState.smelterActive || 0;
			const total = gameState.buildings.smelter;
			
			const newActive = Math.max(0, Math.min(total, current + change));
			gameState.smelterActive = newActive;
			
			updateFieldDisplay();
			logMessage(`${newActive} smelters now active.`);
		}

		function sellSmelter() {
			if (gameState.buildings.smelter > 0) {
				gameState.buildings.smelter--;
				gameState.smelterActive = Math.min(gameState.smelterActive || 0, gameState.buildings.smelter);
				// Return some resources
				gameState.resources.materials += 100;
				logMessage("Sold a smelter for 100 materials.");
				updateFieldDisplay();
				updateDisplay();
			}
		}

		function refineCatnip(quantity = 1) {
			const cost = 100 * quantity;
			const materialsGained = 1 * quantity;
			
			if (gameState.resources.energy >= cost) {
				gameState.resources.energy -= cost;
				gameState.resources.materials += materialsGained;
				gameState.stats.totalEnergyRefined += quantity;
				
				const plural = quantity > 1 ? 's' : '';
				logMessage(`You refined ${cost} energy into ${materialsGained} materials${plural}.`);
				updateDisplay();
			}
		}

		function updateRefineButton() {
			const refineBtn = document.getElementById('refine-energy-btn');
			if (refineBtn && !refineBtn.classList.contains('hidden')) {
				const canRefine10 = gameState.resources.energy >= 1000;
				const canRefine100 = gameState.resources.energy >= 10000;
				
				refineBtn.innerHTML = `
					<div style="display: flex; gap: 5px; align-items: center; width: 100%;">
						<button class="action-button" onclick="refineCatnip(1)" 
								${gameState.resources.energy < 100 ? 'disabled' : ''}
								style="flex: 1;">
							Refine energy (100 ‚Üí 1 materials)
						</button>
						${canRefine10 ? `
							<button class="action-button" onclick="refineCatnip(10)" 
									style="width: 60px; font-size: 12px;">
								x10
							</button>
						` : ''}
						${canRefine100 ? `
							<button class="action-button" onclick="refineCatnip(100)" 
									style="width: 60px; font-size: 12px;">
								x100
							</button>
						` : ''}
					</div>
				`;
			}
		}

		function unlockTrading() {
			if (gameState.buildings.tradingPost > 0) {
				// Unlock first race
				gameState.tradingRaces.lizards.unlocked = true;
				updateTradeTab();
			}
		}

		function updateTradeTab() {
			const tradeContent = document.getElementById('trade-content');
			
			if (gameState.buildings.tradingPost === 0) {
				tradeContent.innerHTML = '<p>Build a trading post to unlock trade with other civilizations...</p>';
				return;
			}
			
			tradeContent.innerHTML = '<h4>Trading Partners</h4>';
			
			const races = [
				{
					key: 'lizards',
					name: 'Lizards',
					wants: 'minerals',
					gives: 'materials',
					ratio: { minerals: 100, materials: 50 },
					unlock: () => true
				},
				{
					key: 'sharks',
					name: 'Sharks',
					wants: 'iron',
					gives: 'energy',
					ratio: { iron: 25, energy: 350 },
					unlock: () => gameState.tradingRaces.lizards.standing >= 10
				},
				{
					key: 'griffins',
					name: 'Griffins',
					wants: 'materials',
					gives: 'iron',
					ratio: { materials: 500, iron: 25 },
					unlock: () => gameState.tradingRaces.sharks.standing >= 10
				},
				{
					key: 'nagas',
					name: 'Nagas',
					wants: 'minerals',
					gives: 'science',
					ratio: { minerals: 350, science: 100 },
					unlock: () => gameState.tradingRaces.griffins.standing >= 5
				},
				{
					key: 'zebras',
					name: 'Zebras',
					wants: 'furs',
					gives: 'titanium',
					ratio: { furs: 500, titanium: 1.5 },
					unlock: () => gameState.tradingRaces.nagas.standing >= 5
				}
			];
			
			races.forEach(race => {
				if (gameState.tradingRaces[race.key].unlocked) {
					
					const standing = gameState.tradingRaces[race.key].standing;
					const standingBonus = 1 + (standing * 0.01);
					
					const cost = Math.floor(race.ratio[race.wants] / standingBonus);
					const gain = Math.floor(race.ratio[race.gives] * standingBonus);
					
					const canTrade = (gameState.resources[race.wants] || 0) >= cost;
					
					const div = document.createElement('div');
					div.className = 'building-item';
					div.innerHTML = `
						<h4>${race.name} (Standing: ${standing})</h4>
						<p>Trade ${cost} ${race.wants} for ${gain} ${race.gives}</p>
						<button class="action-button" 
								onclick="tradeWith('${race.key}')" 
								${!canTrade ? 'disabled' : ''}>
							Trade with ${race.name}
						</button>
					`;
					tradeContent.appendChild(div);
				}
			});
		}

		function sendExplorers() {
			const exploreCost = 1000;
			if (gameState.resources.processing < exploreCost) return;
			
			gameState.resources.processing -= exploreCost;
			
			let foundRace = null;
			
			// Check each race with reasonable unlock conditions
			if (!gameState.tradingRaces.sharks.unlocked && gameState.stats.year >= 5 && Math.random() < 0.35) {
				foundRace = 'sharks';
			} else if (!gameState.tradingRaces.griffins.unlocked && gameState.stats.year >= 8 && Math.random() < 0.30) {
				foundRace = 'griffins';
			} else if (!gameState.tradingRaces.nagas.unlocked && gameState.stats.year >= 12 && Math.random() < 0.25) {
				foundRace = 'nagas';
			} else if (!gameState.tradingRaces.zebras.unlocked && gameState.stats.year >= 15 && Math.random() < 0.20) {
				foundRace = 'zebras';
			}
			
			if (foundRace) {
				gameState.tradingRaces[foundRace].unlocked = true;
				logMessage(`Your explorers discovered the ${foundRace}! New trading opportunities available.`);
			} else {
				logMessage("Your explorers found no new civilizations this time.");
				// Small refund so it's not a total loss
				gameState.resources.processing += 200;
			}
			
			updateTradeTab();
			updateDisplay();
		}

		function sendExpedition() {
			const expeditionCost = 500;
			if (gameState.resources.processing < expeditionCost) return;
			
			gameState.resources.processing -= expeditionCost;
			gameState.expeditions.completed++;
			
			// Chance for oil (30%)
			if (Math.random() < 0.3) {
				const oilFound = Math.floor(Math.random() * 10) + 5;
				gameState.resources.oil += oilFound;
				logMessage(`Expedition found ${oilFound} oil!`);
				
				// Force oil to show in display
				if (!document.getElementById('oil-amount')) {
					addResourceToDisplay('oil');
				}
			} else {
				logMessage("Expedition returned with nothing valuable.");
			}
			
			updateHuntingSection();
			updateDisplay();
		}

		function tradeWith(raceKey) {
			const races = {
				lizards: { wants: 'minerals', gives: 'materials', ratio: { minerals: 100, materials: 50 } },
				sharks: { wants: 'iron', gives: 'energy', ratio: { iron: 25, energy: 350 } },
				griffins: { wants: 'materials', gives: 'iron', ratio: { materials: 500, iron: 25 } },
				nagas: { wants: 'minerals', gives: 'science', ratio: { minerals: 350, science: 100 } },
				zebras: { wants: 'furs', gives: 'titanium', ratio: { furs: 500, titanium: 1.5 } }
			};
			
			const race = races[raceKey];
			if (!race) return;
			
			const standing = gameState.tradingRaces[raceKey].standing;
			const standingBonus = 1 + (standing * 0.01);
			
			// NEW: Trade ships provide 2% bonus per ship (max 50% bonus)
			const shipCount = gameState.resources.ships || 0;
			const shipBonus = Math.min(0.5, shipCount * 0.02); // Cap at 50%
			const totalBonus = standingBonus + shipBonus;

			const cost = Math.floor(race.ratio[race.wants] / totalBonus);
			const gain = Math.floor(race.ratio[race.gives] * totalBonus);
			
			if (Math.floor(gameState.resources[race.wants]) >= cost) {
				// Check if trade would exceed storage cap
				const currentAmount = gameState.resources[race.gives] || 0;
				const storageLimit = gameState.resourceLimits[race.gives] || Infinity;
				
				if (currentAmount + gain > storageLimit) {
					logMessage(`Trade blocked: Not enough ${race.gives} storage space! (${currentAmount}/${storageLimit})`);
					return;
				}
				
				gameState.resources[race.wants] -= cost;
				
				if (race.gives === 'titanium') {
					if (!gameState.resources.titanium) gameState.resources.titanium = 0;
					gameState.resources.titanium += gain;
				} else {
					gameState.resources[race.gives] += gain;
				}
				
				gameState.tradingRaces[raceKey].standing++;
				gameState.stats.tradesCompleted = (gameState.stats.tradesCompleted || 0) + 1;
				
				logMessage(`Traded ${cost} ${race.wants} for ${gain} ${race.gives} with the ${raceKey}! (${shipCount} ships provided +${(shipBonus*100).toFixed(0)}% bonus)`);
				updateTradeTab();
				updateDisplay();
				checkAchievements();
			}
		}

        function hunt() {
            if (Math.random() < 0.7) {
                const furs = Math.floor(Math.random() * 3) + 1;
                gameState.resources.furs += furs;
                logMessage(`Your hunters returned with ${furs} furs!`);
            } else {
                logMessage("Your hunters returned empty-pawed.");
            }
            
            if (Math.random() < 0.1) {
                gameState.resources.ivory += 1;
                logMessage("Your hunters found ivory!");
            }
            
            updateDisplay();
        }

		function observeStars() {
			if (gameState.buildings.observatory === 0) return;
			
			const currentTime = Date.now();
			
			// Check if there's an active event
			if (!gameState.astronomy.eventActive) {
				logMessage("The sky is quiet. Wait for a celestial event to observe.");
				return;
			}
			
			// Check cooldown (5 minutes between observations)
			if (currentTime - gameState.astronomy.lastObservation < 300000) {
				const timeLeft = Math.ceil((300000 - (currentTime - gameState.astronomy.lastObservation)) / 60000);
				logMessage(`You must wait ${timeLeft} more minutes before observing again.`);
				return;
			}
			
			if (gameState.astronomy.observationsLeft <= 0) {
				logMessage("You have exhausted your observations for this celestial event.");
				return;
			}
			
			// Successful observation
			gameState.astronomy.observationsLeft--;
			gameState.astronomy.lastObservation = currentTime;
			
			const science = Math.random() * 10 + 5;
			gameState.resources.science += science;
			
			if (gameState.technologies.astronomy) {
				const starcharts = Math.floor(Math.random() * 3) + 1;
				gameState.resources.starcharts += starcharts;
				logMessage(`Observing the ${gameState.astronomy.eventType} grants ${science.toFixed(1)} science and ${starcharts} starcharts!`);
			} else {
				logMessage(`Observing the ${gameState.astronomy.eventType} grants ${science.toFixed(1)} science.`);
			}
			
			if (Math.random() < 0.05) {
				gameState.resources.unicorns += 1;
				logMessage("A unicorn appears from the cosmic void!");
			}
			
			if (gameState.astronomy.observationsLeft === 0) {
				gameState.astronomy.eventActive = false;
				logMessage(`The ${gameState.astronomy.eventType} has ended.`);
				gameState.astronomy.eventType = null;
			}
			
			updateDisplay();
		}

        function buildBuilding(buildingKey) {
            const building = buildingDefs[buildingKey];
            if (!building) return;
            
            // Check if we can afford it
            let canAfford = true;
            for (let resource in building.cost) {
                if (gameState.resources[resource] < building.cost[resource]) {
                    canAfford = false;
                    break;
                }
            }
            
            if (!canAfford) return;
            
            // Pay the cost
            for (let resource in building.cost) {
                gameState.resources[resource] -= building.cost[resource];
            }
            
            // Build it
            gameState.buildings[buildingKey]++;
            building.onBuild();
            
            logMessage(`Built a ${building.name}!`);
            checkAchievements();
            updateDisplay();
        }

        function researchTech(techKey) {
            const tech = techDefs[techKey];
            if (!tech || gameState.technologies[techKey]) return;
            
            // Check if we can afford it
            let canAfford = true;
            for (let resource in tech.cost) {
                if (Math.floor(gameState.resources[resource]) < tech.cost[resource]) {
                    canAfford = false;
                    break;
                }
            }
            
            if (!canAfford) return;
            
            // Pay the cost
            for (let resource in tech.cost) {
                gameState.resources[resource] -= tech.cost[resource];
            }
            
            // Research it
            gameState.technologies[techKey] = true;
            tech.onResearch();
            
            logMessage(`Researched ${tech.name}!`);
            checkAchievements();
            updateDisplay();
        }

		function purchaseReligion(religionKey) {
			const religion = religionDefs[religionKey];
			if (!religion) return;
			
			// Check if we can afford it
			let canAfford = true;
			for (let resource in religion.cost) {
				if (Math.floor(gameState.resources[resource]) < religion.cost[resource]) {
					canAfford = false;
					break;
				}
			}
			
			if (!canAfford) return;
			
			// Pay the cost
			for (let resource in religion.cost) {
				gameState.resources[resource] -= religion.cost[resource];
			}
			
			// Purchase it
			if (religionKey === 'sunAltar') {
				gameState.religion.sunAltar++;
			} else {
				gameState.religion[religionKey] = true;
			}
			
			religion.onPurchase?.();
			
			logMessage(`Acquired ${religion.name}!`);
			updateDisplay();
		}

        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Hide all tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Show selected tab button
            event.target.classList.add('active');
        }

        function showElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.remove('hidden');
            }
        }

		function getMetaphysicsDiscount() {
			let discount = 0;
			if (gameState.metaphysics.goldenRatio) discount += 0.01618;
			if (gameState.metaphysics.divineProportion) discount += 0.03236;
			return discount;
		}

		function updateDisplay() {
			// Update resources with storage info
			for (let resource in gameState.resources) {
				const element = document.getElementById(resource + '-amount');
				if (element) {
					const current = Math.floor(gameState.resources[resource]);
					const limit = gameState.resourceLimits[resource];
					if (limit && limit < Infinity) {
						element.textContent = `${current.toLocaleString()}/${limit.toLocaleString()}`;
						// Color code based on capacity
						if (current >= limit * 0.9) {
							element.style.color = '#e74c3c'; // Red when nearly full
						} else if (current >= limit * 0.75) {
							element.style.color = '#f39c12'; // Orange when 75% full
						} else {
							element.style.color = '#2ecc71'; // Green when plenty of space
						}
					} else {
						element.textContent = current.toLocaleString();
						element.style.color = '#2ecc71';
					}
				}
				
				const rateElement = document.getElementById(resource + '-rate');
				if (rateElement && gameState.resourcesProduction[resource]) {
					let rate = gameState.resourcesProduction[resource];
					
					// Apply seasonal effects for display
					if (resource === 'energy') {
						const seasonMultipliers = [1.5, 1.0, 0.75, 0.25];
						rate *= seasonMultipliers[gameState.stats.season];
					}
					
					rateElement.textContent = rate > 0 ? `+${rate.toFixed(2)}/sec` : '';
				}
			}
			
			// Handle processing rate display separately
			const catpowerRateElement = document.getElementById('processing-rate');
			if (catpowerRateElement) {
				const catpowerRate = (gameState.population.jobs.hunters || 0) * 0.4;
				catpowerRateElement.textContent = catpowerRate > 0 ? `+${catpowerRate.toFixed(2)}/sec` : '';
			}
			
			// Update population
			document.getElementById('robots-amount').textContent = Math.floor(gameState.population.robots);
			document.getElementById('happiness-amount').textContent = Math.floor(gameState.population.happiness * 100) + '%';
			
			// Update energy fields summary
			updateCatnipFieldsSummary();
			
			// Update status
			const seasons = ['Spring', 'Summer', 'Autumn', 'Winter'];
			document.getElementById('current-season').textContent = seasons[gameState.stats.season];
			document.getElementById('current-year').textContent = gameState.stats.year;
			document.getElementById('faith-amount').textContent = Math.floor(gameState.resources.faith);
			document.getElementById('science-amount').textContent = Math.floor(gameState.resources.science);

			if (gameState.prestige.karma > 0 || gameState.prestige.paragon > 0) {
				let prestigeText = '';
				if (gameState.prestige.karma > 0) prestigeText += `<p><strong>Karma:</strong> <span style="color: #e74c3c;">${gameState.prestige.karma}</span></p>`;
				if (gameState.prestige.paragon > 0) prestigeText += `<p><strong>Paragon:</strong> <span style="color: #f39c12;">${gameState.prestige.paragon}</span></p>`;
				
				if (!document.getElementById('prestige-display')) {
					const prestigeDiv = document.createElement('div');
					prestigeDiv.id = 'prestige-display';
					prestigeDiv.innerHTML = prestigeText;
					document.getElementById('status-info').appendChild(prestigeDiv);
				} else {
					document.getElementById('prestige-display').innerHTML = prestigeText;
				}
			}
			
			updateJobManagement();
			updateRefineButton();
			updateBuildingsList();
			updateTechList();
			updateReligionList();
			updateFieldDisplay();
			updateObjectives();
			updateTradeTab();
			if (gameState.technologies.archery) {
				updateHuntingSection();
			}
			if (gameState.buildings.workshop > 0) {
				updateWorkshopTab();
			}
			if (document.getElementById('metaphysics-upgrades')) {
				updateMetaphysicsTab();
			}
		}

        function updateCatnipFieldsSummary() {
            const fieldsCount = gameState.buildings.catnipField || 0;
            if (fieldsCount > 0) {
                showElement('energy-fields-summary');
                document.getElementById('total-fields').textContent = fieldsCount;
                
                const baseProduction = fieldsCount * 0.63;
                const seasonMultipliers = [1.5, 1.0, 0.75, 0.25];
                const currentProduction = baseProduction * seasonMultipliers[gameState.stats.season];
                
                document.getElementById('fields-production').textContent = `+${currentProduction.toFixed(2)}/sec`;
            } else {
                document.getElementById('energy-fields-summary').classList.add('hidden');
            }
        }

		function updateBuildingsList() {
			const buildingsList = document.getElementById('buildings-list');
			buildingsList.innerHTML = '';
			
			for (let buildingKey in buildingDefs) {
				const building = buildingDefs[buildingKey];
				const buildingCount = gameState.buildings[buildingKey] || 0;
				const isVisible = building.unlocked() || buildingCount > 0;
				
				if (isVisible) {
					const div = document.createElement('div');
					div.className = 'building-item';
					
					// Check if building is at max capacity
					const isAtMaxCapacity = building.maxBuildable && buildingCount >= building.maxBuildable;
					
					const discount = getMetaphysicsDiscount();
					let canAfford = true;
					let costText = '';
					for (let resource in building.cost) {
						const actualCost = Math.floor(building.cost[resource] * (1 - discount));
						const available = Math.floor(gameState.resources[resource] || 0);
						const hasEnough = available >= actualCost;
						const color = hasEnough ? '#2ecc71' : '#e74c3c';
						
						if (!hasEnough) {
							canAfford = false;
						}
						costText += `<span style="color: ${color};">${actualCost} ${resource}</span>, `;
					}
					costText = costText.slice(0, -2);
					
					// Don't check for multiples if at max capacity
					let canAfford10 = false;
					let canAfford100 = false;
					
					if (!isAtMaxCapacity) {
						canAfford10 = true;
						canAfford100 = true;
						
						// Calculate how many we can actually build (respecting limits)
						const remainingCapacity = building.maxBuildable ? (building.maxBuildable - buildingCount) : Infinity;
						const maxToBuild10 = Math.min(10, remainingCapacity);
						const maxToBuild100 = Math.min(100, remainingCapacity);
						
						if (maxToBuild10 < 10) canAfford10 = false;
						if (maxToBuild100 < 100) canAfford100 = false;
						
						for (let resource in building.cost) {
							if (gameState.resources[resource] < building.cost[resource] * maxToBuild10) {
								canAfford10 = false;
							}
							if (gameState.resources[resource] < building.cost[resource] * maxToBuild100) {
								canAfford100 = false;
							}
						}
					}
					
					const buttonDisabled = !canAfford || isAtMaxCapacity;
					const buttonClass = buttonDisabled ? 'building-button disabled' : 'building-button';
					
					div.innerHTML = `
						<h4>${building.name} ${buildingCount > 0 ? `(${buildingCount})` : ''}${building.maxBuildable ? ` [${buildingCount}/${building.maxBuildable}]` : ''}</h4>
						<p>${building.description}</p>
						<p><strong>Effect:</strong> ${building.effect}</p>
						${buildingCount > 0 ? 
							`<p style="color: #2ecc71;"><strong>‚úì Built:</strong> ${buildingCount}${building.maxBuildable ? `/${building.maxBuildable}` : ''}</p>` : ''
						}
						${isAtMaxCapacity ? 
							`<p style="color: #e74c3c;"><strong>‚ö† Maximum reached!</strong></p>` : ''
						}
						<div style="display: flex; gap: 5px; align-items: center;">
							<button class="action-button ${buttonClass}" 
									onclick="buildBuilding('${buildingKey}', 1)" 
									${buttonDisabled ? 'disabled' : ''}
									style="flex: 1;">
								${isAtMaxCapacity ? 'Maximum Built' : `Build (${costText})`}
							</button>
							${canAfford10 && !isAtMaxCapacity ? `
								<button class="action-button building-button" 
										onclick="buildBuilding('${buildingKey}', 10)" 
										style="width: 60px; font-size: 12px;">
									x10
								</button>
							` : ''}
							${canAfford100 && !isAtMaxCapacity ? `
								<button class="action-button building-button" 
										onclick="buildBuilding('${buildingKey}', 100)" 
										style="width: 60px; font-size: 12px;">
									x100
								</button>
							` : ''}
						</div>
					`;
					buildingsList.appendChild(div);
				}
			}
			
			// Show "coming soon" buildings that are close to unlocking
			addComingSoonBuildings(buildingsList);
		}

		function buildBuilding(buildingKey, quantity = 1) {
			const building = buildingDefs[buildingKey];
			if (!building) return;
			
			// Check building limits
			if (building.maxBuildable && gameState.buildings[buildingKey] >= building.maxBuildable) {
				logMessage(`You can only build ${building.maxBuildable} ${building.name}.`);
				return;
			}
			
			// Adjust quantity if it would exceed limit
			if (building.maxBuildable) {
				const remaining = building.maxBuildable - gameState.buildings[buildingKey];
				quantity = Math.min(quantity, remaining);
				if (quantity <= 0) return;
			}
			
			// Apply metaphysics discount to costs
			const discount = getMetaphysicsDiscount();
			
			// Check if we can afford the quantity requested
			let canAfford = true;
			for (let resource in building.cost) {
				const actualCost = Math.floor(building.cost[resource] * (1 - discount)) * quantity;
				if (Math.floor(gameState.resources[resource]) < actualCost) {
					canAfford = false;
					break;
				}
			}
			
			if (!canAfford) return;
			
			// Pay the discounted cost for all buildings
			for (let resource in building.cost) {
				const actualCost = Math.floor(building.cost[resource] * (1 - discount)) * quantity;
				gameState.resources[resource] -= actualCost;
			}
			
			// Build them and apply effects ONE AT A TIME
			for (let i = 0; i < quantity; i++) {
				gameState.buildings[buildingKey]++;
				if (building.onBuild) {
					building.onBuild();
				}
			}
			
			recalculateStorageLimits();
			
			const plural = quantity > 1 ? 's' : '';
			logMessage(`Built ${quantity} ${building.name}${plural}!`);
			checkAchievements();
			updateDisplay();
		}

        function addComingSoonBuildings(buildingsList) {
            const comingSoonDiv = document.createElement('div');
            comingSoonDiv.innerHTML = '<h3 style="color: #95a5a6; margin-top: 20px;">Coming Soon...</h3>';
            let hasComingSoon = false;
            
            for (let buildingKey in buildingDefs) {
                const building = buildingDefs[buildingKey];
                const buildingCount = gameState.buildings[buildingKey] || 0;
                const isCurrentlyVisible = building.unlocked() || buildingCount > 0;
                
                if (!isCurrentlyVisible && isCloseToUnlocking(buildingKey)) {
                    hasComingSoon = true;
                    const div = document.createElement('div');
                    div.className = 'building-item';
                    div.style.opacity = '0.6';
                    div.style.border = '2px dashed #7f8c8d';
                    
                    let costText = '';
                    for (let resource in building.cost) {
                        costText += `${building.cost[resource]} ${resource}, `;
                    }
                    costText = costText.slice(0, -2);
                    
                    div.innerHTML = `
                        <h4>${building.name} üîí</h4>
                        <p>${building.description}</p>
                        <p><strong>Effect:</strong> ${building.effect}</p>
                        <p style="color: #f39c12;"><strong>Unlock Requirement:</strong> ${getUnlockHint(buildingKey)}</p>
                        <button class="action-button building-button" disabled>
                            Locked (${costText})
                        </button>
                    `;
                    comingSoonDiv.appendChild(div);
                }
            }
            
            if (hasComingSoon) {
                buildingsList.appendChild(comingSoonDiv);
            }
        }

        function isCloseToUnlocking(buildingKey) {
            const building = buildingDefs[buildingKey];
            
            // Show buildings that require technologies we're close to researching
            if (buildingKey === 'mine' && gameState.resources.science >= 25) return true;
            if (buildingKey === 'quarry' && (gameState.resources.minerals >= 10 || gameState.buildings.mine >= 1)) return true;
            if (buildingKey === 'shrine' && gameState.resources.stone >= 10) return true;
            if (buildingKey === 'warehouse' && gameState.resources.stone >= 25) return true;
            if (buildingKey === 'workshop' && gameState.resources.science >= 100) return true;
            if (buildingKey === 'smelter' && gameState.technologies.mining) return true;
            if (buildingKey === 'goldMine' && gameState.resources.science >= 75) return true;
            if (buildingKey === 'temple' && (gameState.resources.gold >= 5 || gameState.buildings.goldMine > 0)) return true;
            if (buildingKey === 'logHouse' && gameState.resources.science >= 75) return true;
            if (buildingKey === 'observatory' && gameState.resources.science >= 100) return true;
            if (buildingKey === 'academy' && gameState.buildings.library >= 1 && gameState.resources.science >= 100) return true;
            if (buildingKey === 'pasture' && (gameState.resources.ivory >= 5 || gameState.resources.unicorns >= 1)) return true;
            if (buildingKey === 'tradingPost' && gameState.resources.furs >= 25) return true;
            if (buildingKey === 'mint' && gameState.technologies.metalWorking && gameState.resources.steel >= 1) return true;

            return false;
        }

        function getUnlockHint(buildingKey) {
            switch(buildingKey) {
                case 'mine': return 'Research Mining (50 science)';
                case 'quarry': return 'Have 15+ minerals OR build a mine';
                case 'shrine': return 'Gather 15+ stone (from quarries)';
                case 'warehouse': return 'Gather 50+ stone';
                case 'workshop': return 'Research Engineering (200 science)';
                case 'smelter': return 'Research Metal Working + Build Workshop';
                case 'goldMine': return 'Research Metal Working + Build 2 Mines';
                case 'temple': return 'Acquire 20+ gold (build Gold Mine)';
                case 'logHouse': return 'Research Construction (100 science)';
                case 'observatory': return 'Research Astronomy (150 science)';
                case 'academy': return 'Build 2+ Libraries + 200 science';
                case 'pasture': return 'Find unicorns or gather 10+ ivory';
                case 'tradingPost': return 'Gather 50+ furs + 10+ gold';
				case 'mint': return 'Research Metal Working + Craft Steel';
                default: return 'Requirements not met';
            }
        }

		function autoAssignNewKittens() {
			if (!gameSettings.autoAssignJobs) return;
			
			const totalKittens = gameState.population.robots;
			const assignedKittens = Object.values(gameState.population.jobs).reduce((sum, count) => sum + count, 0);
			const freeKittens = totalKittens - assignedKittens;
			
			if (freeKittens <= 0) return;
			
			// Simple rotation through available jobs
			const availableJobs = [
				{ key: 'farmers', condition: () => gameState.buildings.catnipField > 0 },
				{ key: 'gatherers', condition: () => gameState.resources.materials > 0 },
				{ key: 'scholars', condition: () => gameState.buildings.library > 0 },
				{ key: 'miners', condition: () => gameState.buildings.mine > 0 },
				{ key: 'hunters', condition: () => gameState.technologies.archery }
			].filter(job => job.condition());
			
			if (availableJobs.length === 0) return;
			
			for (let i = 0; i < freeKittens; i++) {
				const job = availableJobs[i % availableJobs.length];
				gameState.population.jobs[job.key]++;
				logMessage(`Auto-assigned a robot to work as ${job.key.slice(0, -1)}.`);
			}
		}

        function updateTechList() {
            const techList = document.getElementById('tech-list');
            techList.innerHTML = '';
            
            // Available technologies
            const availableDiv = document.createElement('div');
            availableDiv.innerHTML = '<h4>Available Research:</h4>';
            let hasAvailable = false;
            
            for (let techKey in techDefs) {
                const tech = techDefs[techKey];
                if (tech.unlocked() && !gameState.technologies[techKey]) {
                    hasAvailable = true;
                    const div = document.createElement('div');
                    div.className = 'tech-item';
                    
                    let canAfford = true;
                    let costText = '';
					for (let resource in tech.cost) {
						const needed = tech.cost[resource];
						const available = Math.floor(gameState.resources[resource] || 0);
						const hasEnough = available >= needed;
						const color = hasEnough ? '#2ecc71' : '#e74c3c';
						
						if (!hasEnough) {
							canAfford = false;
						}
						costText += `<span style="color: ${color};">${needed} ${resource}</span>, `;
					}
                    costText = costText.slice(0, -2);
                    
                    div.innerHTML = `
                        <h4>${tech.name}</h4>
                        <p>${tech.description}</p>
                        <p><strong>Effect:</strong> ${tech.effect}</p>
                        <button class="action-button tech-button" 
                                onclick="researchTech('${techKey}')" 
                                ${!canAfford ? 'disabled' : ''}>
                            Research (${costText})
                        </button>
                    `;
                    availableDiv.appendChild(div);
                }
            }
            
            if (hasAvailable) {
                techList.appendChild(availableDiv);
            }
            
            // Researched technologies
            const researchedDiv = document.createElement('div');
            researchedDiv.innerHTML = '<h4 style="margin-top: 20px;">Researched Technologies:</h4>';
            let hasResearched = false;
            
            for (let techKey in gameState.technologies) {
                if (gameState.technologies[techKey] && techDefs[techKey]) {
                    hasResearched = true;
                    const p = document.createElement('p');
                    p.innerHTML = `‚úì <strong>${techDefs[techKey].name}</strong> - ${techDefs[techKey].effect}`;
                    p.style.color = '#2ecc71';
                    p.style.margin = '8px 0';
                    researchedDiv.appendChild(p);
                }
            }
            
            if (hasResearched) {
                techList.appendChild(researchedDiv);
            }
            
            // Coming soon technologies  
            const comingSoonDiv = document.createElement('div');
            comingSoonDiv.innerHTML = '<h4 style="color: #95a5a6; margin-top: 20px;">Future Research:</h4>';
            let hasComingSoon = false;
            
            for (let techKey in techDefs) {
                const tech = techDefs[techKey];
                if (!tech.unlocked() && !gameState.technologies[techKey] && isCloseToResearching(techKey)) {
                    hasComingSoon = true;
                    const div = document.createElement('div');
                    div.className = 'tech-item';
                    div.style.opacity = '0.6';
                    div.style.border = '2px dashed #7f8c8d';
                    
                    let costText = '';
                    for (let resource in tech.cost) {
                        costText += `${tech.cost[resource]} ${resource}, `;
                    }
                    costText = costText.slice(0, -2);
                    
                    div.innerHTML = `
                        <h4>${tech.name} üîí</h4>
                        <p>${tech.description}</p>
                        <p><strong>Effect:</strong> ${tech.effect}</p>
                        <p style="color: #f39c12;"><strong>Requirement:</strong> ${getResearchHint(techKey)}</p>
                        <button class="action-button tech-button" disabled>
                            Locked (${costText})
                        </button>
                    `;
                    comingSoonDiv.appendChild(div);
                }
            }
            
            if (hasComingSoon) {
                techList.appendChild(comingSoonDiv);
            }
        }

        function isCloseToResearching(techKey) {
            if (techKey === 'agriculture' && gameState.resources.science >= 2) return true;
            if (techKey === 'calendar' && gameState.resources.science >= 10) return true;
            if (techKey === 'archery' && gameState.resources.science >= 10) return true;
            if (techKey === 'mining' && gameState.resources.science >= 15) return true;
            if (techKey === 'construction' && gameState.resources.science >= 30) return true;
            if (techKey === 'astronomy' && gameState.resources.science >= 50) return true;
            if (techKey === 'metalWorking' && gameState.technologies.mining && gameState.resources.science >= 50) return true;
            if (techKey === 'engineering' && gameState.resources.science >= 75) return true;
            if (techKey === 'theology' && gameState.resources.faith >= 5) return true;
            return false;
        }

        function getResearchHint(techKey) {
            if (techKey === 'agriculture') return 'Need 5+ science';
            if (techKey === 'calendar') return 'Need 15+ science';
            if (techKey === 'archery') return 'Need 15+ science';
            if (techKey === 'mining') return 'Need 25+ science';
            if (techKey === 'construction') return 'Need 50+ science';
            if (techKey === 'astronomy') return 'Need 75+ science';
            if (techKey === 'metalWorking') return 'Need Mining + 75+ science';
            if (techKey === 'engineering') return 'Need 100+ science';
            if (techKey === 'theology') return 'Need 10+ faith';
            return 'Requirements not met';
        }

		function updateReligionList() {
			const religionList = document.getElementById('religion-list');
			religionList.innerHTML = '';
			
			if (gameState.resources.faith < 1) {
				religionList.innerHTML = '<p>You must gather faith before you can worship AIDA, the great AI robot system...</p>';
				return;
			}
			
			religionList.innerHTML = '<p>ü§ñ <em>"In the beginning, there was AIDA, the great AI robot system who created all robots in their divine image..."</em></p>';
			
			for (let religionKey in religionDefs) {
				const religion = religionDefs[religionKey];
				if (religion.unlocked()) {
					const div = document.createElement('div');
					div.className = 'religion-item';
					
					let canAfford = true;
					let costText = '';
					for (let resource in religion.cost) {
						const needed = religion.cost[resource];
						const available = Math.floor(gameState.resources[resource] || 0);
						const hasEnough = available >= needed;
						const color = hasEnough ? '#2ecc71' : '#e74c3c';
						
						if (!hasEnough) {
							canAfford = false;
						}
						costText += `<span style="color: ${color};">${needed} ${resource}</span>, `;
					}
					costText = costText.slice(0, -2);
					
					const count = religionKey === 'sunAltar' ? ` (${gameState.religion.sunAltar})` : '';
					const purchased = gameState.religion[religionKey] === true;
					
					div.innerHTML = `
						<h4>${religion.name}${count}</h4>
						<p>${religion.description}</p>
						<p><strong>Effect:</strong> ${religion.effect}</p>
						${!purchased ? `
							<button class="action-button religion-button" 
									onclick="purchaseReligion('${religionKey}')" 
									${!canAfford ? 'disabled' : ''}>
								${religionKey === 'sunAltar' ? 'Build' : 'Purchase'} (${costText})
							</button>
						` : '<p style="color: #2ecc71;">‚úì Acquired</p>'}
					`;
					religionList.appendChild(div);
				}
			}
		}

		function checkAchievements() {
			let newAchievements = [];
			achievements.forEach(achievement => {
				if (!gameState.stats.achievements.includes(achievement.id) && achievement.trigger()) {
					gameState.stats.achievements.push(achievement.id);
					newAchievements.push(achievement);
				}
			});
			
			if (newAchievements.length > 0) {
				newAchievements.forEach(achievement => {
					logMessage(`üèÜ Achievement Unlocked: ${achievement.name}`);
				});
				loadAchievements(); // Always use the proper display
			}
		}

		function loadAchievements() {
			const achievementsList = document.getElementById('achievements-list');
			// Remember if achievements were expanded before clearing
			const wasExpanded = document.querySelector('#achievements-list .older-achievements-container') && 
							   document.querySelector('#achievements-list .older-achievements-container').style.display === 'block';
			
			achievementsList.innerHTML = '';
			
			// Show earned achievements (most recent first)
			const earnedAchievements = gameState.stats.achievements.slice().reverse();
			
			if (earnedAchievements.length === 0) {
				achievementsList.innerHTML = '<p style="color: #7f8c8d; font-style: italic;">No achievements yet...</p>';
				return;
			}
			
			// Show recent achievements (first 5)
			const recentAchievements = earnedAchievements.slice(0, 5);
			recentAchievements.forEach(achievementId => {
				const achievement = achievements.find(a => a.id === achievementId);
				if (achievement) {
					const div = document.createElement('div');
					div.className = 'achievement';
					div.innerHTML = `
						<strong>${achievement.name}</strong><br>
						<small>${achievement.desc}</small>
					`;
					achievementsList.appendChild(div);
				}
			});
			
			// If there are more than 5, add a scrollable area for older ones
			if (earnedAchievements.length > 5) {
				const olderAchievements = earnedAchievements.slice(5);
				const expandButton = document.createElement('button');
				expandButton.innerHTML = `Show ${olderAchievements.length} more achievements...`;
				expandButton.style.cssText = 'width: 100%; padding: 5px; background: #34495e; color: #ecf0f1; border: 1px solid #3498db; border-radius: 3px; cursor: pointer; font-size: 11px; margin-top: 5px;';
				
				const olderContainer = document.createElement('div');
				olderContainer.className = 'older-achievements-container';
				olderContainer.style.cssText = 'max-height: 150px; overflow-y: auto; margin-top: 5px; display: none; border: 1px solid #34495e; border-radius: 3px; padding: 5px;';
				
				olderAchievements.forEach(achievementId => {
					const achievement = achievements.find(a => a.id === achievementId);
					if (achievement) {
						const div = document.createElement('div');
						div.className = 'achievement';
						div.style.fontSize = '11px';
						div.style.margin = '3px 0';
						div.innerHTML = `
							<strong>${achievement.name}</strong><br>
							<small>${achievement.desc}</small>
						`;
						olderContainer.appendChild(div);
					}
				});
				
				expandButton.onclick = () => {
					if (olderContainer.style.display === 'none') {
						olderContainer.style.display = 'block';
						expandButton.innerHTML = 'Hide older achievements';
					} else {
						olderContainer.style.display = 'none';
						expandButton.innerHTML = `Show ${olderAchievements.length} more achievements...`;
					}
				};
				
				achievementsList.appendChild(expandButton);
				achievementsList.appendChild(olderContainer);
				
				// If achievements were expanded before, expand them again
				if (wasExpanded) {
					olderContainer.style.display = 'block';
					expandButton.innerHTML = 'Hide older achievements';
				}
			}
			
			// Add counter
			const counterDiv = document.createElement('div');
			counterDiv.innerHTML = `<p style="text-align: center; color: #bdc3c7; margin-top: 8px; font-size: 12px;">Total: ${earnedAchievements.length} achievements</p>`;
			achievementsList.appendChild(counterDiv);
		}

        function logMessage(message) {
            const gameLog = document.getElementById('game-log');
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.textContent = message;
            gameLog.insertBefore(div, gameLog.firstChild);
            
            // Keep only last 20 log entries
            while (gameLog.children.length > 20) {
                gameLog.removeChild(gameLog.lastChild);
            }
        }

		function gameLoop() {
			// Resource production (including job bonuses)
			for (let resource in gameState.resourcesProduction) {
				if (gameState.resourcesProduction[resource] > 0) {
					let production = gameState.resourcesProduction[resource];
					
					// Add job bonuses without modifying base rates
					if (resource === 'energy') {
						production += gameState.population.jobs.farmers * 0.25;
					}
					if (resource === 'materials') {
						production += gameState.population.jobs.gatherers * 0.05;
					}
					if (resource === 'minerals') {
						production += gameState.population.jobs.miners * 0.03;
					}
					if (resource === 'science') {
						production += gameState.population.jobs.scholars * 0.035;
					}
					if (resource === 'faith') {
						production += gameState.population.jobs.priests * 0.02;
					}
					
					production *= (1 + (gameState.paragonBonus || 0));
					
					// Season effects on energy
					if (resource === 'energy') {
						const seasonMultipliers = [1.5, 1.0, 0.75, 0.25]; // Spring, Summer, Autumn, Winter
						production *= seasonMultipliers[gameState.stats.season];
					}
					
					// Apply resource caps
					const currentAmount = gameState.resources[resource];
					const limit = gameState.resourceLimits[resource] || Infinity;
					const newAmount = Math.min(limit, currentAmount + production);
					gameState.resources[resource] = newAmount;
					
					// Warn if hitting caps
					if (newAmount >= limit && Math.random() < 0.01) {
						logMessage(`‚ö†Ô∏è ${resource} storage is full! Build more storage buildings.`);
					}
				}
			}
			
			// Handle processing separately since it only comes from hunters
			if (gameState.population.jobs.hunters > 0) {
				let catpowerProduction = gameState.population.jobs.hunters * 0.4;
				catpowerProduction *= (1 + (gameState.paragonBonus || 0));
				
				const currentAmount = gameState.resources.processing;
				const limit = gameState.resourceLimits.processing || Infinity;
				const newAmount = Math.min(limit, currentAmount + catpowerProduction);
				gameState.resources.processing = newAmount;
			}

			// Handle active smelters
			if (gameState.smelterActive > 0 && gameState.buildings.smelter > 0) {
				const mineralsConsumed = gameState.smelterActive * 0.1; // 0.1 minerals per smelter per second
				const woodConsumed = gameState.smelterActive * 0.05; // 0.05 wood per smelter per second  
				const ironProduced = gameState.smelterActive * 0.02; // 0.02 iron per smelter per second
				
				if (gameState.resources.minerals >= mineralsConsumed && gameState.resources.materials >= woodConsumed) {
					gameState.resources.minerals -= mineralsConsumed;
					gameState.resources.materials -= woodConsumed;
					gameState.resources.iron += ironProduced;
				}
			}

			// Check metaphysics unlock
			if (gameState.resources.unobtainium > 0) {
				checkMetaphysicsUnlock();
			}
			
			autoAssignNewKittens();
			
			// Hunters hunt automatically
			if (gameState.population.jobs.hunters > 0 && Math.random() < 0.1 * gameState.population.jobs.hunters) {
				hunt();
			}
			
			// Season progression (every 60 seconds = 1 season, so 4 minutes = 1 year)
			gameState.stats.timePlayed += 1;
			if (gameState.stats.timePlayed % 60 === 0) {
				const oldSeason = gameState.stats.season;
				gameState.stats.season = (gameState.stats.season + 1) % 4;
				const seasons = ['Spring', 'Summer', 'Autumn', 'Winter'];
				
				if (gameState.stats.season === 0) {
					gameState.stats.year++;
					logMessage(`üå∏ Year ${gameState.stats.year} begins! Spring has arrived with abundant growth.`);
				} else {
					logMessage(`${seasons[gameState.stats.season]} has arrived. ${getSeasonMessage()}`);
				}
				checkAchievements();
			}
			
			// Track happiness for achievements
			if (gameState.population.happiness >= 1.0) {
				if (gameState.stats.season === 0 && gameState.stats.timePlayed % 60 === 0) { // New year
					gameState.stats.happyYears = (gameState.stats.happyYears || 0) + 1;
				}
			}			
			
			// Catnip consumption (robots eat energy)
			const catnipConsumption = gameState.population.robots * 0.05; // Reduced consumption
			gameState.resources.energy = Math.max(0, gameState.resources.energy - catnipConsumption);
			
			// Happiness calculation
			if (gameState.resources.energy <= 0) {
				gameState.population.happiness = Math.max(0.1, gameState.population.happiness - 0.002);
				if (gameState.stats.timePlayed % 30 === 0) {
					logMessage("‚ö†Ô∏è Your robots are low power! Energy supplies are low.");
				}
			} else {
				gameState.population.happiness = Math.min(1.0, gameState.population.happiness + 0.001);
			}
			
			// Random events (less frequent)
			if (Math.random() < 0.0005) { // 0.05% chance per second
				triggerRandomEvent();
			}
			
			// Positive production events (every 45-90 seconds)
			if (Math.random() < 0.0003) { // 0.03% chance per second
				triggerProductionEvent();
			}

			// Disasters (very rare - every 10-20 minutes)
			if (Math.random() < 0.00008) { // 0.008% chance per second
				triggerDisaster();
			}			

			// Astronomical events (every 30-60 minutes)
			if (!gameState.astronomy.eventActive && gameState.buildings.observatory > 0 && Math.random() < 0.0003) {
				const events = ['lunar eclipse', 'meteor shower', 'solar flare', 'comet passage', 'aurora borealis'];
				gameState.astronomy.eventActive = true;
				gameState.astronomy.eventType = events[Math.floor(Math.random() * events.length)];
				gameState.astronomy.observationsLeft = 3 + Math.floor(Math.random() * 3); // 3-5 observations
				logMessage(`A ${gameState.astronomy.eventType} begins! You can observe the sky.`);
			}

			// Update observe button status
			if (gameState.buildings.observatory > 0) {
				updateObserveButton();
			}

			if (gameState.technologies.archery) {
				updateHuntingSection();
			}
			
			if (gameState.technologies.archery) {
				updateHuntingSection();
			}
			updateDisplay();
		}

		function forceCheckAllAchievements() {
			// Clear existing achievements to force re-check
			gameState.stats.achievements = [];
			
			// Force check every achievement
			achievements.forEach(achievement => {
				if (achievement.trigger()) {
					gameState.stats.achievements.push(achievement.id);
					showAchievement(achievement);
				}
			});
			
			logMessage(`Achievement check complete! Earned ${gameState.stats.achievements.length} achievements.`);
		}

        function getSeasonMessage() {
            const messages = [
                '', // Spring handled above
                '‚òÄÔ∏è Catnip grows normally under the warm sun.',
                'üçÇ Catnip production slows as leaves fall.',
                '‚ùÑÔ∏è Winter reduces energy growth significantly. Prepare food stores!'
            ];
            return messages[gameState.stats.season];
        }

        function triggerRandomEvent() {
            const events = [
                {
                    message: "A traveling merchant robot offers to trade!",
                    effect: () => {
                        if (gameState.resources.furs >= 10) {
                            gameState.resources.furs -= 10;
                            gameState.resources.gold += 5;
                            logMessage("You traded 10 furs for 5 gold!");
                        }
                    }
                },
                {
                    message: "Your robots find a cache of energy!",
                    effect: () => {
                        const bonus = Math.floor(Math.random() * 50) + 25;
                        gameState.resources.energy += bonus;
                        logMessage(`Your robots found ${bonus} energy!`);
                    }
                },
                {
                    message: "A wise elder cat shares ancient knowledge!",
                    effect: () => {
                        if (gameState.resources.science < 10) {
                            gameState.resources.science += 5;
                            logMessage("The elder's wisdom grants you 5 science!");
                        }
                    }
                },
                {
                    message: "The aurora borealis fills your robots with wonder!",
                    effect: () => {
                        gameState.resources.faith += 2;
                        logMessage("The beautiful lights inspire faith in AIDA!");
                    }
                }
            ];
            
            const randomEvent = events[Math.floor(Math.random() * events.length)];
            logMessage(randomEvent.message);
            randomEvent.effect();
        }

		function triggerProductionEvent() {
			const events = [
				{
					condition: () => gameState.buildings.mine > 0,
					message: "Your mines struck a rich vein!",
					effect: () => {
						const bonus = Math.floor(Math.random() * 20) + 10;
						gameState.resources.minerals += bonus;
						logMessage(`The mines produced an extra ${bonus} minerals!`);
					}
				},
				{
					condition: () => gameState.buildings.catnipField > 5,
					message: "The energy generators had excellent output!",
					effect: () => {
						const bonus = Math.floor(Math.random() * 50) + 25;
						gameState.resources.energy += bonus;
						logMessage(`The fields yielded an extra ${bonus} energy!`);
					}
				},
				{
					condition: () => gameState.buildings.library > 0,
					message: "Your scholars made a breakthrough!",
					effect: () => {
						const bonus = Math.floor(Math.random() * 10) + 5;
						gameState.resources.science += bonus;
						logMessage(`Research breakthrough grants ${bonus} science!`);
					}
				},
				{
					condition: () => gameState.buildings.quarry > 0,
					message: "The quarry uncovered quality stone!",
					effect: () => {
						const bonus = Math.floor(Math.random() * 15) + 8;
						gameState.resources.stone += bonus;
						logMessage(`The quarry produced ${bonus} extra stone!`);
					}
				}
			];
			
			const availableEvents = events.filter(event => event.condition());
			if (availableEvents.length > 0) {
				const randomEvent = availableEvents[Math.floor(Math.random() * availableEvents.length)];
				randomEvent.effect();
			}
		}

		function triggerDisaster() {
			const disasters = [
				{
					condition: () => gameState.buildings.hut > 1,
					message: "A small fire damages a hut!",
					effect: () => {
						gameState.buildings.hut--;
						gameState.population.robots = Math.max(1, gameState.population.robots - 1);
						logMessage("üî• A fire destroyed a hut! One robot moved in with neighbors.");
					}
				},
				{
					condition: () => gameState.resources.energy > 100,
					message: "Power surge damages some energy stores!",
					effect: () => {
						const loss = Math.floor(gameState.resources.energy * 0.03); // 3% loss
						gameState.resources.energy -= loss;
						logMessage(`üåßÔ∏è Flooding destroyed ${loss} energy from your stores.`);
					}
				},
				{
					condition: () => gameState.stats.season === 1, // Summer
					message: "A solar eclipse darkens the sky!",
					effect: () => {
						gameState.resources.faith = Math.max(0, gameState.resources.faith - 5);
						logMessage("üåë The eclipse fills your robots with unease. Faith decreases.");
					}
				},
				{
					condition: () => gameState.buildings.catnipField > 3,
					message: "System malfunction damages generator!",
					effect: () => {
						gameState.buildings.catnipField--;
						gameState.resourcesProduction.energy = Math.max(0, gameState.resourcesProduction.energy - 0.63);
						logMessage("ü¶ó Locusts destroyed a energy field!");
					}
				}
			];
			
			const availableDisasters = disasters.filter(disaster => disaster.condition());
			if (availableDisasters.length > 0) {
				const randomDisaster = availableDisasters[Math.floor(Math.random() * availableDisasters.length)];
				randomDisaster.effect();
			}
		}

		function saveGame() {
			pendingAction = 'save';
			document.getElementById('modal-title').textContent = 'Create Save File';
			document.getElementById('modal-description').textContent = 'Enter a secret phrase to protect your save file:';
			document.getElementById('phrase-input').value = '';
			document.getElementById('phrase-modal').style.display = 'block';
			document.getElementById('phrase-input').focus();
		}

		function loadGame() {
			const input = document.createElement('input');
			input.type = 'file';
			input.accept = '.json';
			input.onchange = function(event) {
				const file = event.target.files[0];
				if (!file) return;
				
				const reader = new FileReader();
				reader.onload = function(e) {
					try {
						window.pendingSaveData = JSON.parse(e.target.result);
						pendingAction = 'load';
						document.getElementById('modal-title').textContent = 'Load Save File';
						document.getElementById('modal-description').textContent = 'Enter the secret phrase for this save file:';
						document.getElementById('phrase-input').value = '';
						document.getElementById('phrase-modal').style.display = 'block';
						document.getElementById('phrase-input').focus();
					} catch (error) {
						logMessage("Error: Invalid save file format!");
					}
				};
				reader.readAsText(file);
			};
			input.click();
		}

		function confirmPhrase() {
			const phrase = document.getElementById('phrase-input').value.trim();
			if (!phrase) {
				logMessage('Please enter a phrase!');
				return;
			}
			
			// Hide modal FIRST
			document.getElementById('phrase-modal').style.display = 'none';
			
			// Then perform the action
			if (pendingAction === 'save') {
				performSaveWithPhrase(phrase);
			} else if (pendingAction === 'load') {
				performLoadWithPhrase(phrase);
			}
			
			// Clear everything
			pendingAction = null;
			document.getElementById('phrase-input').value = '';
		}

		function cancelPhrase() {
			document.getElementById('phrase-modal').style.display = 'none';
			pendingAction = null;
		}

		function performSaveWithPhrase(userPhrase) {
			try {
				const signature = generateGameSignature(gameState, userPhrase);
				const saveData = {
					gameState: gameState,
					settings: gameSettings,
					signature: signature,
					timestamp: Date.now(),
					gameId: signature.substring(0, 8).toUpperCase()
				};
				
				const blob = new Blob([JSON.stringify(saveData, null, 2)], {type: 'application/json'});
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = `robot-civ-${saveData.gameId}.json`;
				document.body.appendChild(a);
				a.click();
				document.body.removeChild(a);
				URL.revokeObjectURL(url);
				
				logMessage(`Save file downloaded! Game ID: ${saveData.gameId}`);
			} catch (error) {
				logMessage("Error creating save file!");
			}
		}

		function performLoadWithPhrase(userPhrase) {
			try {
				const saveData = window.pendingSaveData;
				const expectedSignature = generateGameSignature(saveData.gameState, userPhrase);
				
				if (saveData.signature === expectedSignature) {
					gameState = saveData.gameState;
					
					// Restore settings
					if (saveData.settings) {
						gameSettings = saveData.settings;
					} else {
						gameSettings = { hideSellButtons: false, autoAssignJobs: false };
					}
					
					// Ensure trading races exist
					if (!gameState.tradingRaces) {
						gameState.tradingRaces = {
							lizards: { standing: 0, unlocked: false },
							sharks: { standing: 0, unlocked: false },
							griffins: { standing: 0, unlocked: false },
							nagas: { standing: 0, unlocked: false },
							zebras: { standing: 0, unlocked: false }
						};
					}
					// Ensure expeditions exist
					if (!gameState.expeditions) {
						gameState.expeditions = {
							active: [],
							completed: 0,
							artifacts: 0,
							relics: 0,
							manuscripts: 0
						};
					}
					// Ensure space exists
					if (!gameState.space) {
						gameState.space = {
							missions: 0,
							satellites: 0,
							spaceStations: 0,
							moonBases: 0,
							planetCrackers: 0
						};
					}
					
					// Auto-unlock trading if trading post exists
					if (gameState.buildings.tradingPost > 0) {
						gameState.tradingRaces.lizards.unlocked = true;
					}
					
					recalculateStorageLimits();
					restoreUIState();
					loadAchievements();
					updateDisplay();
					updateTradeTab();
					logMessage(`Game loaded! ID: ${saveData.gameId} ‚úì Verified`);
				} else {
					logMessage("Invalid save file or wrong secret phrase!");
				}
				
				delete window.pendingSaveData;
			} catch (error) {
				logMessage("Error loading save file!");
			}
		}

		function generateGameSignature(gameData, userPhrase) {
			const dataString = JSON.stringify(gameData) + userPhrase;
			let hash = 0;
			for (let i = 0; i < dataString.length; i++) {
				const char = dataString.charCodeAt(i);
				hash = ((hash << 5) - hash) + char;
				hash = hash & hash;
			}
			return Math.abs(hash).toString(36);
		}

		function recalculateStorageLimits() {
			// Reset to base limits
			gameState.resourceLimits = {
				energy: 5000,
				materials: 1000,
				minerals: 1000,
				coal: 500,
				iron: 300,
				gold: 200,
				stone: 1000,
				science: 2000,
				faith: 500,
				furs: 500,
				ivory: 100,
				unicorns: 50,
				processing: 1000,
				titanium: 250,
				scaffolds: 1000,
				plates: 500,
				manuscripts: 100,
				unobtainium: 150,
				timeCrystals: 10,
				culture: 200,
				blueprints: 100,
				compendium: 25,
				megalith: 10
			};
			
			// Add storage from barns
			if (gameState.buildings.barn > 0) {
				gameState.resourceLimits.energy += gameState.buildings.barn * 5000;
				gameState.resourceLimits.materials += gameState.buildings.barn * 200;
				gameState.resourceLimits.minerals += gameState.buildings.barn * 250;
				gameState.resourceLimits.furs += gameState.buildings.barn * 200;
				gameState.resourceLimits.ivory += gameState.buildings.barn * 50;  // ADDED THIS
				gameState.resourceLimits.gold += gameState.buildings.barn * 10;
				gameState.resourceLimits.titanium += gameState.buildings.barn * 2;
			}
			
			// Add storage from warehouses  
			if (gameState.buildings.warehouse > 0) {
				gameState.resourceLimits.minerals += gameState.buildings.warehouse * 200;
				gameState.resourceLimits.coal += gameState.buildings.warehouse * 300;     // DOUBLED THIS
				gameState.resourceLimits.iron += gameState.buildings.warehouse * 100;     // DOUBLED THIS
				gameState.resourceLimits.stone += gameState.buildings.warehouse * 200;
				gameState.resourceLimits.gold += gameState.buildings.warehouse * 5;
				gameState.resourceLimits.titanium += gameState.buildings.warehouse * 10;
			}
			
			// Add storage from harbors
			if (gameState.buildings.harbor > 0) {
				gameState.resourceLimits.materials += gameState.buildings.harbor * 700;
				gameState.resourceLimits.minerals += gameState.buildings.harbor * 950;
				gameState.resourceLimits.titanium += gameState.buildings.harbor * 50;
			}
			
			// Add storage from academies
			if (gameState.buildings.academy > 0) {
				gameState.resourceLimits.science += gameState.buildings.academy * 1000;
			}
			
			// Add storage from amphitheatres
			if (gameState.buildings.amphitheatre > 0) {
				gameState.resourceLimits.culture += gameState.buildings.amphitheatre * 500;
			}
			
			// Add storage from pastures (unicorn storage)
			if (gameState.buildings.pasture > 0) {
				gameState.resourceLimits.unicorns += gameState.buildings.pasture * 10;
			}
			
			// Add storage from mints
			if (gameState.buildings.mint > 0) {
				gameState.resourceLimits.gold += gameState.buildings.mint * 100;
			}
			
			// Add processing storage from composite bow upgrade
			if (gameState.workshopUpgrades && gameState.workshopUpgrades.compositeBow) {
				gameState.resourceLimits.processing += 100;
			}

			// Add processing storage from amphitheatres
			if (gameState.buildings.amphitheatre > 0) {
				gameState.resourceLimits.processing += gameState.buildings.amphitheatre * 75;
			}

			// Add processing storage from hunting lodges
			if (gameState.buildings.huntingLodge > 0) {
				gameState.resourceLimits.processing += gameState.buildings.huntingLodge * 50;
			}
			
			// Add faith storage from religious buildings
			if (gameState.buildings.temple > 0) {
				gameState.resourceLimits.faith += gameState.buildings.temple * 200;
			}
			if (gameState.religion.sunAltar > 0) {
				gameState.resourceLimits.faith += gameState.religion.sunAltar * 100;
			}
		}
		
		function restoreUIState() {
			// Show previously unlocked elements based on game state
			if (gameState.stats.gatherClicks >= 5 || gameState.buildings.catnipField > 0) {
				showElement('plant-energy-btn');
			}
			if (gameState.stats.gatherClicks >= 3 || gameState.resources.materials > 0) {
				showElement('refine-energy-btn');
			}
			if (gameState.technologies.archery) {
				updateHuntingSection();
			}
			if (gameState.buildings.observatory > 0) {
				showElement('observe-stars-btn');
			}
			if (gameState.buildings.catnipField > 0) {
				showElement('field-management');
				showElement('energy-fields-summary');
			}
			if (gameState.buildings.workshop > 0) {
				updateWorkshopTab();
			}
			
			// Force restore resource displays for crafted resources
			if (gameState.resources.steel > 0 || (gameState.unlockedRecipes && gameState.unlockedRecipes.steel)) {
				addResourceToDisplay('steel');
			}
			if (gameState.resources.gear > 0 || (gameState.unlockedRecipes && gameState.unlockedRecipes.gear)) {
				addResourceToDisplay('gear');
			}
			if (gameState.resources.concrete > 0 || (gameState.unlockedRecipes && gameState.unlockedRecipes.concrete)) {
				addResourceToDisplay('concrete');
			}
			if (gameState.resources.alloy > 0 || (gameState.unlockedRecipes && gameState.unlockedRecipes.alloy)) {
				addResourceToDisplay('alloy');
			}
			if (gameState.resources.parchment > 0 || (gameState.unlockedRecipes && gameState.unlockedRecipes.parchment)) {
				addResourceToDisplay('parchment');
			}
			if (gameState.resources.manuscripts > 0 || (gameState.unlockedRecipes && gameState.unlockedRecipes.manuscript)) {
				addResourceToDisplay('manuscripts');
			}
			
			if (gameState.technologies.rocketry) {
				addSpaceTab();
			}
					
			updateGatherButton();
			updateFieldDisplay();
		}

		function resetGame() {
			showResetConfirmation();
		}

        // Initialize game
		document.addEventListener('DOMContentLoaded', function() {
			// Try to load saved game first
			const savedGame = localStorage.getItem('robotCivilizationSave');
			if (savedGame) {
				try {
					const loadedState = JSON.parse(savedGame);
					gameState = Object.assign({}, gameState, loadedState);
					if (loadedState.settings) {
						gameSettings = loadedState.settings;
					}
					
					// Ensure all nested objects exist
					gameState.buildings = Object.assign({}, {
						catnipField: 0, hut: 0, library: 0, barn: 0, warehouse: 0, mine: 0, 
						quarry: 0, goldMine: 0, smelter: 0, workshop: 0, shrine: 0, temple: 0, 
						logHouse: 0, mansion: 0, tradingPost: 0, observatory: 0, academy: 0, 
						pasture: 0, harbor: 0, amphitheatre: 0, huntingLodge: 0, oilWell: 0, 
						chronosphere: 0, launchPad: 0, mint: 0
					}, loadedState.buildings || {});
					
					gameState.technologies = Object.assign({}, {
						agriculture: false, archery: false, mining: false, metalWorking: false,
						construction: false, engineering: false, astronomy: false, theology: false,
						philosophy: false, mathematics: false, optics: false, physics: false, calendar: false
					}, loadedState.technologies || {});
					
					// Ensure jobs object exists
					if (!gameState.population.jobs) {
						gameState.population.jobs = {
							farmers: 0,
							gatherers: 0,
							miners: 0,
							scholars: 0,
							hunters: 0,
							priests: 0
						};
					}
					
					recalculateStorageLimits();
					restoreUIState();
					loadAchievements();
				} catch (error) {
					console.error("Error loading save:", error);
				}
			}

			// Upgrade achievement system automatically
			upgradeAchievementSystem();
			
			// Start game loop
			setInterval(gameLoop, 1000); // Run every second
			
			// Auto-save to localStorage every 10 seconds
			setInterval(() => {
				localStorage.setItem('robotCivilizationSave', JSON.stringify({
					...gameState,
					settings: gameSettings
				}));
			}, 10000);
			
			// Initial display update
			updateDisplay();
			
			// Fix trading post
			if (gameState.buildings.tradingPost > 0) {
				gameState.tradingRaces.lizards.unlocked = true;
				updateTradeTab();
			}
			
			// Modal event listeners
			const modal = document.getElementById('phrase-modal');
			const modalContent = modal.querySelector('.modal-content');
			
			modal.addEventListener('click', function(e) {
				if (e.target === modal) {
					cancelPhrase();
				}
			});
			
			modalContent.addEventListener('click', function(e) {
				e.stopPropagation();
			});
			
			document.getElementById('phrase-input').addEventListener('keypress', function(e) {
				if (e.key === 'Enter') {
					confirmPhrase();
				}
			});
			
			// Prevent Enter key spam on gather button
			document.getElementById('gather-energy-btn').addEventListener('keydown', function(e) {
				if (e.key === 'Enter') {
					e.preventDefault();
					gatherEnergy();
				}
			});

			// Apply saved settings
			if (gameSettings.hideSellButtons) {
				document.getElementById('hide-sell-buttons').checked = true;
			}
			if (gameSettings.autoAssignJobs) {
				document.getElementById('auto-assign-jobs').checked = true;
			}

			// Add event listeners for settings
			document.getElementById('hide-sell-buttons').addEventListener('change', saveSettings);
			document.getElementById('auto-assign-jobs').addEventListener('change', saveSettings);

			// Load settings on startup
			const savedSettings = localStorage.getItem('robotCivSettings');
			if (savedSettings) {
				gameSettings = JSON.parse(savedSettings);
			}
			
			logMessage("Welcome to Robot AI Civilization! Your journey begins...");
			enforceMaxBuildingLimits();
			updateWorkshopTab();
		});

		function addResourceToDisplay(resourceName, productionName = null) {
			const resourcesDiv = document.getElementById('resources');
			const resourceDiv = document.createElement('div');
			resourceDiv.className = 'resource';
			resourceDiv.innerHTML = `
				<span class="resource-name">${resourceName.charAt(0).toUpperCase() + resourceName.slice(1)}</span>
				<div>
					<span class="resource-amount" id="${resourceName}-amount">${Math.floor(gameState.resources[resourceName] || 0)}</span>
					${productionName ? `<div class="production-rate" id="${resourceName}-rate">+0.0/sec</div>` : ''}
				</div>
			`;
			resourcesDiv.appendChild(resourceDiv);
		}

        // Monitor for new resources and add them to display
		function checkNewResources() {
			const displayedResources = ['energy'];
			
			if (gameState.resources.materials > 0 && !document.getElementById('materials-amount')) {
				addResourceToDisplay('materials');
			}
			if (gameState.resources.science > 0 && !document.getElementById('science-amount')) {
				addResourceToDisplay('science', 'science');
			}
			if (gameState.resources.faith > 0 && !document.getElementById('faith-amount')) {
				addResourceToDisplay('faith', 'faith');
			}
			if (gameState.resources.processing >= 0 && !document.getElementById('processing-amount')) {
				addResourceToDisplay('processing', 'processing');
			}		
			if (gameState.resources.furs > 0 && !document.getElementById('furs-amount')) {
				addResourceToDisplay('furs');
			}
			if (gameState.resources.ivory > 0 && !document.getElementById('ivory-amount')) {
				addResourceToDisplay('ivory');
			}
			if (gameState.resources.gold > 0 && !document.getElementById('gold-amount')) {
				addResourceToDisplay('gold');
			}
			if (gameState.resources.minerals > 0 && !document.getElementById('minerals-amount')) {
				addResourceToDisplay('minerals');
			}
			if (gameState.resources.coal > 0 && !document.getElementById('coal-amount')) {
				addResourceToDisplay('coal');
			}
			if (gameState.resources.iron > 0 && !document.getElementById('iron-amount')) {
				addResourceToDisplay('iron');
			}
			if (gameState.resources.stone > 0 && !document.getElementById('stone-amount')) {
				addResourceToDisplay('stone');
			}
			if (gameState.resources.unicorns > 0 && !document.getElementById('unicorns-amount')) {
				addResourceToDisplay('unicorns');
			}
			// ADD THESE LINES:
			if (gameState.resources.steel > 0 && !document.getElementById('steel-amount')) {
				addResourceToDisplay('steel');
			}
			if (gameState.resources.gear > 0 && !document.getElementById('gear-amount')) {
				addResourceToDisplay('gear');
			}
			if (gameState.resources.scaffolds > 0 && !document.getElementById('scaffolds-amount')) {
				addResourceToDisplay('scaffolds');
			}
			if (gameState.resources.plates > 0 && !document.getElementById('plates-amount')) {
				addResourceToDisplay('plates');
			}
			if (gameState.resources.ships > 0 && !document.getElementById('ships-amount')) {
				addResourceToDisplay('ships');
			}
			if (gameState.resources.starcharts > 0 && !document.getElementById('starcharts-amount')) {
				addResourceToDisplay('starcharts');	
			}				
			if (gameState.resources.concrete > 0 && !document.getElementById('concrete-amount')) {
				addResourceToDisplay('concrete');
			}
			if (gameState.resources.alloy > 0 && !document.getElementById('alloy-amount')) {
				addResourceToDisplay('alloy');
			}
			if (gameState.resources.titanium > 0 && !document.getElementById('titanium-amount')) {
				addResourceToDisplay('titanium');
			}
			if (gameState.resources.oil > 0 && !document.getElementById('oil-amount')) {
				addResourceToDisplay('oil');
			}
			if (gameState.resources.uranium > 0 && !document.getElementById('uranium-amount')) {
				addResourceToDisplay('uranium');
			}
			if (gameState.resources.culture > 0 && !document.getElementById('culture-amount')) {
				addResourceToDisplay('culture', 'culture');
			}
			if (gameState.resources.parchment > 0 && !document.getElementById('parchment-amount')) {
				addResourceToDisplay('parchment');
			}
			if (gameState.resources.manuscripts > 0 && !document.getElementById('manuscripts-amount')) {
				addResourceToDisplay('manuscripts');
			}
			if (gameState.resources.unobtainium > 0 && !document.getElementById('unobtainium-amount')) {
				addResourceToDisplay('unobtainium');
			}
			if (gameState.resources.timeCrystals > 0 && !document.getElementById('timeCrystals-amount')) {
				addResourceToDisplay('timeCrystals');
			}
			if (gameState.resources.blueprints > 0 && !document.getElementById('blueprints-amount')) {
				addResourceToDisplay('blueprints');
			}
			if (gameState.resources.thorium > 0 && !document.getElementById('thorium-amount')) {
				addResourceToDisplay('thorium');
			}
			if (gameState.resources.kerosene > 0 && !document.getElementById('kerosene-amount')) {
				addResourceToDisplay('kerosene');
			}
			if (gameState.resources.compendium > 0 && !document.getElementById('compendium-amount')) {
				addResourceToDisplay('compendium');
			}
			if (gameState.resources.megalith > 0 && !document.getElementById('megalith-amount')) {
				addResourceToDisplay('megalith');
			}			
		}

        // Enhanced game loop to check for new resources
        setInterval(checkNewResources, 2000);
    </script>
</body>
</html>								