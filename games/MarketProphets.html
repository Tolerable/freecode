<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Prophets - Prediction Trading Empire</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1a2e 50%, #16213e 100%);
            color: #e0e0e0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        .game-header {
            background: linear-gradient(135deg, rgba(20, 20, 40, 0.95), rgba(30, 30, 50, 0.95));
            border-bottom: 3px solid rgba(255, 215, 0, 0.3);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .title-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .game-title {
            font-size: 2.5em;
            font-weight: 900;
            background: linear-gradient(45deg, #ffd700, #ffed4e, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
            letter-spacing: 2px;
        }

        .wealth-display {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        .wealth-amount {
            font-size: 3em;
            font-weight: 900;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 0 40px rgba(255, 215, 0, 0.3);
            letter-spacing: 1px;
            font-variant-numeric: tabular-nums;
        }

        .wealth-label {
            font-size: 0.9em;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .player-stats {
            display: flex;
            gap: 30px;
            font-size: 1.1em;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #4caf50;
        }

        .stat-label {
            font-size: 0.8em;
            color: #888;
            text-transform: uppercase;
        }

        /* Main Layout */
		.game-container {
			display: grid;
			grid-template-columns: 280px 1fr;
			gap: 20px;
			padding: 20px;
			max-width: 1800px;
			margin: 0 auto;
			transition: transform 0.3s ease, margin-right 0.3s ease;
		}

		.game-container.activity-open {
			margin-right: 300px;
		}

        /* Left Sidebar - Competitors */
        .competitors-panel {
            background: rgba(20, 20, 40, 0.8);
            border-radius: 15px;
            border: 2px solid rgba(255, 215, 0, 0.2);
            padding: 20px;
            max-height: calc(100vh - 180px);
            overflow-y: auto;
        }

        .panel-header {
            font-size: 1.3em;
            color: #ffd700;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
            padding-bottom: 10px;
        }

        .competitor-card {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
        }

        .competitor-card:hover {
            border-color: rgba(255, 215, 0, 0.5);
            transform: translateX(5px);
        }

        .competitor-card.player {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }

        .competitor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .competitor-name {
            font-size: 1.1em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .competitor-wealth {
            font-size: 1.3em;
            color: #ffd700;
            font-weight: bold;
        }

        .competitor-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #888;
        }

        .rank-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: bold;
            margin-left: 5px;
        }

        .rank-1 { background: #ffd700; color: #000; }
        .rank-2 { background: #c0c0c0; color: #000; }
        .rank-3 { background: #cd7f32; color: #000; }

        /* Main Center - Events Pool */
		.events-panel {
			background: rgba(20, 20, 40, 0.8);
			border-radius: 15px;
			border: 2px solid rgba(255, 215, 0, 0.2);
			padding: 25px;
			max-height: calc(100vh - 180px);
			display: flex;
			flex-direction: column;
			overflow: hidden; /* Prevent panel itself from scrolling */
		}

		.events-list {
			flex: 1;
			overflow-y: auto;
			padding-right: 10px;
			margin-right: -10px; /* Offset scrollbar */
		}

        .events-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.2);
        }

        .speed-controls {
            display: flex;
            gap: 10px;
        }

        .speed-btn {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .speed-btn.active {
            background: rgba(255, 215, 0, 0.3);
            border-color: #ffd700;
            color: #ffd700;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        .btn-primary {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .btn-danger {
            background: rgba(244, 67, 54, 0.3);
            color: #fff;
            border: 2px solid #f44336;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .events-list {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
        }

		.event-row {
			position: relative;
			background: rgba(0, 0, 0, 0.3);
			border-radius: 10px;
			padding: 12px 20px;
			margin-bottom: 8px;
			border-left: 4px solid #666;
			border-right: 4px solid rgba(255, 255, 255, 0.1);
			border-top: 2px solid rgba(255, 255, 255, 0.05);
			border-bottom: 2px solid rgba(255, 255, 255, 0.05);
			transition: all 0.3s;
			cursor: pointer;
		}

        .event-row:hover {
            border-left-color: #ffd700;
            transform: translateX(5px);
            background: rgba(255, 215, 0, 0.05);
        }

		.event-row.player-bet {
			border-left: 6px solid #00ff00 !important;
			border-right: 6px solid #00ff00 !important;
			border-top: 3px solid #00ff00 !important;
			border-bottom: 3px solid #00ff00 !important;
			background: linear-gradient(135deg, rgba(0, 255, 0, 0.35), rgba(76, 175, 80, 0.25)) !important;
			box-shadow: 0 0 30px rgba(0, 255, 0, 0.6), inset 0 0 40px rgba(0, 255, 0, 0.15) !important;
		}

        .event-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .event-type-badge {
            display: inline-block;
            padding: 5px 15px;
            background: rgba(255, 215, 0, 0.2);
            border-radius: 20px;
            font-size: 0.9em;
            color: #ffd700;
            font-weight: bold;
        }

        .event-timer {
            font-size: 1.3em;
            font-weight: bold;
            color: #ff6b6b;
        }

        .event-timer.closing-soon {
            animation: pulse 1s infinite;
            color: #ff3333;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .event-description {
            font-size: 1.1em;
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .event-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .event-pot {
            font-size: 1.2em;
            color: #4caf50;
            font-weight: bold;
        }

        .event-bettors {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .bettor-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .odds-display {
            display: flex;
            gap: 15px;
            font-size: 0.95em;
        }

        .odds-item {
            color: #888;
        }

        .odds-value {
            color: #ffd700;
            font-weight: bold;
        }

        /* Betting Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

		.betting-modal {
			background: linear-gradient(135deg, rgba(26, 26, 46, 0.98), rgba(22, 33, 62, 0.98));
			border-radius: 15px;
			border: 3px solid rgba(255, 215, 0, 0.3);
			padding: 15px;
			max-width: 700px;
			width: 90%;
			max-height: 90vh;
			overflow-y: auto;
			box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
		}

		.modal-title {
			font-size: 1.4em;
			color: #ffd700;
			font-weight: bold;
		}

		.modal-close {
			background: rgba(244, 67, 54, 0.3);
			border: 2px solid #f44336;
			color: #fff;
			width: 35px;
			height: 35px;
			border-radius: 50%;
			cursor: pointer;
			font-size: 1.3em;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.3s;
		}

		.betting-options {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 12px;
			margin-bottom: 12px;
		}

		.bet-option-btn {
			background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(76, 175, 80, 0.05));
			border: 3px solid #4caf50;
			padding: 15px;
			border-radius: 12px;
			cursor: pointer;
			transition: all 0.3s;
			text-align: center;
		}

		.bet-option-btn:hover {
			transform: translateY(-3px);
			box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
			border-color: #66ff66;
		}

		.bet-option-btn.selected {
			background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 215, 0, 0.1));
			border-color: #ffd700;
			box-shadow: 0 5px 20px rgba(255, 215, 0, 0.5);
		}

		.option-label {
			font-size: 1.1em;
			font-weight: bold;
			margin-bottom: 6px;
			color: #fff;
		}

		.option-odds {
			font-size: 1.6em;
			color: #ffd700;
			font-weight: bold;
			margin: 6px 0;
		}

		.option-potential {
			font-size: 0.85em;
			color: #4caf50;
		}

		.amount-slider {
			width: 100%;
			height: 8px;
			background: rgba(255, 255, 255, 0.1);
			border-radius: 5px;
			outline: none;
		}

		.amount-slider::-webkit-slider-thumb {
			-webkit-appearance: none;
			width: 24px;
			height: 24px;
			background: #ffd700;
			cursor: pointer;
			border-radius: 50%;
			box-shadow: 0 0 12px rgba(255, 215, 0, 0.6);
		}

		.amount-slider::-moz-range-thumb {
			width: 24px;
			height: 24px;
			background: #ffd700;
			cursor: pointer;
			border-radius: 50%;
			box-shadow: 0 0 12px rgba(255, 215, 0, 0.6);
			border: none;
		}

		.quick-amount-btn {
			padding: 8px;
			background: rgba(255, 255, 255, 0.1);
			border: 2px solid rgba(255, 255, 255, 0.3);
			border-radius: 6px;
			color: #fff;
			cursor: pointer;
			transition: all 0.3s;
			font-weight: bold;
			font-size: 0.85em;
		}

		.quick-amount-btn:hover {
			background: rgba(255, 215, 0, 0.2);
			border-color: #ffd700;
		}

		.confirm-bet-btn {
			width: 100%;
			padding: 12px;
			background: linear-gradient(45deg, #4caf50, #66bb6a);
			border: none;
			border-radius: 8px;
			color: white;
			font-size: 1.1em;
			font-weight: bold;
			cursor: pointer;
			transition: all 0.3s;
			text-transform: uppercase;
		}

		.confirm-bet-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 20px rgba(76, 175, 80, 0.5);
		}

		.confirm-bet-btn:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}

        /* Activity Feed */
		.activity-feed {
			position: fixed;
			top: 150px;
			right: -300px;
			width: 300px;
			height: calc(100vh - 150px);
			background: rgba(20, 20, 40, 0.98);
			border-radius: 15px 0 0 15px;
			border: 2px solid rgba(255, 215, 0, 0.3);
			border-right: none;
			padding: 15px;
			overflow-y: auto;
			z-index: 500;
			box-shadow: -4px 0 20px rgba(0, 0, 0, 0.5);
			transition: right 0.3s ease;
		}

		.activity-feed.visible {
			right: 0;
		}

		.activity-feed::before {
			content: 'üìú';
			position: absolute;
			left: -40px;
			top: 50%;
			transform: translateY(-50%);
			width: 40px;
			height: 60px;
			background: rgba(20, 20, 40, 0.98);
			border: 2px solid rgba(255, 215, 0, 0.3);
			border-right: none;
			border-radius: 10px 0 0 10px;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.5em;
			cursor: pointer;
		}

        .activity-header {
            font-size: 1.1em;
            color: #ffd700;
            margin-bottom: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .activity-item {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            font-size: 0.9em;
            border-left: 3px solid;
            animation: slideIn 0.3s ease-out;
        }

		@keyframes flashPulse {
			0%, 100% { 
				box-shadow: 0 0 20px rgba(255, 0, 0, 0.8), 0 0 40px rgba(255, 0, 0, 0.4);
				border-color: #ff0000;
			}
			50% { 
				box-shadow: 0 0 40px rgba(255, 0, 0, 1), 0 0 60px rgba(255, 0, 0, 0.6);
				border-color: #ff6666;
			}
		}

		.event-row.flash-bet {
			animation: flashPulse 2s infinite; /* Changed from 1s to 2s - slower */
			background: linear-gradient(135deg, rgba(255, 0, 0, 0.15), rgba(255, 100, 0, 0.1));
			border-left: 6px solid #ff0000;
		}

		.event-row.flash-bet.player-bet {
			animation: playerFlashPulse 2s infinite;
			background: linear-gradient(135deg, rgba(0, 255, 100, 0.35), rgba(76, 175, 80, 0.25)) !important;
			border-left: 6px solid #00ff66 !important;
			border-right: 6px solid #00ff66 !important;
			border-top: 3px solid #00ff66 !important;
			border-bottom: 3px solid #00ff66 !important;
			box-shadow: 0 0 35px rgba(0, 255, 102, 0.7), inset 0 0 40px rgba(0, 255, 102, 0.2) !important;
		}

		@keyframes playerFlashPulse {
			0%, 100% { 
				box-shadow: 0 0 20px rgba(0, 170, 255, 0.8), 0 0 40px rgba(0, 170, 255, 0.4);
				border-color: #00aaff;
			}
			50% { 
				box-shadow: 0 0 40px rgba(0, 170, 255, 1), 0 0 60px rgba(0, 170, 255, 0.6);
				border-color: #66ccff;
			}
		}

		.flash-badge {
			position: absolute;
			top: -10px;
			right: 20px;
			background: linear-gradient(45deg, #ff0000, #ff6666);
			color: white;
			padding: 8px 20px;
			border-radius: 20px;
			font-weight: bold;
			font-size: 0.9em;
			box-shadow: 0 4px 15px rgba(255, 0, 0, 0.5);
			animation: flashPulse 1s infinite;
			z-index: 10;
		}

		.event-row {
			position: relative;
		}

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .activity-win {
            background: rgba(76, 175, 80, 0.15);
            border-color: #4caf50;
        }

        .activity-loss {
            background: rgba(244, 67, 54, 0.15);
            border-color: #f44336;
        }

        .activity-event {
            background: rgba(255, 215, 0, 0.15);
            border-color: #ffd700;
        }

        .activity-info {
            background: rgba(33, 150, 243, 0.15);
            border-color: #2196f3;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 215, 0, 0.3);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 215, 0, 0.5);
        }

        /* Upgrades Tab */
        .upgrades-panel {
            display: none;
        }

        .upgrades-panel.active {
            display: block;
        }

        .upgrades-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            padding: 20px 0;
        }

        .upgrade-card {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upgrade-card:hover:not(.locked) {
            border-color: #ffd700;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.2);
        }

        .upgrade-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .upgrade-icon {
            font-size: 3.5em;
            margin-bottom: 15px;
        }

        .upgrade-name {
            font-size: 1.3em;
            color: #ffd700;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .upgrade-cost {
            font-size: 1.2em;
            color: #4caf50;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .upgrade-desc {
            color: #aaa;
            font-size: 0.95em;
            line-height: 1.4;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.2);
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            font-weight: bold;
            text-transform: uppercase;
        }

        .tab.active {
            color: #ffd700;
            border-bottom-color: #ffd700;
        }

        .tab:hover {
            color: #fff;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="game-header">
        <div class="title-section">
            <div class="game-title">‚ö° MARKET PROPHETS</div>
            <div class="player-stats">
                <div class="stat-item">
                    <div class="stat-value" id="playerWins">0</div>
                    <div class="stat-label">Wins</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="playerLosses">0</div>
                    <div class="stat-label">Losses</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="playerWinRate">0%</div>
                    <div class="stat-label">Win Rate</div>
                </div>
            </div>
        </div>
        <div class="wealth-display">
            <div class="wealth-label">Your Wealth</div>
            <div class="wealth-amount" id="playerWealth">$10,000</div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="game-container">
        <!-- Left Sidebar -->
        <div class="competitors-panel">
            <div class="panel-header">üè¢ Trading Corps</div>
            <div id="competitorsList"></div>
        </div>

        <!-- Main Center Panel -->
        <div class="events-panel">
            <div class="events-controls">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('events')">üìä Events</button>
                    <button class="tab" onclick="switchTab('upgrades')">üõí Upgrades</button>
                </div>
                <div class="speed-controls">
                    <button class="speed-btn active" onclick="setSpeed(1)">1x</button>
                    <button class="speed-btn" onclick="setSpeed(2)">2x</button>
                    <button class="speed-btn" onclick="setSpeed(5)">5x</button>
                </div>
				<div class="control-buttons">
					<button class="btn btn-secondary" onclick="toggleActivity()" id="activityBtn">üìú Activity</button>
					<button class="btn btn-primary" onclick="togglePause()" id="pauseBtn">‚è∏Ô∏è Pause</button>
					<button class="btn btn-secondary" onclick="saveGame()">üíæ Save</button>
					<button class="btn btn-danger" onclick="resetGame()">üîÑ Reset</button>
				</div>
            </div>

            <!-- Events List -->
            <div id="eventsContainer" class="events-list"></div>

            <!-- Upgrades Panel -->
            <div id="upgradesContainer" class="upgrades-panel">
                <div class="upgrades-grid" id="upgradesGrid"></div>
            </div>
        </div>
    </div>

    <!-- Betting Modal -->
	<div class="modal-overlay" id="bettingModal">
		<div class="betting-modal">
			<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
				<div class="modal-title" id="modalEventType"></div>
				<button class="modal-close" onclick="closeBettingModal()">√ó</button>
			</div>
			<div style="background: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 8px; margin-bottom: 12px; font-size: 1em; line-height: 1.4;" id="modalEventDesc"></div>
			<div class="betting-options" id="modalBettingOptions"></div>
			<div style="background: rgba(0, 0, 0, 0.3); padding: 12px; border-radius: 10px; margin-bottom: 12px;">
				<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
					<span style="font-size: 1em; color: #ffd700; font-weight: bold;">Bet Amount</span>
					<span style="font-size: 1.5em; color: #fff; font-weight: bold;" id="currentBetAmount">$100</span>
				</div>
				<input type="range" class="amount-slider" id="betAmountSlider" min="10" max="1000" value="100" oninput="updateBetAmount()" style="margin: 12px 0;">
				<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
					<button class="quick-amount-btn" onclick="setQuickAmount(100)">$100</button>
					<button class="quick-amount-btn" onclick="setQuickAmount(500)">$500</button>
					<button class="quick-amount-btn" onclick="setQuickAmount(1000)">$1K</button>
					<button class="quick-amount-btn" onclick="setQuickAmount(5000)">$5K</button>
					<button class="quick-amount-btn" onclick="setQuickAmount('max')">MAX</button>
				</div>
			</div>
			<div style="background: rgba(255, 215, 0, 0.1); padding: 10px; border-radius: 8px; border: 2px solid rgba(255, 215, 0, 0.3); margin-bottom: 12px;">
				<div style="display: flex; justify-content: space-between; margin: 4px 0; font-size: 1em;">
					<span style="color: #888;">Choice:</span>
					<span style="color: #fff; font-weight: bold;" id="summaryChoice">-</span>
				</div>
				<div style="display: flex; justify-content: space-between; margin: 4px 0; font-size: 1em;">
					<span style="color: #888;">Odds:</span>
					<span style="color: #fff; font-weight: bold;" id="summaryOdds">-</span>
				</div>
				<div style="display: flex; justify-content: space-between; margin: 4px 0; font-size: 1em;">
					<span style="color: #888;">Bet Amount:</span>
					<span style="color: #fff; font-weight: bold;" id="summaryAmount">$0</span>
				</div>
				<div style="display: flex; justify-content: space-between; margin: 4px 0; font-size: 1.1em;">
					<span style="color: #888;">Potential Win:</span>
					<span style="color: #4caf50; font-weight: bold; font-size: 1.2em;" id="summaryPotential">$0</span>
				</div>
			</div>
			<button class="confirm-bet-btn" onclick="confirmBet()" style="padding: 12px; font-size: 1.1em;">PLACE BET</button>
		</div>
	</div>

    <!-- Activity Feed -->
    <div class="activity-feed">
        <div class="activity-header">üìú Recent Activity</div>
        <div id="activityFeed"></div>
    </div>

    <script>
        // Game Configuration
        const POLLINATIONS_API = 'https://text.pollinations.ai';
        
        // Game State
        const game = {
            player: {
                name: 'YOU',
                emoji: 'üë§',
                wealth: 10000,
                wins: 0,
                losses: 0,
                totalBets: 0,
                passiveIncome: 20,
                activeBets: []
            },
            competitors: [],
            events: [],
            activities: [],
            isPaused: false,
            gameSpeed: 1,
            selectedEvent: null,
            selectedOutcome: null,
            upgrades: {
                passiveIncome: 0,
                maxEvents: 5,
                betBonus: 0,
                eventSpeed: 0
            }
        };

        // Competitor Templates
        const COMPETITOR_TEMPLATES = [
            { name: 'Quantum Capital', emoji: '‚öõÔ∏è', color: '#00ffff', strategy: 'aggressive'},
            { name: 'Silicon Syndicate', emoji: 'üîÆ', color: '#9c27b0', strategy: 'analytical' },
            { name: 'Fortune Dynamics', emoji: 'üíé', color: '#4caf50', strategy: 'conservative' },
            { name: 'Chaos Trading Co', emoji: 'üé≤', color: '#ff5722', strategy: 'chaotic' }
        ];

        // Event Categories
        const EVENT_CATEGORIES = [
            {
                type: 'Tech Stock',
                icon: 'üíª',
                templates: [
                    'Will ${company} stock rise above $${price} by end of quarter? Current: $${current}',
                    '${company} announces new ${product}. Will stock jump ${percent}% this week?',
                    'AI startup ${company} IPO prediction: Success or flop? Valued at $${value}M'
                ]
            },
            {
                type: 'Sports',
                icon: '‚öΩ',
                templates: [
                    '${team1} vs ${team2} in ${sport}. ${team1} currently ${record1}, ${team2} at ${record2}',
                    'Underdog ${team1} faces champion ${team2}. Will there be an upset?',
                    '${player} attempting career record in ${sport}. Current streak: ${streak} games'
                ]
            },
            {
                type: 'Crypto',
                icon: '‚Çø',
                templates: [
                    'Will ${crypto} break $${price} resistance level? Currently at $${current}',
                    '${crypto} halving event approaching. Price prediction: up or down?',
                    'New DeFi protocol ${protocol} launches. Will it moon or rug pull?'
                ]
            },
            {
                type: 'Politics',
                icon: 'üó≥Ô∏è',
                templates: [
                    'Poll: Will ${candidate} support increase for ${policy}? Current: ${percent}%',
                    'Prediction: ${leader} announces ${decision}. Sources say ${hint}',
                    'Will ${bill} pass in ${body}? Vote count: ${for} for, ${against} against'
                ]
            },
            {
                type: 'Weather',
                icon: 'üå§Ô∏è',
                templates: [
                    'Will ${city} see ${event} this week? Forecast confidence: ${confidence}%',
                    'Temperature in ${city}: Above or below ${temp}¬∞F? Current: ${current}¬∞F',
                    'Hurricane ${name} tracking toward ${region}. Landfall probability: ${prob}%'
                ]
            },
            {
                type: 'Market',
                icon: 'üìä',
                templates: [
                    'Will ${index} close above ${level} today? Currently at ${current}',
                    'Gold price prediction: Break $${price} barrier? Current: $${current}',
                    'Oil futures: Will prices hit $${price}/barrel this month? Now: $${current}'
                ]
            }
        ];

		const BET_TYPES = {
			standard: {
				name: 'Standard',
				color: '#4caf50',
				duration: [60, 120],
				oddsRange: [150, 300],
				spawnWeight: 40  // Changed from 50
			},
			flash: {
				name: 'Flash',
				color: '#ff0000',
				duration: [25, 40],
				oddsRange: [250, 400],
				spawnWeight: 15
			},
			longterm: {
				name: 'Long-Term',
				color: '#9c27b0',
				duration: [180, 300],
				oddsRange: [120, 180],
				spawnWeight: 30  // Changed from 20 - MORE LONG TERM BETS
			},
			highrisk: {
				name: 'High-Risk',
				color: '#ff9800',
				duration: [45, 90],
				oddsRange: [300, 500],
				spawnWeight: 10
			},
			prop: {
				name: 'Prop Bet',
				color: '#00bcd4',
				duration: [60, 120],
				oddsRange: [200, 350],
				spawnWeight: 15
			}
		};

        // Random data pools
        const companies = ['TechCorp', 'InnovateCo', 'FutureSys', 'QuantumAI', 'NexGen', 'Synergy', 'DataFlow'];
        const cryptos = ['BitCoin', 'EthToken', 'SolChain', 'CardanoX', 'PolkaVerse', 'AvalancheY'];
        const teams = ['Dragons', 'Tigers', 'Eagles', 'Sharks', 'Panthers', 'Wolves', 'Lions', 'Hawks'];
        const sports = ['basketball', 'football', 'baseball', 'soccer', 'hockey'];
        const cities = ['New York', 'Miami', 'Chicago', 'Los Angeles', 'Seattle', 'Austin', 'Boston'];

        function rand(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        function randNum(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function formatMoney(amount) {
            return '$' + Math.floor(amount).toLocaleString();
        }

		function toggleActivity() {
			const feed = document.getElementById('activityFeed').parentElement;
			feed.classList.toggle('visible');
			
			const container = document.querySelector('.game-container');
			container.classList.toggle('activity-open');
			
			const btn = document.getElementById('activityBtn');
			if (feed.classList.contains('visible')) {
				btn.textContent = '‚úñÔ∏è Close';
			} else {
				btn.textContent = 'üìú Activity';
			}
		}

        // Initialize Game
		function initGame() {
			const saved = localStorage.getItem('marketProphets');
			if (saved) {
				const savedData = JSON.parse(saved);
				game.player = savedData.player;
				game.competitors = savedData.competitors;
				game.events = savedData.events;
				game.upgrades = savedData.upgrades || { passiveIncome: 0, maxEvents: 15, betBonus: 0, eventSpeed: 0 };
				game.isPaused = savedData.isPaused || false;
				game.gameSpeed = savedData.gameSpeed || 1;
				game.activities = [];
			} else {
				// Create AI competitors
				COMPETITOR_TEMPLATES.forEach(template => {
					game.competitors.push({
						...template,
						wealth: randNum(8000, 12000),
						wins: 0,
						losses: 0,
						totalBets: 0,
						passiveIncome: 15,
						activeBets: [],
						currentStrategy: null, // Will be set by AI review
						lastAIReview: 0 // Timestamp of last AI call
					});
				});
				
				// Generate initial events
				for (let i = 0; i < 10; i++) {
					generateEvent();
				}
			}

			renderCompetitors();
			renderEvents();
			renderUpgrades();
			updatePlayerDisplay();
			startGameLoop();
		}

		function generateEvent() {
			const category = rand(EVENT_CATEGORIES);
			let template = rand(category.templates);
			
			// Weighted random bet type selection
			const totalWeight = Object.values(BET_TYPES).reduce((sum, type) => sum + type.spawnWeight, 0);
			let random = Math.random() * totalWeight;
			let selectedBetType = 'standard';
			
			for (const [key, type] of Object.entries(BET_TYPES)) {
				random -= type.spawnWeight;
				if (random <= 0) {
					selectedBetType = key;
					break;
				}
			}
			
			const betType = BET_TYPES[selectedBetType];
			console.log(`Generated ${selectedBetType} bet - Duration: ${betType.duration[0]}-${betType.duration[1]}s`);
			
			// Fill template with random data (keep existing replacement logic)
			template = template
				.replace('${company}', rand(companies))
				.replace('${crypto}', rand(cryptos))
				.replace('${team1}', rand(teams))
				.replace('${team2}', rand(teams))
				.replace('${sport}', rand(sports))
				.replace('${city}', rand(cities))
				.replace('${price}', randNum(50, 500))
				.replace('${current}', randNum(40, 480))
				.replace('${percent}', randNum(5, 25))
				.replace('${product}', rand(['AI chip', 'quantum processor', 'neural interface']))
				.replace('${value}', randNum(100, 2000))
				.replace('${record1}', randNum(5, 15) + '-' + randNum(5, 15))
				.replace('${record2}', randNum(5, 15) + '-' + randNum(5, 15))
				.replace('${player}', rand(['Jordan', 'Smith', 'Williams', 'Brown']))
				.replace('${streak}', randNum(5, 20))
				.replace('${protocol}', rand(['DeFiMax', 'YieldFarm', 'SwapChain']))
				.replace('${candidate}', rand(['Senator Adams', 'Rep. Johnson', 'Gov. Martinez']))
				.replace('${policy}', rand(['healthcare', 'climate', 'education']))
				.replace('${percent}', randNum(35, 65))
				.replace('${leader}', rand(['President', 'PM', 'Chancellor']))
				.replace('${decision}', rand(['economic reform', 'trade deal', 'policy change']))
				.replace('${hint}', rand(['likely', 'possible', 'uncertain']))
				.replace('${bill}', rand(['Tax Reform', 'Infrastructure Bill', 'Healthcare Act']))
				.replace('${body}', rand(['Senate', 'Congress', 'Parliament']))
				.replace('${for}', randNum(40, 60))
				.replace('${against}', randNum(30, 50))
				.replace('${event}', rand(['rain', 'snow', 'thunderstorms', 'heatwave']))
				.replace('${confidence}', randNum(50, 90))
				.replace('${temp}', randNum(60, 90))
				.replace('${current}', randNum(55, 85))
				.replace('${name}', rand(['Alpha', 'Beta', 'Gamma', 'Delta']))
				.replace('${region}', rand(cities))
				.replace('${prob}', randNum(30, 80))
				.replace('${index}', rand(['S&P 500', 'NASDAQ', 'DOW']))
				.replace('${level}', randNum(4000, 6000));

			// Generate outcomes based on bet type
			const outcomes = [
				{ label: 'YES', odds: (randNum(betType.oddsRange[0], betType.oddsRange[1]) / 100).toFixed(2), type: 'yes' },
				{ label: 'NO', odds: (randNum(betType.oddsRange[0], betType.oddsRange[1]) / 100).toFixed(2), type: 'no' }
			];

			const setupTime = selectedBetType === 'flash' ? 0 : 15;
			const bettingTime = randNum(betType.duration[0], betType.duration[1]);

			const event = {
				id: Date.now() + Math.random(),
				type: category.type,
				icon: category.icon,
				description: template,
				setupTime: setupTime / game.gameSpeed,
				bettingTime: bettingTime / game.gameSpeed,
				timeRemaining: (setupTime + bettingTime) / game.gameSpeed,
				phase: selectedBetType === 'flash' ? 'betting' : 'setup',
				outcomes: outcomes,
				bets: [],
				pot: 0,
				resolved: false,
				betType: selectedBetType,
				betTypeColor: betType.color,
				betTypeName: betType.name
			};

			game.events.unshift(event);
			
			if (game.events.length > game.upgrades.maxEvents) {
				game.events = game.events.slice(0, game.upgrades.maxEvents);
			}

			addActivity(`${category.icon} New ${betType.name} ${category.type} event!`, 'event');
		}

		function aiConsiderUpgrades() {
			game.competitors.forEach(comp => {
				// Each competitor checks upgrades every 30 seconds
				if (Math.random() < 0.05) { // 5% chance per loop iteration
					// Aggressive traders buy risky upgrades
					// Conservative traders buy passive income
					// etc.
					
					if (comp.strategy === 'aggressive' && comp.wealth > 12000) {
						comp.wealth -= 12000;
						// They get better odds conceptually
						addActivity(`${comp.emoji} ${comp.name} invested in Better Odds upgrade`, 'info');
					} else if (comp.strategy === 'conservative' && comp.wealth > 5000) {
						comp.wealth -= 5000;
						comp.passiveIncome += 10;
						addActivity(`${comp.emoji} ${comp.name} bought Passive Income upgrade`, 'info');
					}
				}
			});
		}

        // AI Place Bet
		function aiPlaceBet(competitor, event) {
			if (event.resolved || competitor.activeBets.some(b => b.eventId === event.id)) return;

			let betPercent;
			
			// Adjust strategy based on bet type
			switch(competitor.strategy) {
				case 'aggressive':
					betPercent = event.betType === 'highrisk' ? randNum(20, 35) : 
								event.betType === 'longterm' ? randNum(8, 15) :
								randNum(15, 25);
					break;
				case 'conservative':
					betPercent = event.betType === 'longterm' ? randNum(10, 18) :
								event.betType === 'highrisk' ? randNum(2, 5) :
								randNum(5, 12);
					break;
				case 'analytical':
					betPercent = event.betType === 'prop' ? randNum(12, 20) :
								randNum(10, 18);
					break;
				case 'chaotic':
					betPercent = randNum(5, 35); // Doesn't care about bet type
					break;
				default:
					betPercent = 10;
			}

			// Apply current AI strategy adjustment if they have one
			if (competitor.currentStrategy) {
				if (competitor.currentStrategy.includes('aggressive')) betPercent *= 1.3;
				if (competitor.currentStrategy.includes('conservative')) betPercent *= 0.7;
			}

			const betAmount = Math.floor((competitor.wealth * betPercent) / 100);
			if (betAmount <= 0 || betAmount > competitor.wealth) return;

			// Pick outcome based on strategy
			let outcome;
			if (competitor.strategy === 'analytical') {
				outcome = event.outcomes[0].odds > event.outcomes[1].odds ? event.outcomes[0] : event.outcomes[1];
			} else {
				outcome = rand(event.outcomes);
			}

			competitor.wealth -= betAmount;
			competitor.totalBets++;
			
			const bet = {
				eventId: event.id,
				amount: betAmount,
				outcome: outcome,
				competitor: competitor
			};
			
			competitor.activeBets.push(bet);
			event.bets.push({
				competitorName: competitor.name,
				emoji: competitor.emoji,
				color: competitor.color,
				amount: betAmount,
				outcome: outcome
			});
			event.pot += betAmount;

			renderEvents();
			renderCompetitors();
		}

		async function aiStrategyReview(competitor) {
			const now = Date.now();
			
			// Only review every 120 seconds
			if (now - competitor.lastAIReview < 120000) return;
			
			competitor.lastAIReview = now;
			
			const winRate = competitor.totalBets > 0 ? (competitor.wins / competitor.totalBets * 100).toFixed(0) : 0;
			
			try {
				const prompt = `I'm a ${competitor.strategy} trader. Stats: ${competitor.wins}W-${competitor.losses}L (${winRate}% win rate), wealth: ${formatMoney(competitor.wealth)}. Should I adjust my strategy? Reply with one word: AGGRESSIVE, CONSERVATIVE, or MAINTAIN`;
				
				const url = `${POLLINATIONS_API}/${encodeURIComponent(prompt)}?model=openai`;
				const response = await fetch(url);
				const text = await response.text();
				
				if (text.includes('AGGRESSIVE')) {
					competitor.currentStrategy = 'more aggressive';
					addActivity(`${competitor.emoji} ${competitor.name} switching to aggressive mode`, 'info');
				} else if (text.includes('CONSERVATIVE')) {
					competitor.currentStrategy = 'more conservative';
					addActivity(`${competitor.emoji} ${competitor.name} playing it safe now`, 'info');
				} else {
					competitor.currentStrategy = null;
				}
			} catch (error) {
				console.log('AI review failed, continuing with base strategy');
			}
		}

        // Render Competitors
        function renderCompetitors() {
            const allTraders = [game.player, ...game.competitors].sort((a, b) => b.wealth - a.wealth);
            
            const html = allTraders.map((trader, index) => {
                const winRate = trader.totalBets > 0 ? Math.round((trader.wins / trader.totalBets) * 100) : 0;
                const rankBadge = index < 3 ? `<span class="rank-badge rank-${index + 1}">#${index + 1}</span>` : '';
                const isPlayer = trader === game.player;
                
                return `
                    <div class="competitor-card ${isPlayer ? 'player' : ''}" style="border-color: ${trader.color || '#ffd700'}">
                        <div class="competitor-header">
                            <div class="competitor-name">
                                <span style="font-size: 1.5em;">${trader.emoji}</span>
                                ${trader.name}
                                ${rankBadge}
                            </div>
                        </div>
                        <div class="competitor-wealth">${formatMoney(trader.wealth)}</div>
                        <div class="competitor-stats">
                            <span>W: ${trader.wins}</span>
                            <span>L: ${trader.losses}</span>
                            <span>${winRate}%</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('competitorsList').innerHTML = html;
        }

        // Render Events
		function renderEvents() {
			const activeEvents = game.events.filter(e => !e.resolved);
			
			const html = activeEvents.map(event => {
				const timeLeft = Math.ceil(event.timeRemaining);
				const isClosingSoon = timeLeft <= 15;
				const playerHasBet = event.bets.some(b => b.competitorName === game.player.name);
				
				const bettorDots = event.bets.slice(0, 8).map(bet => 
					`<div class="bettor-dot" style="background: ${bet.color}; border-color: ${bet.color};" title="${bet.competitorName}">${bet.emoji}</div>`
				).join('');
				
				// Different styling based on bet type
				let rowClass = playerHasBet ? 'player-bet' : '';
				if (event.betType === 'flash' && !playerHasBet) {
					rowClass += ' flash-bet';
				}
				
				return `
					<div class="event-row ${rowClass}" 
						 style="border-left-color: ${event.betTypeColor}; ${event.betType === 'longterm' ? 'background: linear-gradient(135deg, rgba(156, 39, 176, 0.1), rgba(156, 39, 176, 0.05));' : ''}"
						 onclick="openBettingModal('${event.id}')">
						${event.betType === 'flash' && !playerHasBet ? '<div class="flash-badge">üî• FLASH BET üî•</div>' : ''}
						<div style="display: flex; align-items: center; justify-content: space-between; gap: 15px;">
							<span class="event-type-badge" style="background: ${event.betTypeColor}33; border: 1px solid ${event.betTypeColor};">${event.icon} ${event.type}</span>
							<div class="event-description" style="flex: 1; margin: 0; font-size: 0.95em;">${event.description}</div>
							<div style="display: flex; gap: 15px; align-items: center; white-space: nowrap;">
								<span style="color: ${event.betTypeColor}; font-size: 0.8em; font-weight: bold; text-transform: uppercase;">${event.betTypeName}</span>
								<span style="color: #4caf50; font-size: 0.9em;">YES: <span style="color: #ffd700; font-weight: bold;">${event.outcomes[0].odds}x</span></span>
								<span style="color: #f44336; font-size: 0.9em;">NO: <span style="color: #ffd700; font-weight: bold;">${event.outcomes[1].odds}x</span></span>
								<span style="color: #4caf50; font-weight: bold; font-size: 0.9em;">${formatMoney(event.pot)}</span>
								<div style="display: flex; gap: 3px;">
									${bettorDots}
									${event.bets.length > 8 ? `<span style="color: #888; font-size: 0.8em;">+${event.bets.length - 8}</span>` : ''}
								</div>
								<span class="event-timer ${isClosingSoon ? 'closing-soon' : ''}" style="min-width: 50px; text-align: right;">
									${event.phase === 'setup' ? `‚è≥ ${Math.ceil(event.setupTime)}s` : `${timeLeft}s`}
								</span>
							</div>
						</div>
					</div>
				`;
			}).join('');
			
			document.getElementById('eventsContainer').innerHTML = html || '<div style="text-align: center; padding: 50px; color: #888;">No active events. New ones spawning soon...</div>';
		}

        // Open Betting Modal
		function openBettingModal(eventId) {
			const event = game.events.find(e => e.id.toString() === eventId.toString());
			if (!event || event.resolved) return;
            
            // Check if player already bet
            if (event.bets.some(b => b.competitorName === game.player.name)) {
                addActivity('You already bet on this event!', 'info');
                return;
            }
            
            if (event.timeRemaining < 5) {
                addActivity('Betting closed - event ending soon!', 'info');
                return;
            }

            game.selectedEvent = event;
            game.selectedOutcome = null;
            
            document.getElementById('modalEventType').textContent = `${event.icon} ${event.type}`;
            document.getElementById('modalEventDesc').textContent = event.description;
            
            const optionsHtml = event.outcomes.map((outcome, index) => `
                <div class="bet-option-btn" onclick="selectOutcome(${index})">
                    <div class="option-label">${outcome.label}</div>
                    <div class="option-odds">${outcome.odds}x</div>
                    <div class="option-potential">Win ${formatMoney(100 * parseFloat(outcome.odds))} per $100</div>
                </div>
            `).join('');
            
            document.getElementById('modalBettingOptions').innerHTML = optionsHtml;
            
            const maxBet = Math.min(game.player.wealth, 10000);
            document.getElementById('betAmountSlider').max = maxBet;
            document.getElementById('betAmountSlider').value = Math.min(100, maxBet);
            updateBetAmount();
            
            document.getElementById('bettingModal').classList.add('active');
        }

        function closeBettingModal() {
            document.getElementById('bettingModal').classList.remove('active');
            game.selectedEvent = null;
            game.selectedOutcome = null;
        }

        function selectOutcome(index) {
            if (!game.selectedEvent) return;
            game.selectedOutcome = game.selectedEvent.outcomes[index];
            
            document.querySelectorAll('.bet-option-btn').forEach((btn, i) => {
                if (i === index) {
                    btn.classList.add('selected');
                } else {
                    btn.classList.remove('selected');
                }
            });
            
            updateBetAmount();
        }

        function updateBetAmount() {
            const slider = document.getElementById('betAmountSlider');
            const amount = parseInt(slider.value);
            
            document.getElementById('currentBetAmount').textContent = formatMoney(amount);
            document.getElementById('summaryAmount').textContent = formatMoney(amount);
            
            if (game.selectedOutcome) {
                const potential = Math.floor(amount * parseFloat(game.selectedOutcome.odds));
                document.getElementById('summaryChoice').textContent = game.selectedOutcome.label;
                document.getElementById('summaryOdds').textContent = game.selectedOutcome.odds + 'x';
                document.getElementById('summaryPotential').textContent = formatMoney(potential);
            } else {
                document.getElementById('summaryChoice').textContent = '-';
                document.getElementById('summaryOdds').textContent = '-';
                document.getElementById('summaryPotential').textContent = '$0';
            }
        }

        function setQuickAmount(value) {
            const slider = document.getElementById('betAmountSlider');
            if (value === 'max') {
                slider.value = slider.max;
            } else {
                slider.value = Math.min(value, parseInt(slider.max));
            }
            updateBetAmount();
        }

        function confirmBet() {
            if (!game.selectedEvent || !game.selectedOutcome) {
                addActivity('Please select an outcome!', 'info');
                return;
            }
            
            const amount = parseInt(document.getElementById('betAmountSlider').value);
            if (amount > game.player.wealth) {
                addActivity('Not enough wealth!', 'loss');
                return;
            }
            
            // Place bet
            game.player.wealth -= amount;
            game.player.totalBets++;
            
            const bet = {
                eventId: game.selectedEvent.id,
                amount: amount,
                outcome: game.selectedOutcome,
                competitor: game.player
            };
            
            game.player.activeBets.push(bet);
            game.selectedEvent.bets.push({
                competitorName: game.player.name,
                emoji: game.player.emoji,
                color: '#ffd700',
                amount: amount,
                outcome: game.selectedOutcome
            });
            game.selectedEvent.pot += amount;
            
            addActivity(`You bet ${formatMoney(amount)} on ${game.selectedOutcome.label}!`, 'win');
            
            closeBettingModal();
            renderEvents();
            renderCompetitors();
            updatePlayerDisplay();
        }

        // Resolve Event
        function resolveEvent(event) {
            if (event.resolved) return;
            event.resolved = true;
            
            // Determine winner (50/50 for now)
            const winningOutcome = rand(event.outcomes);
            
            addActivity(`${event.icon} ${event.type} resolved: ${winningOutcome.label} wins!`, 'event');
            
            // Payout winners
            event.bets.forEach(bet => {
                const trader = bet.competitorName === game.player.name ? game.player : 
                              game.competitors.find(c => c.name === bet.competitorName);
                
                if (!trader) return;
                
                if (bet.outcome.label === winningOutcome.label) {
                    const winnings = Math.floor(bet.amount * parseFloat(bet.outcome.odds));
                    trader.wealth += winnings;
                    trader.wins++;
                    
                    const profit = winnings - bet.amount;
                    addActivity(`${trader.emoji} ${trader.name} WON ${formatMoney(winnings)} (+${formatMoney(profit)})!`, 'win');
                } else {
                    trader.losses++;
                    addActivity(`${trader.emoji} ${trader.name} lost ${formatMoney(bet.amount)}`, 'loss');
                }
                
                // Remove from active bets
                trader.activeBets = trader.activeBets.filter(b => b.eventId !== event.id);
            });
            
            renderCompetitors();
            renderEvents();
            updatePlayerDisplay();
            
            // Remove event after delay
            setTimeout(() => {
                game.events = game.events.filter(e => e.id !== event.id);
                renderEvents();
            }, 3000 / game.gameSpeed);
        }

        // Render Upgrades
        function renderUpgrades() {
            const upgrades = [
                {
                    icon: 'üí∞',
                    name: 'Passive Income',
                    cost: 5000,
                    desc: '+10 wealth per second',
                    unlock: () => {
                        game.player.passiveIncome += 10;
                        game.upgrades.passiveIncome++;
                        addActivity('Passive income increased!', 'win');
                    }
                },
                {
                    icon: 'üìä',
                    name: 'More Events',
                    cost: 8000,
                    desc: '+2 active event slots',
                    unlock: () => {
                        game.upgrades.maxEvents += 2;
                        addActivity('Event capacity increased!', 'win');
                    }
                },
                {
                    icon: 'üéØ',
                    name: 'Better Odds',
                    cost: 12000,
                    desc: '+5% winnings on all bets',
                    unlock: () => {
                        game.upgrades.betBonus += 5;
                        addActivity('Bet bonus increased!', 'win');
                    }
                },
                {
                    icon: '‚ö°',
                    name: 'Fast Events',
                    cost: 15000,
                    desc: 'Events spawn 25% faster',
                    unlock: () => {
                        game.upgrades.eventSpeed += 25;
                        addActivity('Event speed increased!', 'win');
                    }
                }
            ];

            const html = upgrades.map(up => {
                const canAfford = game.player.wealth >= up.cost;
                return `
                    <div class="upgrade-card ${!canAfford ? 'locked' : ''}" onclick='${canAfford ? `buyUpgrade(${upgrades.indexOf(up)})` : ''}'>
                        <div class="upgrade-icon">${up.icon}</div>
                        <div class="upgrade-name">${up.name}</div>
                        <div class="upgrade-cost">${formatMoney(up.cost)}</div>
                        <div class="upgrade-desc">${up.desc}</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('upgradesGrid').innerHTML = html;
            window.upgradesList = upgrades;
        }

        function buyUpgrade(index) {
            const upgrade = window.upgradesList[index];
            if (game.player.wealth >= upgrade.cost) {
                game.player.wealth -= upgrade.cost;
                upgrade.unlock();
                renderUpgrades();
                updatePlayerDisplay();
            }
        }

        // Activity Feed
		function addActivity(message, type) {
			game.activities.unshift({ message, type, time: Date.now() });
			if (game.activities.length > 50) game.activities.pop();
			
			const feedContainer = document.getElementById('activityFeed');
			
			// Create new item element
			const newItem = document.createElement('div');
			newItem.className = `activity-item activity-${type}`;
			newItem.textContent = message;
			newItem.style.animation = 'slideIn 0.3s ease-out';
			
			// Insert at top
			feedContainer.insertBefore(newItem, feedContainer.firstChild);
			
			// Remove old items if more than 10 visible
			while (feedContainer.children.length > 10) {
				feedContainer.removeChild(feedContainer.lastChild);
			}
		}

		async function aiAnalyzeEvent(competitor, event) {
			if (event.resolved || competitor.activeBets.some(b => b.eventId === event.id)) return;
			
			const strategyPrompts = {
				aggressive: 'You are a high-risk trader who loves big bets. Analyze quickly and go big.',
				conservative: 'You are risk-averse and prefer safe, small bets. Be cautious.',
				analytical: 'You analyze data carefully and bet on probability. Be logical.',
				chaotic: 'You are unpredictable and make wild bets. Sometimes brilliant, sometimes reckless.'
			};
			
			try {
				const prompt = `Event: ${event.description}\nOdds: YES ${event.outcomes[0].odds}x, NO ${event.outcomes[1].odds}x\n\nShould I bet? Reply EXACTLY: BET:YES or BET:NO|AMOUNT:10-40 (percentage)|REASON:brief explanation`;
				
				const url = `${POLLINATIONS_API}/${encodeURIComponent(prompt)}?model=openai&system=${encodeURIComponent(strategyPrompts[competitor.strategy])}`;
				
				const response = await fetch(url);
				const text = await response.text();
				
				const betMatch = text.match(/BET:(YES|NO)/i);
				const amountMatch = text.match(/AMOUNT:(\d+)/i);
				const reasonMatch = text.match(/REASON:(.+?)(?:\||$)/i);
				
				if (betMatch && amountMatch) {
					const choice = betMatch[1].toUpperCase();
					const betPercent = Math.min(50, Math.max(5, parseInt(amountMatch[1])));
					const betAmount = Math.floor((competitor.wealth * betPercent) / 100);
					
					if (betAmount > 0 && betAmount <= competitor.wealth) {
						const outcome = event.outcomes.find(o => o.label === choice) || rand(event.outcomes);
						
						competitor.wealth -= betAmount;
						competitor.totalBets++;
						
						const bet = {
							eventId: event.id,
							amount: betAmount,
							outcome: outcome,
							competitor: competitor
						};
						
						competitor.activeBets.push(bet);
						event.bets.push({
							competitorName: competitor.name,
							emoji: competitor.emoji,
							color: competitor.color,
							amount: betAmount,
							outcome: outcome
						});
						event.pot += betAmount;
						
						const reason = reasonMatch ? reasonMatch[1].trim().substring(0, 60) : 'Going with my analysis';
						addActivity(`${competitor.emoji} ${competitor.name}: "${reason}"`, 'info');
						renderEvents();
						renderCompetitors();
					}
				}
			} catch (error) {
				console.log('AI API failed, using fallback');
				aiPlaceBet(competitor, event);
			}
		}

        // Update Player Display
        function updatePlayerDisplay() {
            document.getElementById('playerWealth').textContent = formatMoney(game.player.wealth);
            document.getElementById('playerWins').textContent = game.player.wins;
            document.getElementById('playerLosses').textContent = game.player.losses;
            const winRate = game.player.totalBets > 0 ? Math.round((game.player.wins / game.player.totalBets) * 100) : 0;
            document.getElementById('playerWinRate').textContent = winRate + '%';
        }

		function startGameLoop() {
			let lastFullRender = 0;
			
			// Main game loop - runs every 100ms
			setInterval(() => {
				if (game.isPaused) return;
				
				const now = Date.now();
				
				// Update event timers
				game.events.forEach(event => {
					if (!event.resolved) {
						event.timeRemaining -= 0.1;
						
						// Check phase transition
						if (event.phase === 'setup' && event.timeRemaining <= event.bettingTime) {
							event.phase = 'betting';
							addActivity(`‚úÖ ${event.icon} ${event.type} - Betting now open!`, 'event');
							
							// AI starts betting when phase changes
							setTimeout(() => {
								game.competitors.forEach(comp => {
									const betChance = event.isFlashBet ? 0.85 : 0.7;
									if (Math.random() < betChance) {
										aiPlaceBet(comp, event);
									}
								});
							}, randNum(500, 2000) / game.gameSpeed);
						}
						
						if (event.timeRemaining <= 0) {
							resolveEvent(event);
						}
					}
				});
				
				// Passive income
				const allTraders = [game.player, ...game.competitors];
				allTraders.forEach(trader => {
					trader.wealth += (trader.passiveIncome * game.gameSpeed) / 10;
				});
				
				// Only update timer displays, not full re-render
				updateTimersOnly();
				
				// Full re-render only every 500ms
				if (now - lastFullRender > 500) {
					updatePlayerDisplay();
					renderCompetitors();
					lastFullRender = now;
				}
			}, 100);
			
			// Generate new events - runs every 5 seconds (adjusted by upgrade)
			setInterval(() => {
				if (game.isPaused) return;
				if (game.events.filter(e => !e.resolved).length < game.upgrades.maxEvents) {
					generateEvent();
				}
			}, (5000 - (game.upgrades.eventSpeed * 50)) / game.gameSpeed);
			
			// AI strategy review - runs every 30 seconds
			setInterval(() => {
				if (game.isPaused) return;
				game.competitors.forEach(comp => {
					aiStrategyReview(comp);
				});
			}, 30000);
			
			// Auto-save - runs every 30 seconds
			setInterval(() => {
				if (!game.isPaused) saveGame();
			}, 30000);
		}

		function updateTimersOnly() {
			game.events.filter(e => !e.resolved).forEach(event => {
				const timerElement = document.querySelector(`[onclick="openBettingModal('${event.id}')"] .event-timer`);
				if (timerElement) {
					let displayTime;
					if (event.phase === 'setup') {
						displayTime = `‚è≥ ${Math.ceil(event.setupTime)}s`;
					} else {
						displayTime = `${Math.ceil(event.timeRemaining)}s`;
					}
					timerElement.textContent = displayTime;
					
					const timeLeft = Math.ceil(event.timeRemaining);
					if (timeLeft <= 15 && event.phase === 'betting') {
						timerElement.classList.add('closing-soon');
					} else {
						timerElement.classList.remove('closing-soon');
					}
				}
			});
		}

        // Controls
        function togglePause() {
            game.isPaused = !game.isPaused;
            document.getElementById('pauseBtn').textContent = game.isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
            addActivity(game.isPaused ? 'Game paused' : 'Game resumed', 'info');
        }

        function setSpeed(speed) {
            game.gameSpeed = speed;
            document.querySelectorAll('.speed-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            addActivity(`Speed set to ${speed}x`, 'info');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tab === 'events') {
                document.getElementById('eventsContainer').style.display = 'block';
                document.getElementById('upgradesContainer').classList.remove('active');
            } else if (tab === 'upgrades') {
                document.getElementById('eventsContainer').style.display = 'none';
                document.getElementById('upgradesContainer').classList.add('active');
                renderUpgrades();
            }
        }

		function saveGame() {
			// Create a clean copy without circular references
			const saveData = {
				player: {
					...game.player,
					activeBets: game.player.activeBets.map(b => ({
						eventId: b.eventId,
						amount: b.amount,
						outcome: b.outcome
					}))
				},
				competitors: game.competitors.map(c => ({
					...c,
					activeBets: c.activeBets.map(b => ({
						eventId: b.eventId,
						amount: b.amount,
						outcome: b.outcome
					}))
				})),
				events: game.events.map(e => ({
					...e,
					bets: e.bets.map(b => ({
						competitorName: b.competitorName,
						emoji: b.emoji,
						color: b.color,
						amount: b.amount,
						outcome: b.outcome
					}))
				})),
				upgrades: game.upgrades,
				isPaused: game.isPaused,
				gameSpeed: game.gameSpeed
			};
			
			localStorage.setItem('marketProphets', JSON.stringify(saveData));
			addActivity('Game saved!', 'info');
		}

        function resetGame() {
            if (confirm('Reset all progress? This cannot be undone!')) {
                localStorage.removeItem('marketProphets');
                location.reload();
            }
        }

        // Start game
        window.addEventListener('load', initGame);
    </script>
</body>
</html>